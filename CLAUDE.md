# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Claude

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏
- **–í–ê–ñ–ù–û:** –†–µ—à–∞—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ù–£ –∑–∞–¥–∞—á—É –∑–∞ –∑–∞–ø—Ä–æ—Å
- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤, —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏ –∏ —Ä–µ—à–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–ª–µ–¥—É—é—â–µ–π

### –Ø–∑—ã–∫–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –∫–æ–¥–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç–æ–≤

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **–ö–†–ò–¢–ò–ß–ù–û:** –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏ —Ö—Ä–∞–Ω–∏—Ç—å –õ–Æ–ë–£–Æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –≤ `/docs`
- –î–æ–±–∞–≤–ª—è—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö

### Git Workflow (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)

#### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –∑–∞–¥–∞—á–µ–π:
1. –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –≤–µ—Ç–∫—É –ø–æ–¥ –∑–∞–¥–∞—á—É:
   ```bash
   git checkout -b feature/task-name
   # –ù–∞–ø—Ä–∏–º–µ—Ä: feature/week1-buffer-crud
   ```

#### –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
2. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –ø–ª–∞–Ω–æ–º –∑–∞–¥–∞—á–∏ –≤ `/docs/task_plans/`:
   ```bash
   docs/task_plans/YYYYMMDD_task_name.md
   # –ù–∞–ø—Ä–∏–º–µ—Ä: docs/task_plans/20251008_week1_buffer_crud.md
   ```
3. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
   - –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
   - –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–µ—Ç–∞–ª—å–Ω–æ)
   - –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è
   - Acceptance criteria
   - –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:
4. –°–¥–µ–ª–∞—Ç—å commit —Å –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:
   ```bash
   git add .
   git commit -m "feat: –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

   –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

   ü§ñ Generated with Claude Code

   Co-Authored-By: Claude <noreply@anthropic.com>"
   ```

5. Push –≤ remote:
   ```bash
   git push -u origin feature/task-name
   ```

6. –°–æ–∑–¥–∞—Ç—å Pull Request:
   ```bash
   gh pr create --title "feat: –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" --body "$(cat <<'EOF'
   ## Summary
   - –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

   ## Test plan
   - [ ] –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

   ü§ñ Generated with Claude Code
   EOF
   )"
   ```

## –ü—Ä–∏ –∫–∞–∂–¥–æ–º compact —á–∞—Ç–∞:
- –í—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç—å —Å–∞–º–º–∞—Ä–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏ –¥–µ–π—Å—Ç–≤–∏–π
- –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏ –≤ `/claude_history`

## –ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:
- –î–æ–±–∞–≤–ª—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–≤—Ç–æ—Ä–æ–º, –¥–∞—Ç–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º —Ñ–∞–π–ª–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Prettify –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

### –ü—Ä–∞–≤–∏–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Ç–µ—Å—Ç–æ–≤:
- **–ö–†–ò–¢–ò–ß–ù–û:** –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –≤ `/tests/logs/`
- –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –ö–ê–ñ–î–û–ì–û –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ (unit, integration, smoke, POC, UAT)
- –õ–æ–≥–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∏ –∞—É–¥–∏—Ç–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤:
```
tests/
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20251008_OPTERP-3_hlc_tests.log
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20251008_OPTERP-5_buffer_tests.log
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ smoke/
‚îÇ   ‚îú‚îÄ‚îÄ poc/
‚îÇ   ‚îî‚îÄ‚îÄ uat/
```

### –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –ª–æ–≥–∞:
```
tests/logs/{test_type}/YYYYMMDD_{TASK_ID}_{description}.log
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- `tests/logs/unit/20251008_OPTERP-3_hlc_tests.log`
- `tests/logs/unit/20251008_OPTERP-5_buffer_crud_tests.log`
- `tests/logs/smoke/20251008_buffer_smoke_test.log`
- `tests/logs/poc/20251015_POC-4_offline_8h_sync.log`

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤:

**Unit tests:**
```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p tests/logs/unit

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–≥–∞
pytest tests/unit/test_hlc.py -v --tb=short 2>&1 | tee tests/logs/unit/$(date +%Y%m%d)_OPTERP-3_hlc_tests.log

# –° coverage
pytest tests/unit/test_buffer.py -v --cov=kkt_adapter.app.buffer --cov-report=term-missing 2>&1 | tee tests/logs/unit/$(date +%Y%m%d)_OPTERP-5_buffer_tests.log
```

**Integration tests:**
```bash
mkdir -p tests/logs/integration
pytest tests/integration/ -v 2>&1 | tee tests/logs/integration/$(date +%Y%m%d)_integration_tests.log
```

**Smoke tests:**
```bash
mkdir -p tests/logs/smoke
python test_buffer_smoke.py 2>&1 | tee tests/logs/smoke/$(date +%Y%m%d)_buffer_smoke.log
```

### –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ª–æ–≥–∞ –¥–æ–ª–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å:

1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫:**
   - –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞
   - Task ID (JIRA)
   - –¢–∏–ø —Ç–µ—Å—Ç–æ–≤ (unit/integration/smoke/etc)
   - –û–∫—Ä—É–∂–µ–Ω–∏–µ (Python version, OS, dependencies)

2. **–í—ã–≤–æ–¥ pytest/—Ç–µ—Å—Ç–æ–≤:**
   - –ü–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥ —Å `-v` (verbose)
   - Traceback –¥–ª—è failed tests
   - Coverage report (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

3. **–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ (passed/failed/skipped)
   - Coverage percentage
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ª–æ–≥–∞:

```
=== Test Log ===
Date: 2025-10-08 15:30:00
Task: OPTERP-3 (Create HLC Unit Tests)
Type: Unit Tests
File: tests/unit/test_hlc.py
Python: 3.11.7
OS: Windows 11

Command:
pytest tests/unit/test_hlc.py -v --cov=kkt_adapter.app.hlc

Output:
============================= test session starts =============================
platform win32 -- Python 3.11.7, pytest-8.1.1, pluggy-1.4.0
...
[–ø–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥ pytest]
...

Coverage:
Name                     Stmts   Miss  Cover   Missing
------------------------------------------------------
kkt_adapter/app/hlc.py      57      1    98%   175
------------------------------------------------------

Summary:
‚úÖ 26 tests passed
‚úÖ 0 tests failed
‚úÖ Coverage: 98%
‚úÖ Duration: 1.29s

Result: SUCCESS
```

### –ö–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥–∏:

| –°–æ–±—ã—Ç–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|----------|
| **–ó–∞–ø—É—Å–∫ unit tests** | –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥ –≤ `tests/logs/unit/` |
| **–ó–∞–ø—É—Å–∫ integration tests** | –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥ –≤ `tests/logs/integration/` |
| **Smoke test** | –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥ –≤ `tests/logs/smoke/` |
| **POC —Ç–µ—Å—Ç—ã (POC-1 –¥–æ POC-5)** | –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥ –≤ `tests/logs/poc/` |
| **UAT —Ç–µ—Å—Ç—ã** | –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥ –≤ `tests/logs/uat/` |
| **Load tests** | –í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–æ–≥ –≤ `tests/logs/load/` |
| **Failed test** | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Ç—å `{taskid}_FAILED.log` —Å –ø–æ–ª–Ω—ã–º traceback |

### –û–±—Ä–∞–±–æ—Ç–∫–∞ failed tests:

**–ï—Å–ª–∏ —Ç–µ—Å—Ç —É–ø–∞–ª (FAILED):**
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º `_FAILED.log`
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–Ω—ã–π traceback
3. –ó–∞–ø–∏—Å–∞—Ç—å –≤ `claude_history/` –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
4. –ù–ï –¥–µ–ª–∞—Ç—å commit –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**
```bash
# –¢–µ—Å—Ç —É–ø–∞–ª
pytest tests/unit/test_buffer.py -v 2>&1 | tee tests/logs/unit/20251008_OPTERP-5_buffer_tests_FAILED.log

# –ó–∞–ø–∏—Å–∞—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
cat >> claude_history/session_20251008.md << EOF

## Test Failure: OPTERP-5
- Test: test_buffer_capacity_check
- Error: AssertionError: Expected BufferFullError
- File: tests/unit/test_buffer.py:123
- Action: Fix capacity check logic in buffer.py:215
EOF
```

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

**–î–æ–±–∞–≤–∏—Ç—å –≤ Makefile:**
```makefile
# Run unit tests with logging
test-unit:
	@mkdir -p tests/logs/unit
	pytest tests/unit/ -v --cov --cov-report=term-missing 2>&1 | tee tests/logs/unit/$$(date +%Y%m%d)_unit_tests.log

# Run all tests with logging
test-all:
	@mkdir -p tests/logs/{unit,integration,smoke}
	pytest tests/ -v --cov --cov-report=term-missing 2>&1 | tee tests/logs/$$(date +%Y%m%d)_all_tests.log
```

### Git –∏ –ª–æ–≥–∏:

**–î–æ–±–∞–≤–∏—Ç—å –≤ .gitignore:**
```
# Test logs (keep structure, ignore content)
tests/logs/**/*.log
!tests/logs/**/.gitkeep
```

**–°–æ–∑–¥–∞—Ç—å .gitkeep —Ñ–∞–π–ª—ã:**
```bash
mkdir -p tests/logs/{unit,integration,smoke,poc,uat,load}
touch tests/logs/{unit,integration,smoke,poc,uat,load}/.gitkeep
```

### Checklist –ø–µ—Ä–µ–¥ commit:

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (0 FAILED)
- [ ] –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ `tests/logs/{test_type}/`
- [ ] Coverage ‚â•95% (–¥–ª—è unit tests)
- [ ] –ù–µ—Ç FAILED –ª–æ–≥–æ–≤ –≤ `tests/logs/`
- [ ] Session history –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–µ—Å–ª–∏ –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã)

**–í–ê–ñ–ù–û:** –õ–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –û–Ω–∏ –ø–æ–º–æ–≥–∞—é—Ç:
1. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã
2. –û—Ç—Å–ª–µ–¥–∏—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç –∫–∞—á–µ—Å—Ç–≤–∞
4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤

# CLAUDE.md ‚Äî –ü–ª–∞–Ω –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏ OpticsERP (Offline-First POS)

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ï–¥–∏–Ω—ã–π –ø–ª–∞–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –±–∞–∑–µ Odoo Community 17 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π offline-first –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è —Å–µ—Ç–∏ –æ–ø—Ç–∏–∫.
> **–í–µ—Ä—Å–∏—è:** 1.0 ‚Ä¢ –î–∞—Ç–∞: 2025-10-08 ‚Ä¢ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: 1 —á–µ–ª–æ–≤–µ–∫
> **–ë–∞–∑–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:** docs/1-5 (–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏, –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞, Offline-—Ä–µ–∂–∏–º)

---

## ü§ñ AI Agent Quick Start

**IMPORTANT:** Read this section first before writing any code.

### Bootstrap Project (First Time Setup)

```bash
# Clone and navigate to project
cd OpticsERP

# Bootstrap: create structure, install dependencies, init database
make bootstrap

# Verify environment (Python 3.11+, Docker, SQLite, Git)
make verify-env

# Run smoke test (verify bootstrap worked)
make smoke-test
```

**Expected output:**
```
‚úÖ Bootstrap complete!
‚úÖ Environment verification complete
‚úÖ Smoke test passed. Ready to develop.
```

### Essential Resources

**Before coding, familiarize yourself with:**

1. **GLOSSARY.md** ‚Äî Domain terminology (–ö–ö–¢, –û–§–î, –§–ù, Circuit Breaker, etc.)
2. **docs/5. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—É.md** ‚Äî Offline architecture (¬ß5.2-5.6)
3. **docs/PROMPT_ENGINEERING_TEMPLATES.md** ‚Äî Reusable prompts for common tasks
4. **bootstrap/kkt_adapter_skeleton/schema.sql** ‚Äî SQLite buffer schema

### Your First Task

**Task:** Implement SQLite buffer database CRUD operations

**Steps:**
1. Read `bootstrap/kkt_adapter_skeleton/schema.sql` (understand schema)
2. Implement `kkt_adapter/app/buffer.py` with functions:
   - `insert_receipt(receipt_data)` ‚Üí receipt_id
   - `get_pending_receipts(limit=50)` ‚Üí List[Receipt]
   - `mark_synced(receipt_id, server_time)` ‚Üí bool
   - `move_to_dlq(receipt_id, reason)` ‚Üí bool
3. Write unit tests in `tests/unit/test_buffer_db.py`

**Checkpoint W1.1:** Run `pytest tests/unit/test_buffer_db.py` ‚Äî all 5 tests should PASS.

**Reference:** See docs/PROMPT_ENGINEERING_TEMPLATES.md ¬ß3.2 for SQLite CRUD template.

---

## 0. Dependency Graph

**Purpose:** Understand task dependencies to parallelize independent work.

```mermaid
graph TD
    A[SQLite –±—É—Ñ–µ—Ä CRUD] --> B[Hybrid Logical Clock]
    B --> C[–ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ –±–∞–∑–æ–≤—ã–π API]
    C --> D[Circuit Breaker –¥–ª—è –û–§–î]
    D --> E[–î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è]
    E --> F[Sync Worker]

    G[optics_core models] --> H[optics_core views]
    G --> I[optics_pos_ru54fz —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è]

    J[connector_b –±–∞–∑–æ–≤—ã–π] --> K[connector_b –ø—Ä–æ—Ñ–∏–ª–∏ –º–∞–ø–ø–∏–Ω–≥–∞]
    K --> L[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–∏ –±—É—Ñ–µ—Ä–µ]
    L --> I

    M[ru_accounting_extras] --> N[–û—Ç—á—ë—Ç GP]
    M --> O[–ö–∞—Å—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ –ø–æ —Ç–æ—á–∫–∞–º]

    I --> P[POS UI –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º]
    F --> P

    style A fill:#90EE90
    style G fill:#90EE90
    style J fill:#90EE90
    style M fill:#90EE90
```

**Legend:**
- üü¢ Green nodes: **INDEPENDENT** ‚Äî can start immediately
- Arrows: Dependencies (A ‚Üí B means "B depends on A")

**Task Annotations:**

| Task | Status | Dependencies |
|------|--------|-------------|
| SQLite –±—É—Ñ–µ—Ä CRUD | INDEPENDENT | None ‚Äî start immediately |
| Hybrid Logical Clock | INDEPENDENT | None ‚Äî start immediately |
| optics_core models | INDEPENDENT | None ‚Äî start immediately |
| connector_b –±–∞–∑–æ–≤—ã–π | INDEPENDENT | None ‚Äî start immediately |
| ru_accounting_extras | INDEPENDENT | None ‚Äî start immediately |
| –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ –±–∞–∑–æ–≤—ã–π API | DEPENDS ON | SQLite –±—É—Ñ–µ—Ä, HLC |
| Circuit Breaker | DEPENDS ON | –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ API |
| –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è | DEPENDS ON | Circuit Breaker |
| Sync Worker | DEPENDS ON | –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è |
| optics_pos_ru54fz | DEPENDS ON | optics_core, –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ |
| –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ | DEPENDS ON | connector_b, –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ buffer API |
| POS UI –æ—Ñ–ª–∞–π–Ω | DEPENDS ON | optics_pos_ru54fz, Sync Worker |

**Parallelization Strategy:**
- **Week 1-2 (POC):** Work on SQLite + HLC + optics_core in parallel
- **Week 3-4:** After SQLite done ‚Üí start –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢; optics_core done ‚Üí start views
- **Week 6-7 (MVP):** All Odoo modules can be developed in parallel (independent)

---

## 1. –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

### 1.1 –¶–µ–ª—å
–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å ERP/POS —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–µ—Ç–∏ –æ–ø—Ç–∏–∫ –Ω–∞ –±–∞–∑–µ Odoo Community 17 —Å –∫—Ä–∏—Ç–∏—á–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **offline-first —Ä–µ–∂–∏–º–∞**:
- –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞—Å—Å—ã –ø—Ä–∏ –æ–±—Ä—ã–≤–∞—Ö —Å–≤—è–∑–∏ —Å –û–§–î (8+ —á–∞—Å–æ–≤)
- –ë–∏–∑–Ω–µ—Å-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ‚â•99.5% (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 54-–§–ó —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 20 —Ç–æ—á–µ–∫ (40 –∫–∞—Å—Å)

### 1.2 –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
1. **Offline-first:** –∫–∞—Å—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–Ω–æ–º–Ω–æ, –æ–±–ª–∞–∫–æ –≤—Ç–æ—Ä–∏—á–Ω–æ
2. **–î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è:** –ø–µ—á–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –û–§–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
3. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞:** 100% —á–µ–∫–æ–≤ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –û–§–î (Circuit Breaker + —Ä–µ—Ç—Ä–∞–∏)
4. **Hybrid Logical Clock:** –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç NTP
5. **Graceful degradation:** –ø–ª–∞–≤–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –æ—Ç–∫–∞–∑–æ–≤
6. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:** Circuit Breaker, Saga, Bulkhead, Event Sourcing

### 1.3 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

**Backend:**
- Odoo Community 17 (Python 3.11+)
- PostgreSQL 15
- Redis (–æ—á–µ—Ä–µ–¥–∏ Celery)
- Celery (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)

**Edge (–∫–∞—Å—Å–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª):**
- FastAPI (–∞–¥–∞–ø—Ç–µ—Ä –ö–ö–¢)
- SQLite (–æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä, WAL mode)
- APScheduler (heartbeat, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- Prometheus + Grafana
- Jaeger (—Ç—Ä–µ–π—Å–∏–Ω–≥)
- Sentry (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- Docker + Docker Compose
- Nginx (reverse proxy, TLS 1.3)
- NTP (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏)

---

## 2. –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (T0 = 06.10.2025)

| –≠—Ç–∞–ø | –°—Ä–æ–∫–∏ | –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã—Ö–æ–¥–∞ | –§–æ–∫—É—Å |
|------|-------|-----------------|-------|
| **POC** | 06.10 - 09.11 (5 –Ω–µ–¥) | POC-4/5 –ø—Ä–æ–π–¥–µ–Ω—ã, –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã | Proof of concept –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞ |
| **MVP** | 10.11 - 07.12 (4 –Ω–µ–¥) | UAT ‚â•95%, –æ—Ñ–ª–∞–π–Ω-UAT 100%, 0 –±–ª–æ–∫–µ—Ä–æ–≤ | –ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å |
| **Buffer** | 08.12 - 14.12 (1 –Ω–µ–¥) | –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã, 0 –±–ª–æ–∫–µ—Ä–æ–≤ | –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è |
| **–ü–∏–ª–æ—Ç** | 15.12 - 11.01 (4 –Ω–µ–¥) | –ë–∏–∑–Ω–µ—Å-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ‚â•99.5%, –æ–±—É—á–µ–Ω–∏–µ | 2 —Ç–æ—á–∫–∏ (4 –∫–∞—Å—Å—ã) |
| **Soft Launch** | 12.01 - 25.01 (2 –Ω–µ–¥) | Capacity metrics, —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ | 5 —Ç–æ—á–µ–∫ (10 –∫–∞—Å—Å) |
| **–ü—Ä–æ–¥** | 26.01 - 22.02 (4 –Ω–µ–¥) | RTO‚â§1—á, RPO‚â§24—á, 20 —Ç–æ—á–µ–∫ | –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ |

**–ò—Ç–æ–≥–æ:** 19 –Ω–µ–¥–µ–ª—å (T0 ‚Üí T0+19)

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 3.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
OpticsERP/
‚îú‚îÄ‚îÄ addons/                      # Odoo –º–æ–¥—É–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ optics_core/             # –†–µ—Ü–µ–ø—Ç—ã, –ª–∏–Ω–∑—ã, –∑–∞–∫–∞–∑—ã –Ω–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ optics_pos_ru54fz/       # POS + 54-–§–ó + –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º
‚îÇ   ‚îú‚îÄ‚îÄ connector_b/             # –ò–º–ø–æ—Ä—Ç Excel/CSV
‚îÇ   ‚îî‚îÄ‚îÄ ru_accounting_extras/    # –ö–∞—Å—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞, –æ—Ç—á—ë—Ç GP
‚îÇ
‚îú‚îÄ‚îÄ kkt_adapter/                 # –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ (–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ buffer.py            # SQLite –±—É—Ñ–µ—Ä + CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kkt_driver.py        # –î—Ä–∞–π–≤–µ—Ä –ö–ö–¢
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ofd_client.py        # –û–§–î API + Circuit Breaker
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync_worker.py       # –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heartbeat.py         # Heartbeat –∫ Odoo (30s)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hlc.py               # Hybrid Logical Clock
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ buffer.db            # SQLite –æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cache.json           # –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ config.toml              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ poc/                     # POC-—Ç–µ—Å—Ç—ã (1-5)
‚îÇ   ‚îú‚îÄ‚îÄ uat/                     # UAT-—Ç–µ—Å—Ç—ã (01-11)
‚îÇ   ‚îú‚îÄ‚îÄ load/                    # –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Å—Ü–µ–Ω–∞—Ä–∏–∏ 1-4)
‚îÇ   ‚îî‚îÄ‚îÄ integration/             # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ docs/                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (5 —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ docker-compose.yml           # –ü–æ–ª–Ω—ã–π —Å—Ç–µ–∫
‚îú‚îÄ‚îÄ config.toml                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
‚îî‚îÄ‚îÄ CLAUDE.md                    # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

### 3.2 –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ Odoo

#### optics_core
**–¶–µ–ª—å:** –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–∫–∏

**–ú–æ–¥–µ–ª–∏:**
- `optics.prescription` ‚Äî —Ä–µ—Ü–µ–ø—Ç (Sph, Cyl, Axis, PD, Add, Prism)
- `optics.lens` ‚Äî –ª–∏–Ω–∑–∞ (—Ç–∏–ø, –∏–Ω–¥–µ–∫—Å, –ø–æ–∫—Ä—ã—Ç–∏–µ)
- `optics.manufacturing.order` ‚Äî –∑–∞–∫–∞–∑ –Ω–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ

**Workflow –∑–∞–∫–∞–∑–∞:**
```
Draft ‚Üí Confirmed ‚Üí In Production ‚Üí Ready ‚Üí Delivered
```

**–§–∞–π–ª—ã:**
- `models/prescription.py`
- `models/lens.py`
- `models/manufacturing_order.py`
- `views/prescription_views.xml`
- `reports/order_label.xml` (—à—Ç—Ä–∏—Ö–∫–æ–¥)

#### optics_pos_ru54fz
**–¶–µ–ª—å:** POS + 54-–§–ó + –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–¥–∞–ø—Ç–µ—Ä–æ–º –ö–ö–¢ (API –≤—ã–∑–æ–≤—ã)
- X/Z-–æ—Ç—á—ë—Ç—ã (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –§–§–î 1.2)
- –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —á–µ–∫ (email/SMS)
- UI –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞ (–∏–Ω–¥–∏–∫–∞—Ü–∏—è –±—É—Ñ–µ—Ä–∞, –∞–ª–µ—Ä—Ç—ã)

**–ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏:**
- `pos.offline.buffer.status` ‚Äî —Å—Ç–∞—Ç—É—Å –±—É—Ñ–µ—Ä–∞ –¥–ª—è UI
- `pos.session.report` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è X/Z-–æ—Ç—á—ë—Ç–æ–≤

**–§–∞–π–ª—ã:**
- `models/pos_session.py` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
- `static/src/js/offline_indicator.js` (UI –≤–∏–¥–∂–µ—Ç)
- `controllers/kkt_adapter_api.py` (–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ –∞–¥–∞–ø—Ç–µ—Ä–∞)

#### connector_b
**–¶–µ–ª—å:** –ò–º–ø–æ—Ä—Ç –ø—Ä–∞–π—Å–æ–≤/–æ—Å—Ç–∞—Ç–∫–æ–≤ Excel/CSV

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ—Ñ–∏–ª–∏ –º–∞–ø–ø–∏–Ω–≥–∞ (3+ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞)
- –ü—Ä–µ–≤—å—é –∏–º–ø–æ—Ä—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- Upsert (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–∞—Ö
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–∏ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±—É—Ñ–µ—Ä–∞—Ö

**–ú–æ–¥–µ–ª–∏:**
- `connector.import.profile` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –º–∞–ø–ø–∏–Ω–≥–∞
- `connector.import.job` ‚Äî –∑–∞–¥–∞—á–∞ –∏–º–ø–æ—Ä—Ç–∞
- `connector.import.log` ‚Äî –ª–æ–≥–∏ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)

**–§–∞–π–ª—ã:**
- `models/import_profile.py`
- `models/import_job.py`
- `wizards/import_wizard.py` (–ø—Ä–µ–≤—å—é)
- `controllers/import_api.py`

#### ru_accounting_extras
**–¶–µ–ª—å:** –ö–∞—Å—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ –ø–æ —Ç–æ—á–∫–∞–º, –æ—Ç—á—ë—Ç GP

**–§—É–Ω–∫—Ü–∏–∏:**
- –ö–∞—Å—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ (`account.account`) –ø–æ —Ç–æ—á–∫–∞–º
- –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏
- –û—Ç—á—ë—Ç –≤–∞–ª–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ (GP)
- –û—Ç—á—ë—Ç –ø—Ä–∏–±—ã–ª–∏ –ø–æ —Ç–æ—á–∫–∞–º

**–ú–æ–¥–µ–ª–∏:**
- `account.cash.transfer` ‚Äî –ø–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `sale.order` –∏ `pos.order` –¥–ª—è GP

**–§–∞–π–ª—ã:**
- `models/cash_transfer.py`
- `reports/gp_report.py`
- `reports/profit_by_location.py`

---

## 4. –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢ (kkt_adapter) ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è

### 4.1 –û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä (SQLite)

**–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —á–µ–∫–æ–≤
CREATE TABLE receipts (
  id TEXT PRIMARY KEY,              -- UUIDv4
  pos_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,      -- Unix timestamp
  hlc_local_time INTEGER NOT NULL,  -- Hybrid Logical Clock
  hlc_logical_counter INTEGER NOT NULL,
  hlc_server_time INTEGER,          -- –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  fiscal_doc TEXT NOT NULL,         -- JSON –§–§–î
  status TEXT NOT NULL DEFAULT 'pending',  -- pending|syncing|synced|failed
  retry_count INTEGER DEFAULT 0,
  last_error TEXT,
  synced_at INTEGER,
  CHECK (status IN ('pending', 'syncing', 'synced', 'failed'))
);

CREATE INDEX idx_status ON receipts(status);
CREATE INDEX idx_created_at ON receipts(created_at);
CREATE INDEX idx_hlc ON receipts(hlc_server_time, hlc_local_time, hlc_logical_counter);

-- Dead Letter Queue
CREATE TABLE dlq (
  id TEXT PRIMARY KEY,
  original_receipt_id TEXT NOT NULL,
  failed_at INTEGER NOT NULL,
  reason TEXT NOT NULL,
  fiscal_doc TEXT NOT NULL,
  retry_attempts INTEGER NOT NULL,
  last_error TEXT,
  resolved_at INTEGER,
  resolved_by TEXT,
  FOREIGN KEY (original_receipt_id) REFERENCES receipts(id)
);

-- –°–æ–±—ã—Ç–∏—è (Event Sourcing)
CREATE TABLE buffer_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  event_type TEXT NOT NULL,
  receipt_id TEXT,
  timestamp INTEGER NOT NULL,
  metadata TEXT,
  CHECK (event_type IN ('receipt_added', 'receipt_synced', 'receipt_failed',
                        'circuit_opened', 'circuit_closed', 'sync_started', 'sync_completed'))
);
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SQLite (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è durability):**
```python
def init_buffer_db(db_path='/app/data/buffer.db'):
    conn = sqlite3.connect(db_path)

    # –ö–†–ò–¢–ò–ß–ù–û: –∑–∞—â–∏—Ç–∞ –æ—Ç power loss
    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA synchronous=FULL")       # !!!
    conn.execute("PRAGMA wal_autocheckpoint=100")
    conn.execute("PRAGMA cache_size=-64000")      # 64 MB
    conn.execute("PRAGMA foreign_keys=ON")

    return conn
```

### 4.2 –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–∑–∞ 1: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–≤—Å–µ–≥–¥–∞ —É—Å–ø–µ—à–Ω–∞)**
```python
def create_receipt_phase1(receipt_data):
    """
    –§–∞–∑–∞ 1: –ª–æ–∫–∞–ª—å–Ω–∞—è ‚Äî –≤—Å–µ–≥–¥–∞ —É—Å–ø–µ—à–Ω–∞, –¥–∞–∂–µ –±–µ–∑ —Å–µ—Ç–∏.
    """
    # 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Hybrid Logical Clock timestamp
    hlc = generate_hlc()
    receipt_id = str(uuid.uuid4())

    # 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SQLite
    buffer_db.execute(
        """INSERT INTO receipts
           (id, pos_id, created_at, hlc_local_time, hlc_logical_counter, fiscal_doc, status)
           VALUES (?, ?, ?, ?, ?, ?, 'pending')""",
        (receipt_id, receipt_data['pos_id'], int(time.time()),
         hlc.local_time, hlc.logical_counter, json.dumps(receipt_data))
    )
    buffer_db.commit()

    # 3. –ü–µ—á–∞—Ç—å —á–µ–∫–∞ –Ω–∞ –ö–ö–¢
    try:
        kkt_driver.print_receipt(receipt_data)
    except TimeoutError:
        send_alert(f"–ö–ö–¢ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ {receipt_data['pos_id']}", level='P2')

    # 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
    buffer_db.execute(
        "INSERT INTO buffer_events (event_type, receipt_id, timestamp) VALUES (?, ?, ?)",
        ('receipt_added', receipt_id, int(time.time()))
    )

    return receipt_id
```

**–§–∞–∑–∞ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –û–§–î (—Å Circuit Breaker)**
```python
class OFDCircuitBreaker:
    @circuit(failure_threshold=5, recovery_timeout=60)
    async def send_receipt(self, receipt):
        response = await ofd_client.post("/receipts", json=receipt, timeout=10)
        return response

async def create_receipt_phase2(receipt_id):
    """
    –§–∞–∑–∞ 2: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –û–§–î (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è, best-effort)
    """
    receipt = buffer_db.execute(
        "SELECT * FROM receipts WHERE id = ? AND status = 'pending'",
        (receipt_id,)
    ).fetchone()

    if not receipt:
        return

    try:
        if ofd_cb.current_state == "OPEN":
            log.warning(f"Circuit Breaker OPEN, buffering {receipt_id}")
            return

        fiscal_doc = await ofd_cb.send_receipt(json.loads(receipt['fiscal_doc']))

        buffer_db.execute(
            """UPDATE receipts
               SET status='synced', synced_at=?, hlc_server_time=?
               WHERE id=?""",
            (int(time.time()), get_server_time(), receipt_id)
        )
        buffer_db.commit()

    except CircuitBreakerError:
        log.warning(f"Circuit Breaker opened for {receipt_id}")

    except (TimeoutError, ConnectionError) as e:
        buffer_db.execute(
            "UPDATE receipts SET retry_count = retry_count + 1, last_error = ? WHERE id = ?",
            (str(e), receipt_id)
        )
        buffer_db.commit()

        if receipt['retry_count'] + 1 >= 20:
            move_to_dlq(receipt_id, reason="max_retries_exceeded")
```

### 4.3 Hybrid Logical Clock

```python
@dataclass
class HybridTimestamp:
    local_time: int        # Unix timestamp –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    logical_counter: int   # –ú–æ–Ω–æ—Ç–æ–Ω–Ω—ã–π —Å—á—ë—Ç—á–∏–∫
    server_time: Optional[int] = None  # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

    def __lt__(self, other):
        # –ü–æ—Ä—è–¥–æ–∫: server_time > local_time > logical_counter
        if self.server_time and other.server_time:
            if self.server_time != other.server_time:
                return self.server_time < other.server_time
        elif self.local_time != other.local_time:
            return self.local_time < other.local_time
        return self.logical_counter < other.logical_counter

def generate_hlc():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Hybrid Logical Clock timestamp"""
    global _hlc_counter, _last_hlc_time

    current_time = int(time.time())

    if current_time == _last_hlc_time:
        _hlc_counter += 1
    else:
        _hlc_counter = 0
        _last_hlc_time = current_time

    return HybridTimestamp(
        local_time=current_time,
        logical_counter=_hlc_counter,
        server_time=None
    )
```

### 4.4 API endpoints –∞–¥–∞–ø—Ç–µ—Ä–∞

```yaml
# OpenAPI 3.0.3
paths:
  /v1/kkt/receipt:
    post:
      summary: Create fiscal receipt (–¥–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è)
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [pos_id, type, items, payments]
              properties:
                pos_id: { type: string }
                type: { enum: [sale, refund, correction] }
                items: { type: array }
                payments: { type: array }
      responses:
        '200':
          description: –ß–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ
          content:
            application/json:
              schema:
                properties:
                  status: { enum: [printed, buffered] }
                  receipt_id: { type: string, format: uuid }
                  fiscal_doc: { type: object, nullable: true }
        '503':
          description: –û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω

  /v1/kkt/buffer/status:
    get:
      summary: –°—Ç–∞—Ç—É—Å –æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä–∞
      responses:
        '200':
          content:
            application/json:
              schema:
                properties:
                  total_capacity: { type: integer, example: 200 }
                  current_queued: { type: integer }
                  percent_full: { type: number }
                  network_status: { enum: [online, offline, degraded] }

  /v1/kkt/buffer/sync:
    post:
      summary: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
      security: [AdminAuth: []]
      requestBody:
        content:
          application/json:
            schema:
              properties:
                force: { type: boolean, default: false }
      responses:
        '202':
          description: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞
        '409':
          description: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –∏–¥–µ—Ç (Distributed Lock)

  /v1/health:
    get:
      summary: Health check
      responses:
        '200':
          content:
            application/json:
              schema:
                properties:
                  status: { enum: [healthy, degraded, unhealthy] }
                  components:
                    type: object
                    properties:
                      circuit_breaker:
                        properties:
                          state: { enum: [CLOSED, OPEN, HALF_OPEN] }
```

---

## 5. –ü–ª–∞–Ω —Å–ø—Ä–∏–Ω—Ç–æ–≤ (–¥–µ—Ç–∞–ª—å–Ω–æ)

### 5.1 –°–ø—Ä–∏–Ω—Ç 1-3: POC (5 –Ω–µ–¥–µ–ª—å)

**–ù–µ–¥–µ–ª—è 1-2: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏—è (Odoo + PostgreSQL + Redis)
- [ ] –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π Odoo (—Å–∫–µ–ª–µ—Ç—ã)
- [ ] –ê–¥–∞–ø—Ç–µ—Ä –ö–ö–¢: FastAPI skeleton
- [ ] SQLite –±—É—Ñ–µ—Ä: —Å—Ö–µ–º–∞ + CRUD
- [ ] Hybrid Logical Clock: –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è + unit-—Ç–µ—Å—Ç—ã

**–ù–µ–¥–µ–ª—è 3: –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è + Circuit Breaker**
- [ ] –§–∞–∑–∞ 1: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SQLite + –ø–µ—á–∞—Ç—å
- [ ] –§–∞–∑–∞ 2: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –û–§–î (mock)
- [ ] Circuit Breaker: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [ ] POC-1: —ç–º—É–ª—è—Ç–æ—Ä –ö–ö–¢ + 50 –æ–ø–µ—Ä–∞—Ü–∏–π

**–ù–µ–¥–µ–ª—è 4: Heartbeat + –û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º**
- [ ] Heartbeat –∫ Odoo (30s, hysteresis)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ online/offline/degraded
- [ ] –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞ (1000 —Ç–æ–≤–∞—Ä–æ–≤)
- [ ] POC-4: 8—á –æ—Ñ–ª–∞–π–Ω, 50 —á–µ–∫–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–ù–µ–¥–µ–ª—è 5: –ò–º–ø–æ—Ä—Ç + POC-5 (split-brain)**
- [ ] connector_b: –±–∞–∑–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç Excel
- [ ] POC-2: –∏–º–ø–æ—Ä—Ç 10k —Å—Ç—Ä–æ–∫
- [ ] POC-5: —Ç–µ—Å—Ç—ã split-brain, flapping, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- [ ] –û—Ç—á—ë—Ç POC + Go/No-Go —Ä–µ—à–µ–Ω–∏–µ

### 5.2 –°–ø—Ä–∏–Ω—Ç 4-5: MVP (4 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 6-7: Odoo –º–æ–¥—É–ª–∏**
- [ ] optics_core: –º–æ–¥–µ–ª–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤/–ª–∏–Ω–∑/–∑–∞–∫–∞–∑–æ–≤
- [ ] optics_pos_ru54fz: POS UI + X/Z-–æ—Ç—á—ë—Ç—ã
- [ ] ru_accounting_extras: –∫–∞—Å—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ + GP
- [ ] connector_b: –ø—Ä–æ—Ñ–∏–ª–∏ –º–∞–ø–ø–∏–Ω–≥–∞ + –ø—Ä–µ–≤—å—é

**–ù–µ–¥–µ–ª—è 8: –û—Ñ–ª–∞–π–Ω UI + –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã**
- [ ] UI –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞: —Å—Ç–∞—Ç—É—Å-–±–∞—Ä, tooltip, –∞–ª–µ—Ä—Ç—ã
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä" (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
- [ ] Distributed Lock –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Redis)
- [ ] Saga Pattern –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —á–µ–∫–∞
- [ ] Bulkhead Pattern (Celery –æ—á–µ—Ä–µ–¥–∏: critical/high/default/low)

**–ù–µ–¥–µ–ª—è 9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ + UAT**
- [ ] UAT-01/02/03/04: –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- [ ] UAT-08/09/10b/10c/11: –æ—Ñ–ª–∞–π–Ω-—Å—Ü–µ–Ω–∞—Ä–∏–∏
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤
- [ ] MVP sign-off

### 5.3 –°–ø—Ä–∏–Ω—Ç 6: Buffer (1 –Ω–µ–¥–µ–ª—è)

**–ù–µ–¥–µ–ª—è 10: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è**
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Å—Ü–µ–Ω–∞—Ä–∏–∏ 1-3)
- [ ] –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç (5 –∫–∞—Å—Å, —Å—Ü–µ–Ω–∞—Ä–∏–π 4)
- [ ] Rollback-–ø—Ä–æ—Ü–µ–¥—É—Ä–∞: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö 5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] CI/CD gate: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è DoD

### 5.4 –°–ø—Ä–∏–Ω—Ç 7-8: –ü–∏–ª–æ—Ç (4 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 11-12: –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ 2 —Ç–æ—á–µ–∫**
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ –ö–ö–¢ –Ω–∞ 4 –∫–∞—Å—Å—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UPS + graceful shutdown
- [ ] –û–±—É—á–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–æ–≤ (‚â•90% –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞)
- [ ] –†–µ–≥–ª–∞–º–µ–Ω—Ç X/Z-–æ—Ç—á—ë—Ç–æ–≤ + –æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä

**–ù–µ–¥–µ–ª—è 13-14: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + —Ä–µ–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è**
- [ ] Grafana dashboard (4 –ø–∞–Ω–µ–ª–∏)
- [ ] –ê–ª–µ—Ä—Ç—ã Prometheus + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (email/telegram)
- [ ] Stress-test: 2 –∫–∞—Å—Å—ã √ó 8—á –æ—Ñ–ª–∞–π–Ω √ó 50 —á–µ–∫–æ–≤
- [ ] Decision Tree –¥–ª—è L1/L2
- [ ] –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–º–µ–Ω—ã –§–ù
- [ ] –ü–∏–ª–æ—Ç sign-off

### 5.5 –°–ø—Ä–∏–Ω—Ç 9: Soft Launch (2 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 15-16: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ 5 —Ç–æ—á–µ–∫ + capacity metrics**
- [ ] –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ 5 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–∞—Å—Å (–∏—Ç–æ–≥–æ 10)
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π (—Å—Ü–µ–Ω–∞—Ä–∏–π 4: 5 –∫–∞—Å—Å, 1000 —á–µ–∫–æ–≤/–¥–µ–Ω—å)
- [ ] Capacity metrics: PostgreSQL, Celery, Odoo
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∑–∫–∏—Ö –º–µ—Å—Ç:
  - [ ] PostgreSQL query P95 <50ms
  - [ ] Celery critical queue <30 –∑–∞–¥–∞—á
  - [ ] –ù–µ—Ç OOM/CPU throttling
- [ ] –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Å—ã (–∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ + —Ç–µ—Å—Ç)
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
- [ ] Soft Launch sign-off

### 5.6 –°–ø—Ä–∏–Ω—Ç 10-11: –ü—Ä–æ–¥—É–∫—Ç–∏–≤ (4 –Ω–µ–¥–µ–ª–∏)

**–ù–µ–¥–µ–ª—è 17-18: –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ 20 —Ç–æ—á–µ–∫**
- [ ] –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 20 —Ç–æ—á–µ–∫ (40 –∫–∞—Å—Å)
- [ ] pgbouncer: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] –ë—ç–∫–∞–ø—ã –æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä–æ–≤: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ snapshot
- [ ] DR-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: RTO‚â§1—á, RPO‚â§24—á

**–ù–µ–¥–µ–ª—è 19-20: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è + Day 2 Ops**
- [ ] –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (‚â•50 —Å—Ç—Ä–∞–Ω–∏—Ü)
- [ ] Runbook (‚â•20 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤)
- [ ] SLA –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ + –ø—Ä–æ—Ü–µ–¥—É—Ä—ã —ç—Å–∫–∞–ª–∞—Ü–∏–∏
- [ ] On-call –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
- [ ] –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- [ ] –ü—Ä–æ–¥—É–∫—Ç–∏–≤ sign-off

---

## 6. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ —ç—Ç–∞–ø–æ–≤ (DoD)

### 6.1 MVP Exit

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ | –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è |
|----------|----------------------|---------------|
| **‚â•95% UAT –ø—Ä–æ–π–¥–µ–Ω–æ** | –ü—Ä–æ—Ç–æ–∫–æ–ª UAT (11 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤) | –ß–∞—Å—Ç–∏—á–Ω–æ (–∞–≤—Ç–æ—Ç–µ—Å—Ç—ã) |
| **0 –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤** | JIRA: `type=Bug AND severity=Blocker AND status!=Closed` | –ü–æ–ª–Ω–æ—Å—Ç—å—é (CI gate) |
| **–î—É–±–ª–∏–∫–∞—Ç—ã —á–µ–∫–æ–≤ = 0** | SQL-–∑–∞–ø—Ä–æ—Å –ø–æ –±—É—Ñ–µ—Ä—É + –û–§–î API | –ü–æ–ª–Ω–æ—Å—Ç—å—é (pytest) |
| **P95 –ø–µ—á–∞—Ç–∏ ‚â§7—Å** | Jaeger traces –∑–∞ 24—á | –ü–æ–ª–Ω–æ—Å—Ç—å—é (Jaeger API) |
| **–ò–º–ø–æ—Ä—Ç 10k ‚â§2 –º–∏–Ω** | –¢–µ—Å—Ç–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç | –ü–æ–ª–Ω–æ—Å—Ç—å—é (pytest) |
| **–û—Ñ–ª–∞–π–Ω: 8—á, 50 —á–µ–∫–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚â§10 –º–∏–Ω** | –ê–≤—Ç–æ—Ç–µ—Å—Ç POC-4 | –ü–æ–ª–Ω–æ—Å—Ç—å—é (pytest + tc qdisc) |
| **UAT-08/09/10b/10c/11 –ø—Ä–æ–π–¥–µ–Ω—ã** | –†—É—á–Ω—ã–µ –æ—Ñ–ª–∞–π–Ω-UAT | –ß–∞—Å—Ç–∏—á–Ω–æ (backend –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã) |
| **Circuit Breaker —Ä–∞–±–æ—Ç–∞–µ—Ç** | –≠–º—É–ª—è—Ü–∏—è 5 –æ—à–∏–±–æ–∫ –û–§–î ‚Üí OPEN ‚Üí HALF_OPEN | –ê–≤—Ç–æ—Ç–µ—Å—Ç (pytest) |
| **Distributed Lock —Ä–∞–±–æ—Ç–∞–µ—Ç** | –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Üí HTTP 409 | –ê–≤—Ç–æ—Ç–µ—Å—Ç (pytest) |
| **Saga Pattern —Ä–∞–±–æ—Ç–∞–µ—Ç** | –í–æ–∑–≤—Ä–∞—Ç –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —á–µ–∫–∞ ‚Üí HTTP 409 | –ê–≤—Ç–æ—Ç–µ—Å—Ç (pytest) |

### 6.2 –ü–∏–ª–æ—Ç Exit

- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ MVP
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ‚â•99.5% (2 –Ω–µ–¥–µ–ª–∏)
- ‚úÖ –û–±—É—á–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–æ–≤: ‚â•90% –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç
- ‚úÖ –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã X/Z + –æ—Ñ–ª–∞–π–Ω —É—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã
- ‚úÖ Stress-test: 2 –∫–∞—Å—Å—ã √ó 8—á √ó 50 —á–µ–∫–æ–≤ ‚Üí 100% —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- ‚úÖ 0 P1 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –∑–∞ 2 –Ω–µ–¥–µ–ª–∏

### 6.3 –ü—Ä–æ–¥—É–∫—Ç–∏–≤ Exit

- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ü–∏–ª–æ—Ç–∞
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: 20 —Ç–æ—á–µ–∫ (40 –∫–∞—Å—Å)
- ‚úÖ RTO‚â§1—á, RPO‚â§24—á (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –¥–∞—à–±–æ—Ä–¥ + –∞–ª–µ—Ä—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã
- ‚úÖ –ë—ç–∫–∞–ø—ã: PostgreSQL + SQLite –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
- ‚úÖ –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã

---

## 7. –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| **–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä–∞** | –°—Ä–µ–¥–Ω—è—è | –ö—Ä–∏—Ç–∏—á–Ω–æ–µ | –ê–ª–µ—Ä—Ç –ø—Ä–∏ 80%, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ 100%, –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |
| **–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ö–ö–¢** | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | NTP –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, Hybrid Clock —Å–Ω–∏–∂–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ drift |
| **–§–ù –∑–∞–ø–æ–ª–Ω–µ–Ω –≤–æ –≤—Ä–µ–º—è –æ—Ñ–ª–∞–π–Ω–∞** | –ù–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–Ω–æ–µ | –ê–ª–µ—Ä—Ç –∑–∞ 3-5 –¥–Ω–µ–π, –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–º–µ–Ω—ã –§–ù —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –±—É—Ñ–µ—Ä–∞ |
| **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (1 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)** | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –§–æ–∫—É—Å –Ω–∞ MVP, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤, part-time DevOps/QA |
| **–ù–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ –ø—Ä–∞–π—Å—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤** | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –í–∞–ª–∏–¥–∞—Ü–∏—è, –ø—Ä–µ–≤—å—é –∏–º–ø–æ—Ä—Ç–∞, –∞–ª–µ—Ä—Ç—ã –Ω–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è >20% |

---

## 8. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### 8.1 –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ Prometheus

```python
# –û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä
kkt_buffer_size = Gauge('kkt_buffer_size', 'Current buffer size', ['pos_id'])
kkt_buffer_percent_full = Gauge('kkt_buffer_percent_full', 'Buffer fullness %', ['pos_id'])

# Circuit Breaker
kkt_circuit_breaker_state = Gauge('kkt_circuit_breaker_state', 'State: 0=CLOSED, 1=OPEN, 2=HALF_OPEN', ['pos_id'])
kkt_circuit_breaker_opens = Counter('kkt_circuit_breaker_opens_total', 'Times opened', ['pos_id'])

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
kkt_sync_duration_seconds = Histogram('kkt_sync_duration_seconds', 'Sync duration', ['pos_id'])
kkt_receipts_synced = Counter('kkt_receipts_synced_total', 'Total synced', ['pos_id', 'status'])

# DLQ
kkt_dlq_size = Gauge('kkt_dlq_size', 'Dead Letter Queue size', ['pos_id'])

# Hybrid Clock
kkt_hlc_drift_seconds = Gauge('kkt_hlc_drift_seconds', 'HLC drift from NTP', ['pos_id'])
```

### 8.2 –ê–ª–µ—Ä—Ç—ã (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)

```yaml
groups:
  - name: offline_mode_alerts
    rules:
      - alert: OfflineBufferWarning
        expr: kkt_buffer_percent_full >= 80
        for: 5m
        labels: { severity: P2 }
        annotations:
          summary: "–û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä ‚â•80% –Ω–∞ {{ $labels.pos_id }}"

      - alert: OfflineBufferFull
        expr: kkt_buffer_percent_full >= 100
        for: 1m
        labels: { severity: P1 }
        annotations:
          summary: "–û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {{ $labels.pos_id }}"

      - alert: CircuitBreakerOpen
        expr: kkt_circuit_breaker_state == 1
        for: 5m
        labels: { severity: P2 }
        annotations:
          summary: "Circuit Breaker OPEN –Ω–∞ {{ $labels.pos_id }}"
```

### 8.3 Grafana Dashboard (4 –ø–∞–Ω–µ–ª–∏)

1. **–°—Ç–∞—Ç—É—Å –∫–∞—Å—Å:** –∫–∞—Ä—Ç–∞ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π (üü¢/üü°/üî¥)
2. **Circuit Breaker:** —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞ 24—á (CLOSED/OPEN/HALF_OPEN)
3. **–û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä:** –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å, —Ç–æ–ø-5 –∫–∞—Å—Å, —Å—Ä–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** P95 –ø–µ—á–∞—Ç–∏, throughput —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, DLQ

---

## 9. –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ–º

### 9.1 Pre-flight (–ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ–º)

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- [ ] –û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä –ø—É—Å—Ç (<10 —á–µ–∫–æ–≤ –Ω–∞ –≤—Å–µ—Ö –∫–∞—Å—Å–∞—Ö)
- [ ] NTP-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞ (drift <1—Å)
- [ ] –ö—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞ –∞–∫—Ç—É–∞–ª–µ–Ω (<1—á –¥–∞–≤–Ω–æ—Å—Ç–∏)
- [ ] –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ ‚â•10GB
- [ ] Heartbeat –∫ Odoo —Ä–∞–±–æ—Ç–∞–µ—Ç (100% –∫–∞—Å—Å)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞ –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ —É—Å–ø–µ—à–Ω–∞ (–≤—Å–µ –∫–∞—Å—Å—ã)
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ —É—Å–ø–µ—à–Ω–∞ (–º–∏–Ω–∏–º—É–º 1 –∫–∞—Å—Å–∞)
- [ ] –ê–ª–µ—Ä—Ç—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Ç–µ—Å—Ç –Ω–∞ —Å—Ç–µ–Ω–¥–µ)

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- [ ] Grafana –¥–∞—à–±–æ—Ä–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∞–∫—Ç—É–∞–ª–µ–Ω
- [ ] Prometheus exporter —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–∞—Ö
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞–Ω–∞–ª–∞–º–∏ –∞–ª–µ—Ä—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 9.2 Post-deployment (smoke-test)

**–í —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç:**
- [ ] –ü—Ä–æ–¥–∞–∂–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞—Å—Å–µ (100% —É—Å–ø–µ—Ö)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä–æ–≤ (—Ä–∞–∑–º–µ—Ä –Ω–µ –≤—ã—Ä–æ—Å)
- [ ] Heartbeat –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–≤—Å–µ –∫–∞—Å—Å—ã)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤

**–í —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤:**
- [ ] –ù–µ—Ç P1/P2 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤
- [ ] –û—Ñ–ª–∞–π–Ω-–±—É—Ñ–µ—Ä—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã
- [ ] –õ–æ–≥–∏: –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫

---

## 10. –†–µ–≥–ª–∞–º–µ–Ω—Ç—ã —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏

### 10.1 –ë—ç–∫–∞–ø—ã

**PostgreSQL:**
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π full backup (pg_dump)
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- –†–µ—Ç–µ–Ω—Ü–∏—è: 90 –¥–Ω–µ–π

**SQLite –±—É—Ñ–µ—Ä—ã:**
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π snapshot –≤—Å–µ—Ö SQLite-—Ñ–∞–π–ª–æ–≤
- –†–µ—Ç–µ–Ω—Ü–∏—è: 7 –¥–Ω–µ–π
- `PRAGMA wal_checkpoint(TRUNCATE)` –ø–µ—Ä–µ–¥ backup

### 10.2 SLA –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | Response | Resolution | –≠—Å–∫–∞–ª–∞—Ü–∏—è |
|-----------|----------|------------|-----------|
| P1 (Critical) | ‚â§15 –º–∏–Ω | ‚â§1 —á | –í–ª–∞–¥–µ–ª–µ—Ü —á–µ—Ä–µ–∑ 30 –º–∏–Ω |
| P2 (High) | ‚â§1 —á | ‚â§4 —á | –¢–µ—Ö. –ª–∏–¥–µ—Ä —á–µ—Ä–µ–∑ 2—á |
| P3 (Medium) | ‚â§24 —á | ‚â§3 –¥–Ω—è | –ù–µ—Ç |

### 10.3 On-call

**–ö–æ–Ω—Ç–∞–∫—Ç—ã:**
- L1: __________________ (—Ç–µ–ª–µ—Ñ–æ–Ω, telegram)
- L2: __________________ (—Ç–µ–ª–µ—Ñ–æ–Ω, telegram)
- –í–ª–∞–¥–µ–ª–µ—Ü: __________________ (—Ç–æ–ª—å–∫–æ P1)

**–†–æ—Ç–∞—Ü–∏—è:** –Ω–µ–¥–µ–ª—å–Ω–∞—è (–ø–Ω 09:00 ‚Üí –ø–Ω 09:00)

---

## 11. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–ù–µ–¥–µ–ª—è 1):
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–µ (docker-compose.yml)
2. –°–æ–∑–¥–∞—Ç—å —Å–∫–µ–ª–µ—Ç—ã –º–æ–¥—É–ª–µ–π Odoo
3. –ù–∞—á–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∞–¥–∞–ø—Ç–µ—Ä–∞ –ö–ö–¢ (FastAPI)
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å SQLite –±—É—Ñ–µ—Ä —Å –±–∞–∑–æ–≤–æ–π —Å—Ö–µ–º–æ–π

### –ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (–ù–µ–¥–µ–ª—è 2-3):
1. –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å Hybrid Logical Clock
2. –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å Circuit Breaker –¥–ª—è –û–§–î
3. –°–æ–∑–¥–∞—Ç—å POC-—Ç–µ—Å—Ç—ã (1-5)

### –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ (–ù–µ–¥–µ–ª—è 4-9):
1. –ó–∞–≤–µ—Ä—à–∏—Ç—å MVP (–≤—Å–µ –º–æ–¥—É–ª–∏ + UAT)
2. –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –ø–∏–ª–æ—Ç—É

---

## 12. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- docs/1. –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏.md ‚Äî —Ü–µ–ª–∏, OKR, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- docs/2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è.md ‚Äî —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ/–Ω–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, UAT
- docs/3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.md ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, API, —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ
- docs/4. –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞.md ‚Äî –ø–ª–∞–Ω —Ä–∞–±–æ—Ç, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
- docs/5. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—É.md ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ñ–ª–∞–π–Ω, Decision Tree, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

**–í–Ω–µ—à–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
- 54-–§–ó: —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å
- –§–§–î 1.2: —Ñ–æ—Ä–º–∞—Ç —Ñ–∏—Å–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Odoo 17 Community: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- Circuit Breaker: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `pybreaker`
- Distributed Lock: Redis + `python-redis-lock`
- Hybrid Clock: custom –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è
- OpenTelemetry: —Ç—Ä–µ–π—Å–∏–Ω–≥

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –ø–ª–∞–Ω –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏ OpticsERP —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ **offline-first –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ** –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–Ω–æ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–∏. –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:

‚úÖ **–î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å-–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å
‚úÖ **Circuit Breaker** –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—Ç–∫–∞–∑–æ–≤
‚úÖ **Hybrid Logical Clock** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ–±—ã—Ç–∏–π
‚úÖ **Distributed Lock** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
‚úÖ **19 –Ω–µ–¥–µ–ª—å** –æ—Ç —Å—Ç–∞—Ä—Ç–∞ –¥–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–∞ (T0 ‚Üí T0+19)
‚úÖ **–ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω** —Å —á—ë—Ç–∫–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ —É—Å–ø–µ—Ö–∞

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –Ω–∞—á–∞—Ç—å –°–ø—Ä–∏–Ω—Ç 1 (POC) —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

---

## 13. AI Agent Handoff Protocol

### 13.1 When Starting New AI Session

**Purpose:** Resume development from last checkpoint without loss of context.

**Steps:**

1. **Resume from checkpoint history:**
   ```bash
   # Read last session notes
   cat claude_history/session_$(date +%Y%m%d).md

   # Or find latest session
   ls -t claude_history/ | head -1
   ```

2. **Verify environment:**
   ```bash
   # Check project structure
   make verify-env

   # Check git status (what was changed?)
   git status

   # List all tests (should be 50+ after POC)
   pytest --co
   ```

3. **Run last checkpoint:**
   ```bash
   # Example: resuming after W6.2 (optics.lens model)
   pytest tests/unit/test_lens.py -v

   # Expected: All tests PASS
   ```

4. **If checkpoint fails:**
   - **STOP** ‚Äî do not proceed with development
   - **Escalate to human** with detailed error report:
     ```
     ‚ùå Checkpoint W6.2 failed

     Test: tests/unit/test_lens.py::test_lens_coating_validation
     Error: AssertionError: Expected coating 'AR' in allowed list

     Last commit: a3f2d1e "feat(optics_core): add lens model"
     Last session: claude_history/session_20251008.md

     Action needed: Review lens.py:45 coating validation logic
     ```

### 13.2 When Ending AI Session

**Purpose:** Document progress for next session (human or AI).

**Steps:**

1. **Document progress:**
   ```bash
   # Create/update session file
   SESSION_FILE="claude_history/session_$(date +%Y%m%d).md"

   cat >> $SESSION_FILE << EOF
   ## Session $(date +%Y-%m-%d\ %H:%M)

   ### Completed
   - ‚úÖ optics.lens model implemented (models/lens.py)
   - ‚úÖ Unit tests written (tests/unit/test_lens.py)
   - ‚úÖ Checkpoint W6.2 passed

   ### Next Session Tasks
   - [ ] Implement optics.manufacturing.order workflow
   - [ ] Run Checkpoint W6.3

   ### Checkpoints Status
   - W6.1 (prescription model): ‚úÖ PASS
   - W6.2 (lens model): ‚úÖ PASS
   - W6.3 (manufacturing order): ‚è≥ Pending

   ### Blockers
   - None

   ### Notes
   - Lens coating validation required additional enum constraint
   - Added index range check (1.5-1.9) per specs
   EOF
   ```

2. **Commit work:**
   ```bash
   # Stage changes
   git add .

   # Commit with checkpoint reference
   git commit -m "feat(optics_core): implement lens model [W6.2]

   - Add Lens model with type, index, coating fields
   - Validation for coating options and index range
   - Unit tests for all lens types (single/bifocal/progressive)

   Checkpoint: W6.2 ‚úÖ"
   ```

3. **Push to remote (if applicable):**
   ```bash
   git push origin main
   ```

### 13.3 Session History Template

**File:** `claude_history/session_YYYYMMDD.md`

```markdown
# Development Session ‚Äî YYYY-MM-DD

## Session Info
- **Date:** 2025-10-08
- **Duration:** 2 hours
- **Sprint:** POC Week 6
- **AI Agent:** Claude Sonnet 4.5

---

## Completed Tasks

- ‚úÖ Task description
  - File: path/to/file.py
  - Lines changed: +150 -20
  - Tests: tests/unit/test_file.py (5 tests, all PASS)

---

## Checkpoints

| Checkpoint | Status | Details |
|------------|--------|---------|
| W6.1 | ‚úÖ PASS | Prescription model tests pass |
| W6.2 | ‚úÖ PASS | Lens model tests pass |
| W6.3 | ‚è≥ Next | Manufacturing order (pending) |

---

## Next Session Tasks

1. [ ] Implement optics.manufacturing.order
2. [ ] Run Checkpoint W6.3
3. [ ] Start optics_core views if W6.3 passes

---

## Blockers

- None

---

## Notes & Learnings

- Lens coating enum required CHECK constraint in Odoo
- Index range validation: 1.5-1.9 (common optical indices)
- Progressive lens type needs Add field validation

---

## Git Commits

- `a3f2d1e` feat(optics_core): implement prescription model [W6.1]
- `b4e5f2a` feat(optics_core): implement lens model [W6.2]
```

### 13.4 Error Recovery Protocol

**When checkpoint fails, follow this protocol:**

1. **Analyze failure:**
   ```bash
   # Run with verbose output
   pytest tests/unit/test_prescription.py -vv

   # Check logs
   tail -100 logs/app.log | grep ERROR
   ```

2. **Check if regression:**
   ```bash
   # Run all previously passing tests
   pytest tests/unit/ -k "not prescription"

   # If other tests now fail ‚Üí ROLLBACK
   git log --oneline -5
   git reset --hard HEAD~1  # Rollback last commit
   ```

3. **Fix root cause:**
   - Edit code (NOT tests) to fix issue
   - Do NOT modify passing tests to make them fail
   - Re-run full test suite (not just failed tests)

4. **Re-run full test suite:**
   ```bash
   pytest tests/unit/ -v

   # All tests should PASS
   ```

5. **If 3 consecutive failures:**
   - **Escalate to human**
   - Create detailed issue report:
     ```markdown
     ## ‚ùå Checkpoint W6.1 Failed (3 attempts)

     **Test:** tests/unit/test_prescription.py::test_sph_range
     **Error:** AssertionError: -25 not in valid Sph range (-20, +20)

     **Attempts:**
     1. Fixed Sph validation ‚Üí test_cyl_validation failed
     2. Fixed Cyl validation ‚Üí test_sph_range failed again
     3. Tried different approach ‚Üí same error

     **Root Cause Hypothesis:**
     - Sph range validation logic incorrect (models/prescription.py:67)
     - Test data generator creating invalid prescriptions?

     **Action Needed:**
     Human review of Sph validation logic and test fixtures.
     ```

### 13.5 Auto-Rollback Triggers

**Automatically rollback (git reset) if:**

1. **Regression detected:**
   - Previously passing tests now fail
   - Action: `git reset --hard HEAD~1`

2. **Coverage drops >5%:**
   ```bash
   # Before commit
   pytest --cov=kkt_adapter --cov-report=term | grep TOTAL
   # Coverage: 82%

   # After commit
   pytest --cov=kkt_adapter --cov-report=term | grep TOTAL
   # Coverage: 75%  (dropped 7% ‚Üí ROLLBACK)
   ```

3. **Linter errors increase:**
   ```bash
   # Before: 0 errors
   # After: 15 errors ‚Üí ROLLBACK
   ```

### 13.6 Code Stability Zones

**Frozen after POC (do NOT refactor without explicit approval):**

- SQLite schema (`bootstrap/kkt_adapter_skeleton/schema.sql`)
- Hybrid Logical Clock implementation (`kkt_adapter/app/hlc.py`)
- Circuit Breaker configuration (`config.toml` ¬ßbuffer.*)
- FFD 1.2 fiscal document structure

**Refactorable during MVP:**

- API endpoint names (for consistency)
- UI components (–æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º indicators)
- Prometheus metric names (if Grafana needs changes)
- Internal function names (non-public API)

**Rule:** If AI wants to refactor frozen code, create issue + ask human approval first.

### 13.7 Context Preservation Checklist

**Before ending session, ensure:**

- [ ] Session history updated (`claude_history/session_YYYYMMDD.md`)
- [ ] All changes committed with checkpoint reference
- [ ] Last checkpoint passed (verified with pytest)
- [ ] No uncommitted changes (`git status` clean)
- [ ] Next tasks documented clearly
- [ ] Blockers (if any) escalated to human

**Before starting session, ensure:**

- [ ] Read last session history
- [ ] Environment verified (`make verify-env`)
- [ ] Last checkpoint re-run (to verify state)
- [ ] If checkpoint fails ‚Üí escalate, do NOT proceed

---

## 14. Code Freeze Points & Refactoring Policy

### 14.1 Frozen Components (After POC Sign-Off)

**Components below are FROZEN after POC passes. Do NOT modify without human approval.**

| Component | File(s) | Reason |
|-----------|---------|--------|
| **SQLite Schema** | `bootstrap/kkt_adapter_skeleton/schema.sql` | Migration complexity, data durability |
| **HLC Implementation** | `kkt_adapter/app/hlc.py` | Timestamp ordering critical for conflict resolution |
| **Circuit Breaker Params** | `config.toml` (buffer.*) | Tuned during POC testing |
| **FFD 1.2 Structure** | Fiscal doc JSON schema | 54-–§–ó compliance |
| **Prometheus Metrics** | Metric names/labels | Grafana dashboards depend on them |

**If refactoring needed:**
1. Create GitHub issue with detailed justification
2. Wait for human approval
3. Create migration script (for DB changes)
4. Update all dependent code/tests
5. Run full regression test suite

### 14.2 Refactorable Components (During MVP)

**Safe to refactor without approval:**

- API endpoint paths (update docs)
- Internal function names (non-public API)
- UI component structure
- Variable names (maintain readability)
- Test helper functions

**Best practice:** Still document refactoring in commit message.

---

**ü§ñ For AI Agents:** This handoff protocol ensures continuity across sessions. Always follow ¬ß13.1-13.2 when starting/ending work.
