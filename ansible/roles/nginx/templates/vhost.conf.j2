# Virtual host for {{ item.server_name }}
# Generated by Ansible - DO NOT EDIT MANUALLY

upstream backend_{{ item.server_name | replace('.', '_') }} {
    server {{ item.proxy_pass | regex_replace('^https?://', '') }};
    keepalive 32;
}

server {
    listen {{ item.listen_port }};
    server_name {{ item.server_name }};

    # Logging
    access_log /var/log/nginx/{{ item.server_name }}_access.log main;
    error_log /var/log/nginx/{{ item.server_name }}_error.log;

    # Client settings
    client_max_body_size {{ nginx_client_max_body_size }};

{% for location in item.locations %}
    location {{ location.path }} {
        include snippets/proxy-params.conf;
{% if location.proxy_settings is defined %}
{% for setting in location.proxy_settings %}
        {{ setting }};
{% endfor %}
{% endif %}
        proxy_pass {{ item.proxy_pass }};
    }
{% endfor %}

    # Health check endpoint
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
