#!/bin/bash
# PostgreSQL backup script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e

BACKUP_DIR="{{ backup_path }}/postgresql"
RETENTION_DAYS={{ backup_retention_days }}
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup
{% for db in postgresql_databases %}
pg_dump {{ db.name }} | gzip > "${BACKUP_DIR}/{{ db.name }}_${DATE}.sql.gz"
{% endfor %}

# Remove old backups
find "${BACKUP_DIR}" -name "*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# Log completion
echo "$(date): Backup completed successfully" >> "${BACKUP_DIR}/backup.log"
