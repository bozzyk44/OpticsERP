# Promtail configuration for OpticsERP
# Collects logs from Docker containers
# Generated by Ansible - DO NOT EDIT MANUALLY

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Docker container logs
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Only keep containers with specific names
      - source_labels: ['__meta_docker_container_name']
        regex: '/(odoo|opticserp_odoo|opticserp_celery|opticserp_flower|opticserp_redis|opticserp_postgresql|kkt_adapter|prometheus|grafana|loki).*'
        action: keep

      # Extract container name as label
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container

      # Extract compose service name
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service

      # Extract compose project
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: project

      # Add environment label
      - source_labels: []
        target_label: environment
        replacement: '{{ deployment_env }}'

      # Add host label
      - source_labels: []
        target_label: host
        replacement: '{{ ansible_host }}'

    pipeline_stages:
      # Parse JSON logs (Odoo outputs JSON logs)
      - json:
          expressions:
            level: level
            message: message
            logger: name
            timestamp: timestamp

      # Extract log level for non-JSON logs
      - regex:
          expression: '(?P<level>DEBUG|INFO|WARNING|ERROR|CRITICAL|WARN)'

      # Normalize log level label
      - labels:
          level:

      # Add timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - '2006-01-02 15:04:05,000'
            - '2006-01-02T15:04:05.000Z'

      # Output final log line
      - output:
          source: message
