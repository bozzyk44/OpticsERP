---
- name: Fix Nginx WebSocket configuration for Odoo
  hosts: odoo_servers
  become: true

  tasks:
    - name: Backup current Nginx configuration
      copy:
        src: /etc/nginx/sites-available/194.87.235.33.conf
        dest: /etc/nginx/sites-available/194.87.235.33.conf.backup
        remote_src: yes
      become: yes

    - name: Add WebSocket map directive to nginx.conf
      blockinfile:
        path: /etc/nginx/nginx.conf
        marker: "# {mark} ANSIBLE MANAGED BLOCK - WebSocket map"
        insertafter: "http {"
        block: |2
              # WebSocket connection upgrade map
              map $http_upgrade $connection_upgrade {
                  default upgrade;
                  '' close;
              }
      become: yes

    - name: Create updated Nginx configuration with WebSocket support
      copy:
        dest: /etc/nginx/sites-available/194.87.235.33.conf
        content: |
          # Virtual host for 194.87.235.33
          # Updated with PROPER WebSocket support for Odoo 17
          # Fix: Using $connection_upgrade map instead of static "upgrade"

          upstream backend_odoo {
              server localhost:8069;
              keepalive 32;
          }

          upstream backend_odoo_longpolling {
              server localhost:8072;
              keepalive 32;
          }

          # HTTP to HTTPS redirect (commented out, enable when SSL is ready)
          # server {
          #     listen 80;
          #     server_name 194.87.235.33;
          #     return 301 https://$server_name$request_uri;
          # }

          server {
              listen 80;
              server_name 194.87.235.33;

              # Logging
              access_log /var/log/nginx/194.87.235.33_access.log;
              error_log /var/log/nginx/194.87.235.33_error.log;

              # Client settings
              client_max_body_size 100M;
              proxy_read_timeout 720s;
              proxy_connect_timeout 720s;
              proxy_send_timeout 720s;

              # WebSocket location
              location /websocket {
                  proxy_pass http://backend_odoo_longpolling;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_read_timeout 3600s;
                  proxy_send_timeout 3600s;
                  proxy_buffering off;
              }

              # Longpolling (legacy)
              location /longpolling {
                  proxy_pass http://backend_odoo_longpolling;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_read_timeout 3600s;
                  proxy_send_timeout 3600s;
                  proxy_buffering off;
              }

              # Main Odoo application
              location / {
                  proxy_pass http://backend_odoo;
                  proxy_http_version 1.1;
                  proxy_redirect off;
                  proxy_set_header Host $host;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
              }

              # Health check endpoint
              location /nginx-health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
          }
        owner: root
        group: root
        mode: '0644'
      become: yes

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      become: yes

    - name: Display Nginx test result
      debug:
        msg: "{{ nginx_test.stderr_lines }}"

    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded
      become: yes
      when: nginx_test.rc == 0

    - name: Wait for Nginx to reload
      pause:
        seconds: 2

    - name: Check Nginx status
      systemd:
        name: nginx
      register: nginx_status
      become: yes

    - name: Display success message
      debug:
        msg: |
          ✅ Nginx WebSocket configuration FIXED!

          Root cause: Connection header was hardcoded to "upgrade" instead of using map directive

          Changes applied:
            - ✅ Added map $http_upgrade $connection_upgrade to nginx.conf
            - ✅ Changed Connection header from "upgrade" to $connection_upgrade
            - ✅ Added proxy_http_version 1.1 (required for WebSocket)
            - ✅ Added proxy_buffering off (important for WebSocket)
            - ✅ /websocket location → localhost:8072
            - ✅ /longpolling location → localhost:8072

          Nginx status: {{ nginx_status.status.ActiveState }}

          The WebSocket "Connection lost" issue should NOW be resolved!
