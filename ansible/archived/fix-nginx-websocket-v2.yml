---
- name: Fix Nginx WebSocket configuration (SAFE METHOD)
  hosts: odoo_servers
  become: true

  tasks:
    - name: Backup nginx.conf
      copy:
        src: /etc/nginx/nginx.conf
        dest: /etc/nginx/nginx.conf.backup-websocket
        remote_src: yes
      become: yes

    - name: Check if map directive already exists
      shell: grep -q "map.*http_upgrade.*connection_upgrade" /etc/nginx/nginx.conf
      register: map_exists
      failed_when: false
      changed_when: false
      become: yes

    - name: Add WebSocket map directive after http {
      shell: |
        sudo sed -i '/^http {/a\    # WebSocket connection upgrade map\n    map $http_upgrade $connection_upgrade {\n        default upgrade;\n        '"'"''"'"' close;\n    }\n' /etc/nginx/nginx.conf
      become: yes
      when: map_exists.rc != 0

    - name: Backup current site configuration
      copy:
        src: /etc/nginx/sites-available/194.87.235.33.conf
        dest: /etc/nginx/sites-available/194.87.235.33.conf.backup-v2
        remote_src: yes
      become: yes

    - name: Create updated site configuration with proper WebSocket headers
      copy:
        dest: /etc/nginx/sites-available/194.87.235.33.conf
        content: |
          # Virtual host for 194.87.235.33
          # Updated with PROPER WebSocket support for Odoo 17
          # Using $connection_upgrade variable from nginx.conf map

          upstream backend_odoo {
              server localhost:8069;
              keepalive 32;
          }

          upstream backend_odoo_longpolling {
              server localhost:8072;
              keepalive 32;
          }

          server {
              listen 80;
              server_name 194.87.235.33;

              # Logging
              access_log /var/log/nginx/194.87.235.33_access.log;
              error_log /var/log/nginx/194.87.235.33_error.log;

              # Client settings
              client_max_body_size 100M;
              proxy_read_timeout 720s;
              proxy_connect_timeout 720s;
              proxy_send_timeout 720s;

              # WebSocket location
              location /websocket {
                  proxy_pass http://backend_odoo_longpolling;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_read_timeout 3600s;
                  proxy_send_timeout 3600s;
                  proxy_buffering off;
              }

              # Longpolling (legacy)
              location /longpolling {
                  proxy_pass http://backend_odoo_longpolling;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_read_timeout 3600s;
                  proxy_send_timeout 3600s;
                  proxy_buffering off;
              }

              # Main Odoo application
              location / {
                  proxy_pass http://backend_odoo;
                  proxy_http_version 1.1;
                  proxy_redirect off;
                  proxy_set_header Host $host;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
              }

              # Health check endpoint
              location /nginx-health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
          }
        owner: root
        group: root
        mode: '0644'
      become: yes

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      become: yes
      failed_when: nginx_test.rc != 0

    - name: Display Nginx test result
      debug:
        msg: "{{ nginx_test.stderr_lines }}"

    - name: Reload Nginx (NOT restart!)
      systemd:
        name: nginx
        state: reloaded
      become: yes
      when: nginx_test.rc == 0

    - name: Wait for Nginx to process reload
      pause:
        seconds: 3

    - name: Check Nginx status
      systemd:
        name: nginx
      register: nginx_status
      become: yes

    - name: Display final status
      debug:
        msg: |
          âœ… WebSocket fix applied successfully!

          Nginx status: {{ nginx_status.status.ActiveState }}

          Changes:
            - Added map $http_upgrade $connection_upgrade to nginx.conf
            - Updated all WebSocket locations to use $connection_upgrade
            - Added proxy_http_version 1.1 (required for WebSocket)
            - Added proxy_buffering off for WebSocket locations

          Please test WebSocket connection in Odoo!

    - name: ROLLBACK INSTRUCTIONS (if needed)
      debug:
        msg: |
          If Nginx fails, restore from backups:
            sudo cp /etc/nginx/nginx.conf.backup-websocket /etc/nginx/nginx.conf
            sudo cp /etc/nginx/sites-available/194.87.235.33.conf.backup-v2 /etc/nginx/sites-available/194.87.235.33.conf
            sudo systemctl restart nginx
