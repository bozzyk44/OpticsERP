---
- name: Add Origin header to WebSocket proxy
  hosts: odoo_servers
  become: true

  tasks:
    - name: Update Nginx WebSocket configuration with Origin header
      copy:
        dest: /etc/nginx/sites-available/194.87.235.33.conf
        content: |
          # Virtual host for 194.87.235.33
          # WebSocket configuration with Origin header passthrough

          upstream backend_odoo {
              server localhost:8069;
              keepalive 32;
          }

          upstream backend_odoo_longpolling {
              server localhost:8072;
              keepalive 32;
          }

          server {
              listen 80;
              server_name 194.87.235.33;

              # Logging
              access_log /var/log/nginx/194.87.235.33_access.log;
              error_log /var/log/nginx/194.87.235.33_error.log;

              # Client settings
              client_max_body_size 100M;
              proxy_read_timeout 720s;
              proxy_connect_timeout 720s;
              proxy_send_timeout 720s;

              # WebSocket location
              location /websocket {
                  proxy_pass http://backend_odoo_longpolling;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;
                  proxy_set_header Host $host;
                  proxy_set_header Origin $http_origin;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_read_timeout 3600s;
                  proxy_send_timeout 3600s;
                  proxy_buffering off;
              }

              # Longpolling (legacy)
              location /longpolling {
                  proxy_pass http://backend_odoo_longpolling;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;
                  proxy_set_header Host $host;
                  proxy_set_header Origin $http_origin;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_read_timeout 3600s;
                  proxy_send_timeout 3600s;
                  proxy_buffering off;
              }

              # Main Odoo application
              location / {
                  proxy_pass http://backend_odoo;
                  proxy_http_version 1.1;
                  proxy_redirect off;
                  proxy_set_header Host $host;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Real-IP $remote_addr;
              }

              # Health check endpoint
              location /nginx-health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
          }
        owner: root
        group: root
        mode: '0644'
      become: yes

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      become: yes

    - name: Display test result
      debug:
        msg: "{{ nginx_test.stderr_lines }}"

    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded
      become: yes
      when: nginx_test.rc == 0

    - name: Test WebSocket with Origin header
      shell: |
        curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" \
             -H "Sec-WebSocket-Version: 13" -H "Sec-WebSocket-Key: test" \
             -H "Origin: http://194.87.235.33" \
             http://localhost/websocket?version=17.0-3
      register: ws_test_with_origin
      become: yes
      failed_when: false
      timeout: 5

    - name: Display test result
      debug:
        msg: "{{ ws_test_with_origin.stdout_lines }}"

    - name: Final status
      debug:
        msg: |
          âœ… Added Origin header passthrough!

          Changes:
            - Added proxy_set_header Host $host
            - Added proxy_set_header Origin $http_origin

          Test result above should show improved response.
          Next: Test in browser at http://194.87.235.33
