## 2.1 Функциональные требования (F, MoSCoW)

**Приоритеты:** F1 — Must, F2 — Must, F3 — Must, F4 — Should, F5 — Should, **F6 — Must (офлайн-режим)**.

**POS‑потоки (обязательно):** скидки/купоны; частичная оплата/предоплата; аннулирование чека; возврат по чеку; раздельные ставки НДС; правила округления.

**ФФД:** 1.2. **Электронный чек:** email и SMS.

1. **POS и 54‑ФЗ**: продажа/возврат, X/Z‑отчёты, корректные теги ФФД, электронный чек.
2. **Оптика‑доменные сущности**: рецепты (Sph, Cyl, Axis, PD, Add, Prism), линзы (тип/индекс/покрытие), заказы на изготовление (workflow, SLA).
3. **Номенклатура и остатки**: единые SKU/варианты, импорт Excel, локации складов, инвентаризация.
4. **Финансы по точкам**: кассовые счета, переводы, списания, отчёты.
5. **Отчётность**: валовая прибыль (GP) + прибыль по точкам, POS‑аналитика (средний чек, возвраты, скидки).
6. **Офлайн-режим (Must)**:
   - Автономная работа кассы при обрыве связи с Odoo/ОФД (≥8 часов)
   - Локальный буфер чеков (SQLite, ≥200 записей, FIFO)
   - Двухфазная фискализация (локальный чек + отложенная отправка в ОФД)
   - Автоматическая синхронизация при восстановлении связи
   - Локальный кэш каталога (1000 товаров, обновление раз в час)
   - UI-индикация статуса связи и заполнения буфера
   - Блокировка продаж при переполнении буфера (100%)
   - Алерты при критичной заполненности (80%, 90%, 100%)

## 2.2 Нефункциональные требования (NF)

**Производительность и масштаб**
- **SLO печати чека:** P95 ≤ **7 с** (от нажатия «Оплатить» до печати, **независимо от связи с ОФД**).
- **SLO синхронизации офлайн-буфера:** 200 чеков ≤ **10 мин** после восстановления связи.
- **Throughput синхронизации:** ≥ **20 чеков/мин** из буфера (P50), ≥ **15 чеков/мин** (P95).
- **Импорт данных:** **10k строк ≤ 2 мин** (превью + upsert), отчёт GP формируется ≤ **30 с**.
- **Одновременные кассы:** **N = 1–2** на точку (пилот), масштаб 20 точек (40 касс).

**Надёжность и доступность**
- **Бизнес-доступность кассы:** ≥ **99.5%** (касса работает, независимо от связи с ОФД/Odoo).
- **Системная доступность ОФД:** мониторинг, но НЕ входит в error budget (офлайн-режим покрывает).
- **Ретраи:** доля чеков с повторной отправкой ≤ **0.5%**; **дубликаты чеков = 0** (идемпотентность по `receipt_id`).
- **Офлайн-буфер:**
  - Ёмкость ≥ **200 чеков** (FIFO), персистентность в SQLite
  - **100% доставка** чеков из буфера (допустимо ≤1% с ручной эскалацией в DLQ)
  - Алерт при заполнении ≥80% (160 чеков), блокировка продаж при 100%
  - Автоочистка успешно синхронизированных чеков через **7 дней**
  - Журнал событий буфера доступен в UI (последние 100 операций)
- **Автономность адаптера ККТ:**
  - Heartbeat к Odoo каждые **30 с**, автоматический переход в автономный режим при сбое
  - Локальный кэш 1000 товаров + цены (обновление раз в час при наличии связи)
  - Fallback-логика: кэш → Odoo (timeout 2с) → ручной ввод кассиром

**Восстановление и бэкапы**
- **RTO:** ≤ **1 час**; **RPO:** ≤ **24 часа**.
- Бэкапы БД ежедневно (хранение ≥ **14 дней**), еженедельная проверка восстановления.
- **Бэкап офлайн-буферов:** включается в общий бэкап кассовых терминалов (SQLite-файлы).

**Безопасность (RBAC) и аудит**
- **Матрица ролей (фрагмент):**

| Роль | Продажи/возврат | X/Z | Цены/скидки | Импорт каталога | Счета по точкам | Отчёты GP | Пользователи/права | Настройка ККТ | **Офлайн-буфер** |
|---|---|---|---|---|---|---|---|---|---|
| Кассир | ✅ | ✅ X / ❌ Z | Скидки по лимиту ✅ / цены ❌ | ❌ | Просмотр остатков ✅ | Базовые ✅ | ❌ | ❌ | Просмотр статуса ✅ |
| Менеджер/Супервизор | ✅ | ✅ X/Z | Цены/скидки в лимитах ✅ | ❌ | Переводы ✅ | Расширенные ✅ | ❌ | ❌ | Просмотр + ручная синхронизация ✅ |
| Бухгалтер | ❌ | Просмотр ✅ | Политики цен ✅ | ✅ | Настройка счетов/переводы ✅ | Полные ✅ | ❌ | ❌ | Просмотр логов ✅ |
| Администратор | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | Полный доступ + DLQ ✅ |

- **Политика хранения аудита:** логи POS‑операций, изменения цен/скидок, импорты/миграции и события ККТ хранятся **90 дней** (онлайн ≥ 30 дней, архив ≥ 60 дней), с защитой от модификации.
- **Аудит офлайн-событий:** каждое переключение online↔offline, события буфера (добавление/синхронизация/переполнение), изменения в DLQ.

## 2.3 Правовые/регуляторные

- **54‑ФЗ (ст. 4.3, 5):** корректная фискализация и отчётность; соответствие ФФД 1.2.
- **Офлайн-режим и 54-ФЗ:**
  - Допустимость печати чека без мгновенной отправки в ОФД (при технических сбоях связи)
  - Обязательная отправка в ОФД в течение **30 дней** после печати чека
  - Уведомление ОФД о восстановлении связи
  - Ссылки: 54-ФЗ ст. 4.3 п.6, Приказ ФНС №ММВ-7-20/229@
- **ФН (фискальный накопитель):**
  - Алерт "До конца ФН <100 чеков" (за 3-5 дней до переполнения)
  - Процедура замены ФН с синхронизацией офлайн-буфера
  - Блокировка продаж при переполнении ФН (автоматическая)
- Персональные данные в заказах (минимизация; согласие при e‑чеке).
- Маркировка (опционально): Честный Знак для включённых групп.

## 2.4 Источники данных и интеграции

- **ККТ/ОФД**: драйвер/облако; **обязательная поддержка офлайн-режима** (буферизация запросов).
- **Адаптер ККТ**: автономный сервис с SQLite-буфером, heartbeat к Odoo, локальный кэш каталога.
- **Поставщики**: Excel/CSV прайсы, остатки, каталоги → `connector_b`.
- **Мастерские**: заказы на изготовление (статусы через API/файл).
- **NTP-серверы**: синхронизация времени кассовых терминалов (обязательно для корректных timestamp чеков).

## 2.5 POC — цели и допущения

Цель: подтвердить техническую реализуемость и оценить риски до старта основного объёма.

### Входные критерии (Entry)
- Поднято стендовое окружение (Odoo 17, БД, адаптер ККТ, тестовые интеграции).
- Доступно **реальное устройство ККТ** (модель/версия ФФД 1.2 зафиксированы) и эмулятор.
- **Настроен офлайн-буфер:** SQLite на стенде, ёмкость ≥200 записей, FIFO-логика.
- **Эмуляция обрыва связи:** возможность программного отключения сети/ОФД на стенде.
- Настроены ставки НДС, способы оплаты (нал, безнал, эквайринг), типы скидок.
- Подготовлены тестовые датасеты: ≥ **10 000 строк** каталога/остатков; доля дубликатов **2–5%**, доля преднамеренных ошибок **1–3%** (битые EAN, пустые SKU, неверные VAT/валюта).
- Определён базовый профиль маппинга для 1 поставщика.
- **NTP-синхронизация настроена** (drift <1с на стенде).

### Выходные критерии (Exit)
- Достигнуты метрики успеха по каждому POC (см. ниже); составлен отчёт с числовыми результатами.
- Все сценарии помечены как **пройдено/провалено** с ссылкой на логи и артефакты.
- Сформирован список рисков и дефектов с приоритетами (Go/No‑Go для MVP).
- **POC-4 (длительный офлайн) обязательно пройден** — критичное требование для перехода к MVP.

### Артефакты POC
- Тестовые датасеты (каталоги/остатки) с описанием состава и долей дубликатов/ошибок.
- Профиль(и) маппинга, тест‑кейсы и чек‑листы.
- Журналы адаптера ККТ и Odoo (сырые и агрегированные), выгрузка отчёта с метриками (PDF/MD).
- **Отчёт POC-4:** логи офлайн-буфера (SQLite dump), таймлайн событий, метрики синхронизации.

### POC‑1: ККТ интеграция
- **Объём проверок:** наличный/безналичный расчёт, эквайринг, офлайн‑буфер, потеря связи, повторная отправка, идемпотентность.
- **Набор сценариев:** продажа, возврат, отказ печати, обрыв сети во время фискализации, восстановление и автоповтор, попытка двойной отправки (дубликаты = 0).
- **Обязательное требование:** тест не только на эмуляторе, но и на **реальном устройстве ККТ**.
- **Метрики успеха:**
  - P95 время печати/фискализации ≤ **7 с**; доля чеков с ретраями ≤ **0,5%**.
  - 100% чеков в эмуляторе с корректными полями ФФД; на реальном устройстве — серия ≥ **50 операций** без дубликатов.

### POC‑2: Импорт Excel
- **Набор сценариев:** импорты с кейсами **несоответствия НДС/валюты**, конфликтов **SKU/EAN**, отсутствующих обязательных полей, неверных типов данных; превью и upsert; откат при ошибках.
- **Метрики успеха:**
  - Время импорта **10k строк ≤ 2 мин**; отчёт об ошибках со строками‑примерами.
  - Корректное выявление дубликатов и конфликтов (правила разрешения задокументированы).
  - При провале — состояние каталога неизменно; лог и отчёт доступны из UI.

### POC-5: Split-brain и ложные срабатывания (НОВЫЙ, КРИТИЧНЫЙ)

**Цель:** Проверить устойчивость к ошибочной детекции offline-режима и частичной деградации сети

**Набор сценариев:**

1. **Ложный offline (ОФД работает, Odoo нет):**
   - Блокировать Odoo firewall-правилом (`iptables -A OUTPUT -d odoo.example.com -j DROP`)
   - Heartbeat к Odoo не проходит → адаптер переходит в degraded-режим
   - **Проверка:**
     - Чеки отправляются в ОФД (синхронно) ✅
     - События для Odoo буферизируются локально (SQLite) ✅
     - UI показывает статус "Degraded" (жёлтый индикатор) ✅
   - Восстановить связь (`iptables -D OUTPUT -d odoo.example.com -j DROP`)
   - **Проверка:** события синхронизируются с Odoo ≤5 мин ✅

2. **Частичная деградация сети (высокая латентность):**
   - Эмуляция 5-секундной задержки до ОФД:
     ```bash
     tc qdisc add dev eth0 root netem delay 5000ms
     ```
   - **Проверка:**
     - Адаптер НЕ переходит в offline (использует таймауты 10с) ✅
     - Чеки отправляются медленнее (5-6с вместо 1с), но синхронно ✅
     - UI показывает латентность (tooltip: "Медленная связь с ОФД") ✅
   - Удалить задержку: `tc qdisc del dev eth0 root`
   - **Проверка:** латентность нормализуется ≤1 мин ✅

3. **Oscillating network (flapping):**
   - Связь обрывается каждые 30 секунд на 10 секунд (скрипт-эмулятор)
   - **Проверка:**
     - Адаптер НЕ мечется между online/offline (hysteresis) ✅
     - Используется окно стабильности: **3 успешных ping подряд** для перехода в online ✅
     - Минимальное время в одном режиме: **90 секунд** ✅
   - **Логика hysteresis:**
     ```python
     STABLE_THRESHOLD = 3  # Подряд успешных проверок
     MIN_STATE_DURATION = 90  # Секунд
     
     if current_state == "online" and failures >= STABLE_THRESHOLD:
         if time_in_state >= MIN_STATE_DURATION:
             transition_to("offline")
     ```

4. **Split-brain (адаптер считает себя offline, но ОФД доступен):**
   - Firewall блокирует heartbeat к Odoo, но ОФД доступен
   - Адаптер в degraded, но отправляет в ОФД
   - **Проверка:**
     - Нет рассинхронизации между ОФД и Odoo ✅
     - После восстановления heartbeat: все события Odoo получены ✅
     - Порядок чеков сохранён (по Hybrid Logical Clock) ✅

5. **Конкурентная синхронизация (два процесса одновременно):**
   - Администратор вызывает `/v1/kkt/buffer/sync`
   - Одновременно фоновый worker запускает плановую синхронизацию
   - **Проверка:**
     - Один процесс получает блокировку, второй получает HTTP 409 ✅
     - Нет дубликатов отправок в ОФД ✅
     - Логи содержат `sync_lock_acquired` и `sync_lock_conflict` ✅

**Метрики успеха (POC-5):**
- ✅ Hysteresis предотвращает flapping (минимум 90с в одном режиме)
- ✅ Нет рассинхронизации между ОФД и Odoo при split-brain
- ✅ События из degraded-периода доставлены в Odoo после восстановления (100%)
- ✅ Distributed lock предотвращает конкурентную синхронизацию
- ✅ Латентность корректно детектируется и не вызывает переход в offline

**Критерий Go/No-Go:**
- Если **любая** метрика POC-5 не достигнута → **No-Go для MVP**
- Обязательна доработка логики детекции offline/degraded перед продолжением

### POC-4: Длительный офлайн-режим (КРИТИЧНЫЙ)

**Цель:** Подтвердить работоспособность кассы при длительном (≥8 часов) обрыве связи с ОФД/Odoo.

**Набор сценариев:**
1. **Базовый офлайн (8 часов):**
   - Эмуляция обрыва связи с ОФД (программное отключение сети)
   - Работа кассы: 50+ продаж (mix: наличные/безнал/эквайринг)
   - Все чеки печатаются локально, сохраняются в буфер (SQLite)
   - Проверка: буфер содержит 50+ записей, каждая с уникальным receipt_id

2. **Восстановление и синхронизация:**
   - Восстановление связи с ОФД
   - Автоматическая синхронизация буфера (фоновый процесс)
   - Метрика: 50 чеков отправлены за ≤ **5 мин** (P50), ≤ **10 мин** (P95)
   - Проверка в ОФД: все чеки получены, порядок сохранен (по timestamp)

3. **Переполнение буфера:**
   - Накопление 200+ чеков (до лимита)
   - Попытка 201-й продажи → блокировка кассы
   - Алерт P1 администратору + уведомление кассира
   - Ручная/автоматическая экстренная синхронизация

4. **Конфликт времени:**
   - Эмуляция рассинхронизации времени ККТ (drift +10 мин)
   - Проверка NTP-коррекции при восстановлении связи
   - Верификация: все чеки имеют корректный серверный timestamp

5. **Падение адаптера ККТ во время офлайна:**
   - Обрыв связи → накопление 20 чеков в буфере
   - Перезапуск контейнера адаптера
   - Проверка: буфер восстановлен из SQLite, все 20 чеков на месте
   - Восстановление связи → успешная синхронизация

6. **Офлайн + изменение цен:**
   - Обрыв связи → 10 чеков в буфере
   - Попытка импорта новых цен из админки Odoo
   - Проверка: импорт блокируется (алерт "Несинхронизированный буфер")
   - Восстановление связи → синхронизация → импорт разрешен

**Метрики успеха (POC-4):**
- ✅ Касса работает ≥8 часов без связи с ОФД/Odoo
- ✅ 100% чеков сохранены в офлайн-буфере (SQLite)
- ✅ 100% чеков доставлены в ОФД после восстановления связи
- ✅ Порядок чеков сохранен (проверка timestamp в ОФД)
- ✅ Блокировка продаж при переполнении буфера (201 чек)
- ✅ RTO восстановления адаптера ≤ **2 мин**
- ✅ Синхронизация 200 чеков ≤ **10 мин**
- ✅ Не более **1%** чеков требуют ручного вмешательства (DLQ)
- ✅ NTP-коррекция работает (drift исправлен при восстановлении)
- ✅ Алерты срабатывают корректно (80%, 90%, 100% буфера)

**Критерий Go/No-Go:**
- Если **любая** метрика POC-4 не достигнута → **No-Go для MVP**
- Обязательна доработка офлайн-архитектуры перед продолжением

## 2.6 Приёмочные сценарии (UAT)

### Матрица трассировки F→UAT (обновлено)
| F | Описание | UAT |
|---|---|---|
| F1 | POS и 54‑ФЗ | UAT‑01, UAT‑02, UAT‑05, UAT‑06, UAT-08, UAT-09 |
| F2 | Доменные сущности оптики | UAT‑01 |
| F3 | Номенклатура и остатки (импорт) | UAT‑03, UAT‑07 |
| F4 | Финансы по точкам | UAT‑02, UAT‑04 |
| F5 | Отчётность (GP/по точкам) | UAT‑04 |
| F6 | Офлайн-режим | UAT-08, UAT-09, UAT-10, UAT-11 |

### Сценарии (позитивные)
- **UAT‑01:** кассир оформляет продажу «оправа + линзы» → чек фискализируется, печатается, электронный чек отправлен (F1, F2).
- **UAT‑02:** возврат по чеку → корректные суммы и теги; кассовый счёт точки скорректирован (F1, F4).
- **UAT‑03:** импорт прайса/остатков → новые/обновлённые позиции созданы; ошибки показаны в отчёте (F3).
- **UAT‑04:** отчёт GP и прибыль по точкам за неделю сходятся с контрольным расчётом (F4, F5).

### Сценарии (негативные)
- **UAT‑05:** отказ фискализации на ККТ → срабатывает автоповтор; чек не дублируется (идемпотентность), оператор уведомлён (F1).
- **UAT‑06:** частичная оплата/частичный возврат → корректные теги/суммы, соблюдены ограничения скидок (F1).
- **UAT‑07:** сбой импорта → выполнен откат; лог ошибок доступен; повторная загрузка проходит успешно (F3).

### Сценарии (офлайн-режим)

**UAT-08: Базовая продажа в офлайне (позитивный)**
- Предусловие: обрыв связи с ОФД (эмуляция)
- Действие: кассир оформляет продажу «солнцезащитные очки» (2500 руб, наличные)
- Ожидание:
  - Чек печатается локально (≤7 с)
  - Чек сохраняется в офлайн-буфере (SQLite)
  - UI показывает индикацию "Офлайн" (красный/желтый статус)
  - Клиент получает товар и чек
- Постусловие: восстановление связи → чек автоматически отправлен в ОФД ≤10 мин
- Покрытие: F1, F6

**UAT-09: Длительный офлайн с множественными продажами (позитивный)**
- Предусловие: обрыв связи с ОФД, пустой буфер
- Действие: касса работает 4 часа, 30 продаж (mix: наличные/карта)
- Ожидание:
  - Все 30 чеков печатаются локально
  - Буфер содержит 30 записей (проверка через UI)
  - UI показывает "Офлайн 4ч 00мин, в буфере 30 чеков"
  - Алерт НЕ срабатывает (30 < 160, порог 80%)
- Постусловие: восстановление связи → 100% чеков доставлены в ОФД
- Покрытие: F6

**UAT-10b: Частичная синхронизация при переполнении (негативный)**
- Предусловие: буфер 200/200 чеков, связь с ОФД восстановлена
- Действие: начинается синхронизация, после 50 чеков связь обрывается снова
- Ожидание:
  - 50 чеков помечены `synced` и удалены из буфера
  - 150 чеков остаются в статусе `pending`
  - Буфер: 150/200 (75%), продажи **РАЗБЛОКИРОВАНЫ** ✅
  - При повторном обрыве: накопление до 200 снова блокирует
  - Идемпотентность: повторная синхронизация не создаёт дубликаты
- Постусловие: все 200 чеков синхронизированы после полного восстановления связи
- Покрытие: идемпотентность синхронизации, graceful degradation, FIFO-порядок

**UAT-10c: ОФД недоступен при переполнении (негативный, катастрофический)**
- Предусловие: буфер 200/200 чеков, касса заблокирована
- Действие: попытка экстренной синхронизации, ОФД возвращает 503 Service Unavailable
- Ожидание:
  - Алерт **P1**: "ОФД недоступен, буфер переполнен, продажи заблокированы"
  - Процедура эскалации: контакт с провайдером ОФД (SLA <30 мин)
  - **Circuit Breaker** размыкается → прекращаются попытки отправки (защита ресурсов)
  - UI кассира: "Касса временно недоступна. Ожидание восстановления связи с налоговой"
- Временное решение (администратор, <15 мин):
  - Hot-patch: увеличение ёмкости буфера до 300 чеков
  - Или: переключение на резервный ОФД (если есть контракт)
- Резервный канал (если недоступен основной):
  - Отправка через backup ОФД или мобильный интернет (4G/LTE модем)
- Постусловие: ОФД восстановлен, буфер синхронизирован, продажи разблокированы
- Покрытие: катастрофический сценарий, процедуры эскалации, Circuit Breaker, резервный канал

**UAT-11: Падение адаптера ККТ с восстановлением из буфера (негативный)**
- Предусловие: офлайн-режим, в буфере 15 чеков
- Действие: перезапуск контейнера адаптера ККТ (эмуляция сбоя)
- Ожидание:
  - Адаптер стартует ≤2 мин
  - Буфер восстанавливается из SQLite (15 чеков на месте)
  - Heartbeat к Odoo восстанавливается ≤30 с
  - Касса продолжает работать в офлайн-режиме
- Постусловие: восстановление связи с ОФД → все 15 чеков синхронизированы
- Покрытие: F6

### Расширенные сценарии офлайн-режима (детализация UAT-05)

**UAT-05a: Таймаут ККТ**
- Действие: ККТ не отвечает (эмуляция таймаута 10с)
- Ожидание: автоповтор 3 раза → чек в офлайн-буфер, алерт оператору

**UAT-05b: ФН заполнен**
- Действие: ККТ возвращает ошибку "ФН переполнен"
- Ожидание: касса блокируется, алерт P1, инструкция кассиру "Замените ФН"

**UAT-05c: Сеть недоступна**
- Действие: обрыв сети (ping до ОФД не проходит)
- Ожидание: чек печатается локально, сохраняется в буфер, без алерта (штатная ситуация)

**UAT-05d: ОФД недоступен (503)**
- Действие: ОФД возвращает 503 Service Unavailable
- Ожидание: чек в офлайн-буфер, фоновая переотправка каждые 5 мин

### Критерии приёмки
- **Покрытие:** 100% Must‑требований (F1-F6) сопоставлены минимум с одним UAT; трассировка F→UAT оформлена в таблице выше.
- **Порог успеха:** ≥ 95% UAT пройдено; 0 блокирующих дефектов; ≤ 3 несущественных (minor) на этап.
- **Обязательные офлайн-UAT:** UAT-08, UAT-09, UAT-10, UAT-11 должны быть пройдены на 100% для перехода к пилоту.
- **Время операций:** печать чека P95 ≤ 7 с (независимо от связи); импорт 10k строк ≤ 2 мин; формирование отчёта GP ≤ 30 с; синхронизация 200 чеков ≤ 10 мин.
- **Надёжность:** доля чеков с ретраями ≤ 0,5%; дубликатов чеков = 0; 100% доставка из офлайн-буфера.
- **Откат и аудит:** при ошибке импорта состояние каталога неизменно; журнал/отчёт ошибок сохраняется и доступен из UI.

## 2.7 Карта зависимостей (обновлено)

- **POS** зависит от: адаптера ККТ (автономный), офлайн-буфера (SQLite), каталога товаров, ставок НДС.
- **Офлайн-буфер** зависит от: SQLite (персистентность), NTP (синхронизация времени), мониторинга (алерты).
- **Адаптер ККТ** зависит от: heartbeat к Odoo (30с), локального кэша (1000 SKU), устройства ККТ (USB/TCP).
- **GP/по точкам** зависит от: корректных Cost/Price, переводов и списаний, синхронизированных офлайн-буферов.
- **Заказ на изготовление** зависит от: рецепта, наличия линз/материалов, доступности Odoo.

## 2.10 Процедура замены ФН (детальная)

### Предусловия
- Алерт "До конца ФН <100 чеков" сработал за 3-5 дней
- Новый ФН приобретён и зарегистрирован в налоговой
- Техник на месте (нельзя делать удалённо)
- **КРИТИЧНО:** касса должна быть в online-режиме или буфер пуст

### Процедура (30-45 мин)

**Шаг 1: Принудительная синхронизация буфера (приоритет!)**
```bash
# Проверка статуса буфера
curl https://pos-001.local/v1/kkt/buffer/status
# Если current_queued > 0 → принудительная синхронизация

# Синхронизация ВСЕХ чеков (обязательно!)
curl -X POST https://pos-001.local/v1/kkt/buffer/sync?force=true

# Ожидание завершения (проверка каждые 30с)
while true; do
  status=$(curl -s https://pos-001.local/v1/kkt/buffer/status | jq '.current_queued')
  echo "Буфер: $status чеков"
  if [ "$status" -eq "0" ]; then
    echo "✓ Буфер пуст, можно продолжать"
    break
  fi
  sleep 30
done
```

**Шаг 2: Блокировка новых продаж**
```python
# В интерфейсе администратора или через API
curl -X POST https://pos-001.local/v1/pos/maintenance \
  -d '{"reason": "Замена ФН", "estimated_duration_minutes": 45}'

# Кассиры видят: "Касса на обслуживании. Замена фискального накопителя. Ожидайте ~45 мин"
```

**Шаг 3: Закрытие смены (Z-отчёт) — ОБЯЗАТЕЛЬНО по 54-ФЗ**
```
1. В UI кассы или через API:
   POST /v1/kkt/z_report
   
2. Печать Z-отчёта на старом ФН
   - Проверка: все чеки с начала смены зафискализированы
   - Сохранить распечатанный Z-отчёт (архив 5 лет)
   
3. Проверка в журнале:
   SELECT COUNT(*) FROM receipts 
   WHERE created_at >= current_shift_start 
     AND status != 'synced'
   -- Должно быть 0!
```

**Шаг 4: Физическая замена ФН**
```
1. Обесточивание ККТ (выключить питание)
2. Открыть корпус ККТ (инструкция производителя)
3. Извлечь старый ФН:
   - Записать серийный номер старого ФН в журнал
   - Поместить в антистатический пакет
   - Маркировать: "ФН №______, снят __.__._____, хранить до __.__._____ (5 лет)"
4. Установить новый ФН:
   - Проверить: серийный номер совпадает с регистрационными документами
   - Надёжно зафиксировать в слоте
5. Закрыть корпус ККТ
6. Включить питание
7. Дождаться загрузки (индикаторы ККТ должны гореть зелёным)
```

**Шаг 5: Перерегистрация ККТ в налоговой**
```
1. Отчёт о перерегистрации:
   - Через личный кабинет налогоплательщика (nalog.gov.ru)
   - Или через ОФД (если поддерживается)
   
2. Данные для отчёта:
   - Заводской номер ККТ
   - Серийный номер нового ФН
   - Дата и время перерегистрации
   - Причина замены: "Исчерпание ресурса ФН" или "Плановая замена"
   
3. Получение подтверждения:
   - РНМ (регистрационный номер) новой регистрации
   - Сохранить в журнале + электронный архив
   
4. Обновление данных ФН в адаптере ККТ:
   # config.toml
   [kkt]
   fn_serial = "9999123456"  # Новый ФН
   registration_number = "0001234567890123"  # Новый РНМ
   
   # Перезапуск адаптера
   docker restart kkt-adapter
```

**Шаг 6: Тестовый чек (обязательная проверка)**
```bash
# Тестовая продажа минимальной суммы
curl -X POST https://pos-001.local/v1/kkt/receipt \
  -H "Idempotency-Key: $(uuidgen)" \
  -d '{
    "pos_id": "POS-001",
    "type": "sale",
    "items": [{"sku": "TEST001", "name": "Тест", "qty": 1, "price": 1.00, "vat": "20%"}],
    "payments": [{"method": "cash", "amount": 1.00}]
  }'

# Проверка ответа:
# 1. status = "printed" (чек напечатан)
# 2. fiscal_doc.fn = новый серийный номер ФН
# 3. fiscal_doc.fd = "1" (первый фискальный документ на новом ФН)

# Немедленный возврат тестового чека
curl -X POST https://pos-001.local/v1/kkt/receipt \
  -H "Idempotency-Key: $(uuidgen)" \
  -d '{
    "pos_id": "POS-001",
    "type": "refund",
    "original_receipt_id": "<id из предыдущего ответа>",
    "items": [{"sku": "TEST001", "name": "Тест", "qty": 1, "price": 1.00, "vat": "20%"}],
    "payments": [{"method": "cash", "amount": 1.00}]
  }'

# Проверка: чек возврата зафискализирован на новом ФН
```

**Шаг 7: Разблокировка продаж**
```python
# Снятие режима обслуживания
curl -X DELETE https://pos-001.local/v1/pos/maintenance

# Уведомление кассиров (автоматическое или ручное):
# "Касса готова к работе. Замена ФН завершена успешно."

# Проверка статуса
curl https://pos-001.local/v1/health
# Ожидание: {"status": "healthy", "fn_serial": "9999123456", "fn_capacity_left": 1100000}
```

### Rollback (если что-то пошло не так)

**Случай 1: Новый ФН не активировался**
```
Симптомы: ККТ не распознаёт новый ФН, ошибка "ФН не найден"

Действия:
1. Обесточить ККТ
2. Проверить контакты ФН (переустановить)
3. Если не помогло → вернуть старый ФН:
   - Установить старый ФН обратно
   - Включить ККТ
   - Проверка: тестовый чек печатается
4. Новый ФН → брак или несовместимость:
   - Замена на другой ФН (резервный)
   - Обращение к поставщику ФН (возврат/замена)
```

**Случай 2: Потеряны чеки (буфер не синхронизировался до замены)**
```
Симптомы: после замены ФН в буфере остались несинхронизированные чеки

Действия:
1. Восстановление из backup SQLite:
   # Ежедневный snapshot буфера
   docker exec kkt-adapter cp /app/data/buffer.db /backup/buffer_$(date +%Y%m%d).db
   
2. Восстановление:
   docker stop kkt-adapter
   docker cp /backup/buffer_20251005.db kkt-adapter:/app/data/buffer.db
   docker start kkt-adapter
   
3. Принудительная синхронизация:
   curl -X POST https://pos-001.local/v1/kkt/buffer/sync?force=true
   
4. Проверка: все чеки доставлены в ОФД
```

**Случай 3: Рассинхронизация с налоговой**
```
Симптомы: ОФД не принимает чеки с новым ФН, ошибка "ККТ не зарегистрирована"

Действия:
1. Проверка регистрации в личном кабинете nalog.gov.ru
2. Если регистрация не прошла:
   - Повторная отправка отчёта о перерегистрации
   - Ожидание подтверждения (обычно 1-2 часа)
3. Если срочно нужно работать:
   - Временно: печать чеков без отправки в ОФД (54-ФЗ разрешает до 30 дней)
   - Чеки накапливаются в буфере
   - После регистрации → массовая синхронизация
4. Обращение в техподдержку ОФД (если проблема >4 часов)
```

### Документирование

**Обязательные записи в журнале:**
```
Дата: __.__._____ 
Время: __:__ - __:__ (начало - конец)
POS ID: POS-___
Техник: _____________ (ФИО, подпись)

Старый ФН:
- Серийный номер: __________________
- Дата установки: __.__.____
- Количество чеков: _______
- Причина замены: [ ] Исчерпание ресурса [ ] Плановая [ ] Неисправность

Новый ФН:
- Серийный номер: __________________
- РНМ: __________________
- Дата активации: __.__.____
- Тестовый чек: [ ] Успешно [ ] Провал (описать)

Синхронизация буфера:
- Чеков до замены: _______
- Чеков после замены: 0 (обязательно!)
- Время синхронизации: _____ мин

Особые отметки:
________________________________
________________________________

Подпись техника: ______________
Подпись администратора: ______________
```

**Архивация старого ФН:**
- Физическое хранение: сейф/архивное помещение (5 лет по 54-ФЗ)
- Маркировка: "ФН №______, POS-___, снят __.__._____, хранить до __.__._____ "
- Электронный журнал: Excel/база данных с историей всех ФН

**Обновление мониторинга:**
```bash
# Обновление метрик Prometheus
curl -X POST https://grafana.example.com/api/annotations \
  -d '{
    "text": "Замена ФН на POS-001. Старый: 1234567890, Новый: 9999123456",
    "tags": ["fn_replacement", "pos-001"],
    "time": '$(date +%s)'000
  }'

# Сброс счётчика capacity (новый ФН)
fn_capacity_total{pos_id="POS-001"} = 1100000
fn_capacity_used{pos_id="POS-001"} = 0
```

### Планирование следующей замены

**Прогноз исчерпания ФН:**
```python
def calculate_fn_lifetime(pos_id):
    # Средняя нагрузка за последний месяц
    avg_receipts_per_day = get_avg_receipts(pos_id, days=30)
    
    # Текущая ёмкость ФН
    fn_capacity_left = get_fn_capacity(pos_id)
    
    # Прогноз (дни до исчерпания)
    days_left = fn_capacity_left / avg_receipts_per_day
    
    # Дата рекомендуемой замены (за 2 недели до исчерпания)
    recommended_date = date.today() + timedelta(days=days_left - 14)
    
    # Алерт если <30 дней
    if days_left < 30:
        send_alert(f"POS-{pos_id}: ФН исчерпается через {days_left} дней. "
                   f"Рекомендуемая замена: {recommended_date}", level='P2')
    
    return recommended_date

# Запуск еженедельно (cron)
for pos in all_pos:
    calculate_fn_lifetime(pos.id)
```
- **Процедура экстренной синхронизации буфера при переполнении** (резервный канал? приоритетная очередь?)
- **Срок хранения чеков в ОФД:** достаточно ли 30 дней для случаев длительного офлайна? (согласовать с ОФД)

## 2.11 Приложение A: Спецификация тестовых датасетов

### Каталог товаров (10k строк) — детальная структура

**Формат файла:** Excel (.xlsx) или CSV (UTF-8 with BOM)

**Обязательные колонки:**
```
sku | name | category | brand | ean | price | vat | cost | mark_required | supplier_code
```

**Пример корректных записей:**
```csv
SKU001,Оправа Ray-Ban RB5228,Оправы,Ray-Ban,8053672000000,12500.00,20%,8000.00,false,RB-5228-2000
SKU002,Линзы Essilor 1.6 AR,Линзы,Essilor,3000000000001,4500.00,20%,2800.00,false,ESS-16-AR
SKU003,Солнцезащитные Polaroid PLD2053,Солнцезащитные,Polaroid,716736098234,3200.00,20%,2000.00,false,PLD-2053-S
```

**Внедрённые ошибки (контролируемые, для валидации импорта):**

| Тип ошибки | Доля | Количество (из 10k) | Примеры |
|------------|------|---------------------|---------|
| **Дубликаты SKU** | 2% | 200 строк | SKU001 встречается 2 раза с разными ценами |
| **Битые EAN** | 0.5% | 50 строк | `INVALID_EAN`, `12345` (< 13 символов), `abc123def4567` (буквы) |
| **Пустые обязательные поля** | 0.3% | 30 строк | `name=""`, `price=NULL`, `sku=""` |
| **Неверный VAT** | 0.2% | 20 строк | `vat="25%"` (недопустимо), `vat="НДС"`, `vat=NULL` |
| **Несоответствие валюты** | 0.1% | 10 строк | `price="3200 USD"` вместо числа, `price="три тысячи"` |
| **Конфликт цены cost > price** | 0.5% | 50 строк | `price=1000, cost=1200` (убыточная продажа) |
| **Дубликаты EAN (разные SKU)** | 0.4% | 40 строк | SKU001 и SKU005 имеют одинаковый EAN |

**Генерация датасета (Python-скрипт):**
```python
import pandas as pd
import random
import uuid

def generate_test_catalog(size=10000, error_rate=0.03):
    """
    Генерация тестового каталога с контролируемыми ошибками
    
    Args:
        size: количество строк
        error_rate: доля ошибочных строк (3% = 300 из 10k)
    """
    data = []
    categories = ['Оправы', 'Линзы', 'Солнцезащитные', 'Аксессуары', 'Уход']
    brands = ['Ray-Ban', 'Essilor', 'Polaroid', 'Guess', 'Oakley', 'NoName']
    vat_rates = ['20%', '10%', '0%', 'no_vat']
    
    # Генерация базовых корректных записей
    for i in range(size):
        sku = f"SKU{i+1:05d}"
        name = f"{random.choice(brands)} {random.choice(categories)} #{i+1}"
        category = random.choice(categories)
        brand = random.choice(brands)
        ean = f"{random.randint(1000000000000, 9999999999999)}"
        price = round(random.uniform(500, 15000), 2)
        vat = random.choice(vat_rates)
        cost = round(price * random.uniform(0.5, 0.8), 2)  # Маржа 20-50%
        
        data.append({
            'sku': sku,
            'name': name,
            'category': category,
            'brand': brand,
            'ean': ean,
            'price': price,
            'vat': vat,
            'cost': cost,
            'mark_required': False,
            'supplier_code': f"{brand[:3].upper()}-{i+1}"
        })
    
    df = pd.DataFrame(data)
    
    # Внедрение ошибок
    error_count = int(size * error_rate)
    
    # 1. Дубликаты SKU (2%)
    dup_indices = random.sample(range(size), int(size * 0.02))
    for idx in dup_indices:
        dup_row = df.iloc[idx].copy()
        dup_row['price'] = dup_row['price'] * 1.1  # Цена отличается на 10%
        df = pd.concat([df, pd.DataFrame([dup_row])], ignore_index=True)
    
    # 2. Битые EAN (0.5%)
    invalid_ean_indices = random.sample(range(size), int(size * 0.005))
    for idx in invalid_ean_indices:
        df.at[idx, 'ean'] = random.choice(['INVALID_EAN', '12345', 'abc123def4567', ''])
    
    # 3. Пустые обязательные поля (0.3%)
    empty_field_indices = random.sample(range(size), int(size * 0.003))
    for idx in empty_field_indices:
        field = random.choice(['name', 'price', 'sku'])
        df.at[idx, field] = '' if field != 'price' else None
    
    # 4. Неверный VAT (0.2%)
    invalid_vat_indices = random.sample(range(size), int(size * 0.002))
    for idx in invalid_vat_indices:
        df.at[idx, 'vat'] = random.choice(['25%', 'НДС', '', None])
    
    # 5. Конфликт cost > price (0.5%)
    cost_conflict_indices = random.sample(range(size), int(size * 0.005))
    for idx in cost_conflict_indices:
        df.at[idx, 'cost'] = df.at[idx, 'price'] * 1.2  # Убыток 20%
    
    return df

# Генерация и сохранение
catalog = generate_test_catalog(size=10000, error_rate=0.03)
catalog.to_excel('test_catalog_10k.xlsx', index=False, engine='openpyxl')
catalog.to_csv('test_catalog_10k.csv', index=False, encoding='utf-8-sig')  # BOM для Excel

print(f"Сгенерировано {len(catalog)} строк")
print(f"Ожидаемые дубликаты SKU: ~200")
print(f"Ожидаемые ошибки: ~300 ({len(catalog) * 0.03:.0f})")
```

### Прайс-листы поставщиков (3 × 5k строк)

**Особенности каждого поставщика (для тестирования маппинга):**

**Поставщик A (OptMarket):**
```
Формат: XLSX
Кодировка: UTF-8
Колонки: Артикул | Наименование | Цена | НДС | Остаток
Особенности:
- SKU совпадает с нашим на 80% (4000 из 5000)
- 20% новых товаров (1000 шт) — для тестирования создания
- Цены отличаются на ±10% от текущих
```

**Поставщик B (LensSupply):**
```
Формат: CSV
Кодировка: Windows-1251 (!)  ← тест кодировок
Разделитель: ;  ← не запятая!
Колонки: КодТовара;Товар;Цена закупки;Налог;Наличие
Особенности:
- Названия колонок на русском
- Цены БЕЗ НДС (требуется расчёт)
- Остаток: текстом ("Много", "Мало", "Нет") → нужен парсинг
```

**Поставщик C (FrameStore):**
```
Формат: CSV
Кодировка: UTF-8
Разделитель: , (стандарт)
Колонки: sku | product_name | retail_price | wholesale_price | vat_rate | stock
Особенности:
- Две цены (розничная и оптовая) → используем оптовую
- vat_rate в формате "0.20" (число) вместо "20%" (текст)
- stock: число, но отрицательные значения → ошибка данных
```

### Конфликтные сценарии для импорта

**Сценарий 1: Конфликт цен (один SKU у двух поставщиков)**
```
OptMarket:  SKU001 | Оправа Ray-Ban RB5228 | 12500 руб
LensSupply: SKU001 | Оправа Ray-Ban RB5228 | 11800 руб

Правило разрешения: минимальная цена (11800 руб)
Логирование: "SKU001: выбрана цена LensSupply (11800) вместо OptMarket (12500)"
```

**Сценарий 2: Изменение цены >20%**
```
Текущая цена: 5000 руб
Новая цена (импорт): 6500 руб (+30%)

Действие: блокировка импорта + алерт
Сообщение: "SKU002: изменение цены >20% (5000 → 6500). Требуется ручное подтверждение"
```

**Сценарий 3: Изменение VAT**
```
Текущий НДС: 20%
Новый НДС (импорт): 10%

Действие: блокировка импорта + алерт P2
Сообщение: "SKU003: изменение ставки НДС (20% → 10%). Требуется подтверждение бухгалтера"
Причина: изменение НДС влияет на отчётность, требует ручной проверки
```

**Сценарий 4: Новый товар без EAN**
```
Импорт: SKU999 | Новая модель оправы | price=8000 | ean="" (пустой)

Действие: создание товара с предупреждением
Логирование: "SKU999: создан без EAN. Требуется ручное заполнение для продаж"
UI: товар помечен иконкой ⚠️ "EAN отсутствует"
```

### Отчёты об ошибках импорта (пагинация + фильтры)

**Структура отчёта:**
```json
{
  "import_id": "550e8400-e29b-41d4-a716-446655440000",
  "profile_id": "OptMarket",
  "started_at": "2025-10-05T14:00:00Z",
  "completed_at": "2025-10-05T14:02:15Z",
  "duration_seconds": 135,
  "summary": {
    "total_rows": 10000,
    "processed": 9700,
    "created": 1000,
    "updated": 8700,
    "skipped": 300,
    "errors": 300
  },
  "errors": [
    {
      "row": 42,
      "level": "ERROR",
      "type": "duplicate_sku",
      "field": "sku",
      "value": "SKU001",
      "message": "Дубликат SKU: SKU001 встречается 2 раза в файле (строки 42, 1567)",
      "resolution": "Использована первая запись, вторая пропущена"
    },
    {
      "row": 105,
      "level": "ERROR",
      "type": "invalid_ean",
      "field": "ean",
      "value": "INVALID_EAN",
      "message": "Неверный формат EAN: INVALID_EAN (ожидается 13 цифр)",
      "resolution": "Товар создан без EAN, требуется ручное исправление"
    },
    {
      "row": 256,
      "level": "WARNING",
      "type": "price_change_threshold",
      "field": "price",
      "value": "6500",
      "old_value": "5000",
      "message": "Изменение цены >20%: 5000 → 6500 (+30%)",
      "resolution": "Импорт заблокирован, требуется подтверждение"
    }
  ]
}
```

**API для просмотра логов (с фильтрами):**
```
GET /v1/connector/import/{import_id}/logs?page=1&limit=100&level=ERROR&type=duplicate_sku

Ответ: пагинированный список ошибок
- Фильтры: level (INFO/WARNING/ERROR), type (код ошибки), field (название поля)
- Сортировка: по row (номер строки) или severity
- Экспорт: CSV/Excel для передачи поставщику
```

## 2.10 Приоритизация конфликтов для офлайн-режима

### Разрешение конфликтов при синхронизации

| Конфликт | Приоритет | Решение |
|----------|-----------|---------|
| Локальное время ККТ vs серверное (NTP) | Серверное | NTP-синхронизация обязательна; при drift >5с — алерт; timestamp чеков корректируется при синхронизации |
| Чек напечатан, но не фискализирован в ОФД | Локальный чек | Повторная отправка с original timestamp; идемпотентность по receipt_id |
| Изменение цен во время офлайна | Блокировка | Импорт цен блокируется при несинхронизированном буфере (≥1 чек); алерт "Дождитесь синхронизации" |
| Два чека с одинаковым receipt_id | Невозможно | UUID v4 + локальный счетчик + timestamp → гарантия уникальности |
| Переполнение буфера во время синхронизации | Приоритет старых | FIFO-синхронизация; новые чеки блокируются до освобождения места |
| Конфликт остатков (продажа в офлайне + списание в Odoo) | Физическая продажа | Приоритет локальным продажам; корректировка остатков post-factum; алерт бухгалтеру |

## 2.11 Приложение A: Спецификация тестовых датасетов

### Каталог товаров (10k строк) — детальная структура

**Формат файла:** Excel (.xlsx) или CSV (UTF-8 with BOM)

**Обязательные колонки:**
```
sku | name | category | brand | ean | price | vat | cost | mark_required | supplier_code
```

### POC‑3: Заказ на изготовление

- **Набор сценариев:** создание рецепта, связка с продажей, статусы **In Work → Ready**, печать бланка и штрихкод, отгрузка.
- **Метрики успеха:** полный цикл на демо‑данных; поиск заказа по штрихкоду ≤ **2 с**; корректные статусы и документы.

### POC-5: Split-brain и ложные срабатывания (НОВЫЙ, КРИТИЧНЫЙ)

**Цель:** Проверить устойчивость к ошибочной детекции offline-режима и частичной деградации сети

**Набор сценариев:**

1. **Ложный offline (ОФД работает, Odoo нет):**
   - Блокировать Odoo firewall-правилом (`iptables -A OUTPUT -d odoo.example.com -j DROP`)
   - Heartbeat к Odoo не проходит → адаптер переходит в degraded-режим
   - **Проверка:**
     - Чеки отправляются в ОФД (синхронно) ✅
     - События для Odoo буферизируются локально (SQLite) ✅
     - UI показывает статус "Degraded" (жёлтый индикатор) ✅
   - Восстановить связь (`iptables -D OUTPUT -d odoo.example.com -j DROP`)
   - **Проверка:** события синхронизируются с Odoo ≤5 мин ✅

2. **Частичная деградация сети (высокая латентность):**
   - Эмуляция 5-секундной задержки до ОФД:
     ```bash
     tc qdisc add dev eth0 root netem delay 5000ms
     ```
   - **Проверка:**
     - Адаптер НЕ переходит в offline (использует таймауты 10с) ✅
     - Чеки отправляются медленнее (5-6с вместо 1с), но синхронно ✅
     - UI показывает латентность (tooltip: "Медленная связь с ОФД") ✅
   - Удалить задержку: `tc qdisc del dev eth0 root`
   - **Проверка:** латентность нормализуется ≤1 мин ✅

3. **Oscillating network (flapping):**
   - Связь обрывается каждые 30 секунд на 10 секунд (скрипт-эмулятор)
   - **Проверка:**
     - Адаптер НЕ мечется между online/offline (hysteresis) ✅
     - Используется окно стабильности: **3 успешных ping подряд** для перехода в online ✅
     - Минимальное время в одном режиме: **90 секунд** ✅
   - **Логика hysteresis:**
     ```python
     STABLE_THRESHOLD = 3  # Подряд успешных проверок
     MIN_STATE_DURATION = 90  # Секунд
     
     if current_state == "online" and failures >= STABLE_THRESHOLD:
         if time_in_state >= MIN_STATE_DURATION:
             transition_to("offline")
     ```

4. **Split-brain (адаптер считает себя offline, но ОФД доступен):**
   - Firewall блокирует heartbeat к Odoo, но ОФД доступен
   - Адаптер в degraded, но отправляет в ОФД
   - **Проверка:**
     - Нет рассинхронизации между ОФД и Odoo ✅
     - После восстановления heartbeat: все события Odoo получены ✅
     - Порядок чеков сохранён (по Hybrid Logical Clock) ✅

5. **Конкурентная синхронизация (два процесса одновременно):**
   - Администратор вызывает `/v1/kkt/buffer/sync`
   - Одновременно фоновый worker запускает плановую синхронизацию
   - **Проверка:**
     - Один процесс получает блокировку, второй получает HTTP 409 ✅
     - Нет дубликатов отправок в ОФД ✅
     - Логи содержат `sync_lock_acquired` и `sync_lock_conflict` ✅

**Метрики успеха (POC-5):**
- ✅ Hysteresis предотвращает flapping (минимум 90с в одном режиме)
- ✅ Нет рассинхронизации между ОФД и Odoo при split-brain
- ✅ События из degraded-периода доставлены в Odoo после восстановления (100%)
- ✅ Distributed lock предотвращает конкурентную синхронизацию
- ✅ Латентность корректно детектируется и не вызывает переход в offline

**Критерий Go/No-Go:**
- Если **любая** метрика POC-5 не достигнута → **No-Go для MVP**
- Обязательна доработка логики детекции offline/degraded перед продолжением# OpticsERP — 2. Анализ требований и Proof of Concept

> Дополнено: offline-first сценарии, POC-4 (длительный офлайн), расширенные UAT

### Допущения и ограничения
- **ККТ и ФФД:** однотипные модели ККТ на пилоте (указать конкретную модель), **ФФД 1.2**.
- **Связь:** **КРИТИЧНО — регулярные обрывы связи с ОФД (8+ часов)** являются нормой, не исключением; офлайн‑буфер с очередью и ретраями (ёмкость **≥200 чеков**, FIFO, персистентность в SQLite).
- **При переполнении буфера:** касса блокирует новые продажи, алерт P1 владельцу + техподдержке, экстренная синхронизация через резервный канал.
- **Автономность:** адаптер ККТ работает без связи с Odoo (локальный кэш 1000 товаров, heartbeat 30с).
- **Оплата:** поддерживаются наличные, безнал, эквайринг; правила скидок и округления фиксируются централизованно.
- **Данные поставщиков:** прайсы/остатки в Excel/CSV по согласованным шаблонам; обновление не реже 1 раза в неделю (для пилота — по договорённости).
- **Масштаб:** 1–10 точек, 1–5 касс на точку; объёмы тестовых данных см. §2.5 (Entry).

### Глоссарий
- **SKU** — уникальный идентификатор товарной позиции (артикул).
- **EAN** — штрихкод международного формата для идентификации товара.
- **ФФД** — формат фискальных данных, версия протокола обмена с ККТ/ОФД (**1.2**).
- **ОФД** — оператор фискальных данных, принимающий фискальные сообщения от ККТ.
- **ККТ** — контрольно‑кассовая техника (фискальный регистратор/касса).
- **Офлайн-буфер** — локальная SQLite-очередь чеков на кассовом терминале (≥200 записей).
- **Двухфазный коммит** — чек сохраняется локально + печатается (фаза 1), затем отправляется в ОФД (фаза 2).
- **Бизнес-доступность** — касса может принять платеж и напечатать чек (независимо от ОФД).
- **Heartbeat** — проверка связи адаптера ККТ с Odoo (каждые 30с).

### Карта зависимостей (сводка)
- **POS** зависит от: адаптера ККТ (локальный/автономный), **офлайн-буфера**, каталога товаров, ставок НДС.
- **Офлайн-буфер** зависит от: SQLite (персистентность), NTP (синхронизация времени), мониторинга ёмкости.
- **GP/прибыль по точкам** зависит от: корректных Cost/Price, переводов и списаний по кассовым счетам.
- **Заказ на изготовление** зависит от: рецепта и наличия линз/материалов.