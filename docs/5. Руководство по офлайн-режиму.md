# OpticsERP โ 5. ะัะบะพะฒะพะดััะฒะพ ะฟะพ ะพัะปะฐะนะฝ-ัะตะถะธะผั

> **ะะฐะทะฝะฐัะตะฝะธะต:** ะะดะธะฝัะน ะธััะพัะฝะธะบ ะฟัะฐะฒะดั ะฟะพ ะฐััะธัะตะบัััะต, ัะบัะฟะปัะฐัะฐัะธะธ ะธ ััััะฐะฝะตะฝะธั ะฟัะพะฑะปะตะผ ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ.  
> **ะัะดะธัะพัะธั:** ัะฐะทัะฐะฑะพััะธะบะธ, ะฐะดะผะธะฝะธัััะฐัะพัั, ัะตัะฟะพะดะดะตัะถะบะฐ L1/L2.  
> **ะะตััะธั:** 2.0 โข ะะฐัะฐ: 2025-10-07 โข **ะะฑะฝะพะฒะปะตะฝะพ ั ััะตัะพะผ ัะธััะตะผะฝะพะณะพ ะฐะฝะฐะปะธะทะฐ**

---

## 5.1 ะะฒะตะดะตะฝะธะต

### ะะฐัะตะผ ะฝัะถะตะฝ ะพัะปะฐะนะฝ-ัะตะถะธะผ?

ะ ัะตัะธ ะพะฟัะธะบ **ัะตะณัะปััะฝัะต ะพะฑััะฒั ัะฒัะทะธ ั ะะคะ (8+ ัะฐัะพะฒ)** ัะฒะปััััั ะฝะพัะผะพะน, ะฝะต ะธัะบะปััะตะฝะธะตะผ. ะัะปะฐะนะฝ-ัะตะถะธะผ ะณะฐัะฐะฝัะธััะตั:
- **ะะธะทะฝะตั-ะฝะตะฟัะตััะฒะฝะพััั:** ะบะฐััะฐ ัะฐะฑะพัะฐะตั ะดะฐะถะต ะฑะตะท ะธะฝัะตัะฝะตัะฐ (ะฑะธะทะฝะตั-ะดะพัััะฟะฝะพััั โฅ99.5%)
- **ะกะพะพัะฒะตัััะฒะธะต 54-ะคะ:** ะฒัะต ัะตะบะธ ัะธัะบะฐะปะธะทะธัััััั (ะพัะปะพะถะตะฝะฝะพ, ะฝะพ ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ะฒ ัะตัะตะฝะธะต 30 ะดะฝะตะน)
- **ะะฐัะธัะฐ ะฒััััะบะธ:** ะฝะพะปั ะฟะพัะตััะฝะฝัั ะฟัะพะดะฐะถ ะธะท-ะทะฐ ะฟัะพะฑะปะตะผ ัะพ ัะฒัะทัั
- **ะะฐัััะฐะฑะธััะตะผะพััั:** ะฐััะธัะตะบัััะฐ ะฒัะดะตัะถะธะฒะฐะตั ัะพัั ะดะพ 50+ ัะพัะตะบ ะฑะตะท ะธะทะผะตะฝะตะฝะธะน

### ะะปััะตะฒัะต ะฟัะธะฝัะธะฟั

1. **Offline-first:** ะบะฐััะฐ ัะฐะฑะพัะฐะตั ะฐะฒัะพะฝะพะผะฝะพ, ะพะฑะปะฐะบะพ โ ะฒัะพัะธัะฝะพ
2. **ะะฒัััะฐะทะฝะฐั ัะธัะบะฐะปะธะทะฐัะธั:** ะฟะตัะฐัั ะปะพะบะฐะปัะฝะพ โ ะพัะฟัะฐะฒะบะฐ ะฒ ะะคะ ะฐัะธะฝััะพะฝะฝะพ
3. **ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะฐั ะดะพััะฐะฒะบะฐ:** ะบะฐะถะดัะน ัะตะบ ัะฐะฝะพ ะธะปะธ ะฟะพะทะดะฝะพ ะฟะพะฟะฐะดัั ะฒ ะะคะ (100% ัะตัะตะท Circuit Breaker + ัะตััะฐะธ)
4. **Graceful degradation:** ัะธััะตะผะฐ ะดะตะณัะฐะดะธััะตั ะฟะปะฐะฒะฝะพ, ะฑะตะท ัะตะทะบะธั ะพัะบะฐะทะพะฒ
5. **Hybrid Logical Clock:** ะฒัะตะผะตะฝะฝัะต ะผะตัะบะธ ะฝะต ะทะฐะฒะธััั ะพั NTP (ะทะฐัะธัะฐ ะพั ัะฐััะธะฝััะพะฝะธะทะฐัะธะธ ะฒัะตะผะตะฝะธ)
6. **Circuit Breaker:** ะทะฐัะธัะฐ ะพั ะบะฐัะบะฐะดะฝัั ะพัะบะฐะทะพะฒ ะฟัะธ ะฟัะพะฑะปะตะผะฐั ะะคะ
7. **Saga Pattern:** ะบะพััะตะบัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะฐัะฟัะตะดะตะปัะฝะฝัั ััะฐะฝะทะฐะบัะธะน (ะฒะพะทะฒัะฐัั, ะบะพััะตะบัะธัะพะฒะบะธ)


## 5.2 ะััะธัะตะบัััะฐ ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ

### ะะพะผะฟะพะฝะตะฝัั ั ัะปัััะตะฝะธัะผะธ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะะฐััะพะฒัะน ัะตัะผะธะฝะฐะป (Edge Device)       โ
โ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  ะะดะฐะฟัะตั ะะะข (ะฐะฒัะพะฝะพะผะฝัะน ัะตัะฒะธั)  โ โ
โ  โ                                    โ โ
โ  โ  โโโโโโโโโโโโ   โโโโโโโโโโโโโโโโ  โ โ
โ  โ  โ FastAPI  โ   โ    SQLite    โ  โ โ
โ  โ  โ  worker  โโโโบโ ะพัะปะฐะนะฝ-ะฑััะตั โ  โ โ
โ  โ  โ          โ   โ (200 ัะตะบะพะฒ)  โ  โ โ
โ  โ  โ          โ   โ PRAGMA       โ  โ โ
โ  โ  โ          โ   โ synchronous  โ  โ โ
โ  โ  โ          โ   โ =FULL        โ  โ โ
โ  โ  โโโโโโฌโโโโโโ   โโโโโโโโโโโโโโโโ  โ โ
โ  โ       โ                            โ โ
โ  โ       โ Heartbeat 30s (hysteresis) โ โ
โ  โ       โ Circuit Breaker ะดะปั ะะคะ    โ โ
โ  โ       โผ                            โ โ
โ  โ  โโโโโโโโโโโ   โโโโโโโโโโโโโโโโ   โ โ
โ  โ  โ   ะะะข   โ   โะะพะบะฐะปัะฝัะน ะบัั โ   โ โ
โ  โ  โ (ะฟะตัะฐัั)โ   โ(1000 ัะพะฒะฐัะพะฒ)โ   โ โ
โ  โ  โโโโโโโโโโโ   โโโโโโโโโโโโโโโโ   โ โ
โ  โ                                    โ โ
โ  โ  UPS (15 ะผะธะฝ) โโบ Graceful shutdownโ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ           โ                              โ
โ           โ async/queue + Distributed Lockโ
โโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
    โโโโโโโโโโโโโโโโโ
    โ  Odoo Master  โ
    โ  PostgreSQL   โ
    โ  + Event Log  โ
    โโโโโโโโโฌโโโโโโโโ
            โ
            โ Circuit Breaker
            โผ
       โโโโโโโโโโ
       โ  ะะคะ   โ
       โโโโโโโโโโ
```

### ะะตะถะธะผั ัะฐะฑะพัั ะฐะดะฐะฟัะตัะฐ ะะะข (ั hysteresis)

| ะะตะถะธะผ | ะกะฒัะทั ั Odoo | ะกะฒัะทั ั ะะคะ | ะะพะฒะตะดะตะฝะธะต | ะะตัะตัะพะด |
|-------|--------------|-------------|-----------|---------|
| **Online** | โ | โ | ะะพัะผะฐะปัะฝะฐั ัะฐะฑะพัะฐ: ัะตะบะธ ะพัะฟัะฐะฒะปััััั ััะฐะทั ะฒ ะะคะ | 3 ะฝะตัะดะฐัะฝัั ping ะะคะ ะฟะพะดััะด โ Offline |
| **Degraded** | โ | โ | ะะฐะฑะพัะฐ ะธะท ะปะพะบะฐะปัะฝะพะณะพ ะบััะฐ, ะพัะฟัะฐะฒะบะฐ ะฒ ะะคะ, ัะพะฑััะธั ะฑััะตัะธะทะธัััััั ะดะปั Odoo | Heartbeat ะบ Odoo ะฒะพัััะฐะฝะพะฒะปะตะฝ โ Online |
| **Offline** | โ/โ | โ | ะงะตะบะธ ัะพััะฐะฝััััั ะฒ SQLite-ะฑััะตั, ัะพะฝะพะฒะฐั ัะธะฝััะพะฝะธะทะฐัะธั ะฟัะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ | 3 ััะฟะตัะฝัั ping ะะคะ ะฟะพะดััะด + 90ั ะฒ ัะตะบััะตะผ ัะตะถะธะผะต โ Online |

**Hysteresis (ะทะฐัะธัะฐ ะพั flapping):**
- ะะธะฝะธะผะฐะปัะฝะพะต ะฒัะตะผั ะฒ ะพะดะฝะพะผ ัะตะถะธะผะต: **90 ัะตะบัะฝะด**
- ะขัะตะฑัะตััั **3 ััะฟะตัะฝัั ะฟัะพะฒะตัะบะธ ะฟะพะดััะด** ะดะปั ะฟะตัะตัะพะดะฐ ะฒ online
- ะัะตะดะพัะฒัะฐัะฐะตั ะผะตัะฐะฝะธะต ะผะตะถะดั online/offline ะฟัะธ ะฝะตััะฐะฑะธะปัะฝะพะน ัะตัะธ

**ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะบะปััะตะฝะธะต ัะตะถะธะผะพะฒ:**
```python
class NetworkStateManager:
    def __init__(self):
        self.current_state = "online"
        self.state_entry_time = time.time()
        self.consecutive_failures = 0
        self.consecutive_successes = 0
        self.STABLE_THRESHOLD = 3
        self.MIN_STATE_DURATION = 90  # ัะตะบัะฝะด
    
    def check_network(self):
        # ะัะพะฒะตัะบะฐ ัะฒัะทะธ ั ะะคะ
        ofd_available = ping_ofd()
        
        # ะัะพะฒะตัะบะฐ heartbeat ะบ Odoo
        odoo_available = heartbeat_odoo()
        
        # ะะพะณะธะบะฐ ะฟะตัะตัะพะดะพะฒ ั hysteresis
        time_in_state = time.time() - self.state_entry_time
        
        if self.current_state == "online":
            if not ofd_available:
                self.consecutive_failures += 1
                if self.consecutive_failures >= self.STABLE_THRESHOLD and time_in_state >= self.MIN_STATE_DURATION:
                    self.transition_to("offline")
            else:
                self.consecutive_failures = 0
        
        elif self.current_state == "offline":
            if ofd_available:
                self.consecutive_successes += 1
                if self.consecutive_successes >= self.STABLE_THRESHOLD and time_in_state >= self.MIN_STATE_DURATION:
                    self.transition_to("online")
            else:
                self.consecutive_successes = 0
    
    def transition_to(self, new_state):
        logger.info(f"Network state transition: {self.current_state} โ {new_state}")
        self.current_state = new_state
        self.state_entry_time = time.time()
        self.consecutive_failures = 0
        self.consecutive_successes = 0
        
        # ะะตััะธะบะฐ ะดะปั Prometheus
        network_state_gauge.set({"online": 0, "degraded": 1, "offline": 2}[new_state])
```

---

## 5.3 ะัะปะฐะนะฝ-ะฑััะตั (SQLite) โ ัะปัััะตะฝะฝะฐั ะบะพะฝัะธะณััะฐัะธั

### ะกัะตะผะฐ ะฑะฐะทั ะดะฐะฝะฝัั

```sql
-- ะัะฝะพะฒะฝะฐั ัะฐะฑะปะธัะฐ ัะตะบะพะฒ
CREATE TABLE receipts (
  id TEXT PRIMARY KEY,              -- UUIDv4 (receipt_id)
  pos_id TEXT NOT NULL,             -- ะะดะตะฝัะธัะธะบะฐัะพั ะบะฐััั (POS-001)
  created_at INTEGER NOT NULL,      -- Unix timestamp (ัะตะบัะฝะดั)
  hlc_local_time INTEGER NOT NULL,  -- Hybrid Logical Clock: ะปะพะบะฐะปัะฝะพะต ะฒัะตะผั
  hlc_logical_counter INTEGER NOT NULL, -- Hybrid Logical Clock: ัััััะธะบ
  hlc_server_time INTEGER,          -- ะัะธัะฒะฐะธะฒะฐะตััั ะฟัะธ ัะธะฝััะพะฝะธะทะฐัะธะธ ั Odoo
  fiscal_doc TEXT NOT NULL,         -- JSON ั ะดะฐะฝะฝัะผะธ ะคะคะ
  status TEXT NOT NULL DEFAULT 'pending',  -- pending|syncing|synced|failed
  retry_count INTEGER DEFAULT 0,    -- ะะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ ัะธะฝััะพะฝะธะทะฐัะธะธ
  last_error TEXT,                  -- ะะพัะปะตะดะฝัั ะพัะธะฑะบะฐ (ะตัะปะธ ะตััั)
  synced_at INTEGER,                -- Timestamp ััะฟะตัะฝะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ
  CHECK (status IN ('pending', 'syncing', 'synced', 'failed'))
);

CREATE INDEX idx_status ON receipts(status);
CREATE INDEX idx_created_at ON receipts(created_at);
CREATE INDEX idx_pos_status ON receipts(pos_id, status);
CREATE INDEX idx_hlc ON receipts(hlc_server_time, hlc_local_time, hlc_logical_counter);

-- ะขะฐะฑะปะธัะฐ ะดะปั DLQ (Dead Letter Queue)
CREATE TABLE dlq (
  id TEXT PRIMARY KEY,
  original_receipt_id TEXT NOT NULL,
  failed_at INTEGER NOT NULL,
  reason TEXT NOT NULL,
  fiscal_doc TEXT NOT NULL,
  retry_attempts INTEGER NOT NULL,
  last_error TEXT,
  resolved_at INTEGER,              -- ะะพะณะดะฐ ะฑัะป ะพะฑัะฐะฑะพัะฐะฝ ะฒัััะฝัั
  resolved_by TEXT,                 -- ะัะพ ะพะฑัะฐะฑะพัะฐะป (user_id)
  FOREIGN KEY (original_receipt_id) REFERENCES receipts(id)
);

CREATE INDEX idx_dlq_failed_at ON dlq(failed_at);
CREATE INDEX idx_dlq_resolved ON dlq(resolved_at);

-- ะขะฐะฑะปะธัะฐ ัะพะฑััะธะน (ะดะปั Event Sourcing, ะพะฟัะธะพะฝะฐะปัะฝะพ)
CREATE TABLE buffer_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  event_type TEXT NOT NULL,         -- receipt_added|receipt_synced|circuit_opened|...
  receipt_id TEXT,
  timestamp INTEGER NOT NULL,
  metadata TEXT,                    -- JSON ั ะดะพะฟะพะปะฝะธัะตะปัะฝัะผะธ ะดะฐะฝะฝัะผะธ
  CHECK (event_type IN ('receipt_added', 'receipt_synced', 'receipt_failed', 
                        'circuit_opened', 'circuit_closed', 'sync_started', 'sync_completed'))
);

CREATE INDEX idx_events_timestamp ON buffer_events(timestamp);
CREATE INDEX idx_events_type ON buffer_events(event_type);
```

### ะะพะฝัะธะณััะฐัะธั SQLite (ะผะฐะบัะธะผะฐะปัะฝะฐั durability)

**ะะะะขะะงะะ ะดะปั ะทะฐัะธัั ะพั power loss:**

```python
import sqlite3

def init_buffer_db(db_path='/app/data/buffer.db'):
    conn = sqlite3.connect(db_path)
    
    # ะะะะขะะงะะซะ ะฝะฐัััะพะนะบะธ (ะทะฐัะธัะฐ ะพั ะบะพัััะฟัะธะธ ะฟัะธ ะฒะฝะตะทะฐะฟะฝะพะผ ะพัะบะปััะตะฝะธะธ ะฟะธัะฐะฝะธั)
    conn.execute("PRAGMA journal_mode=WAL")        # Write-Ahead Logging
    conn.execute("PRAGMA synchronous=FULL")        # ะะพะปะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั (!!!)
    conn.execute("PRAGMA wal_autocheckpoint=100")  # Checkpoint ะบะฐะถะดัะต 100 ััะฐะฝะทะฐะบัะธะน
    conn.execute("PRAGMA cache_size=-64000")       # 64 MB ะบะตั (ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั)
    conn.execute("PRAGMA foreign_keys=ON")         # ะัะพะฒะตัะบะฐ FK
    conn.execute("PRAGMA temp_store=MEMORY")       # ะัะตะผะตะฝะฝัะต ัะฐะฑะปะธัั ะฒ ะฟะฐะผััะธ
    
    return conn
```

**ะะฑะพัะฝะพะฒะฐะฝะธะต `synchronous=FULL`:**
- ะะฐะถะดะฐั ััะฐะฝะทะฐะบัะธั ะทะฐะฟะธััะฒะฐะตััั ะฝะฐ ะดะธัะบ ะะะะะ ะฟะพะดัะฒะตัะถะดะตะฝะธะตะผ
- ะะฐัะฐะฝัะธั: ะดะฐะถะต ะฟัะธ ะฒะฝะตะทะฐะฟะฝะพะผ ะพัะบะปััะตะฝะธะธ ะฟะธัะฐะฝะธั ะฟะพัะปะตะดะฝะธะน ะฟะพะดัะฒะตัะถะดัะฝะฝัะน ัะตะบ ัะพััะฐะฝัะฝ
- ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั: ~50-100 ัะตะบะพะฒ/ัะตะบ (ะดะพััะฐัะพัะฝะพ ะดะปั ะบะฐััั)
- ะะปััะตัะฝะฐัะธะฒะฐ `NORMAL`: ~200-300 ัะตะบะพะฒ/ัะตะบ, ะฝะพ ัะธัะบ ะฟะพัะตัะธ ะฟะพัะปะตะดะฝะธั 1-5 ัะตะบะพะฒ ะฟัะธ power loss

### ะะพะปะธัะธะบะธ ะธ ะปะธะผะธัั

| ะะฐัะฐะผะตัั | ะะฝะฐัะตะฝะธะต | ะะฑะพัะฝะพะฒะฐะฝะธะต |
|----------|----------|-------------|
| **ะะผะบะพััั ะฑััะตัะฐ** | 200 ัะตะบะพะฒ (FIFO) | ะะพะบััะฒะฐะตั 8ั ัะฐะฑะพัั ะบะฐััั ะฟัะธ ััะตะดะฝะตะน ะฝะฐะณััะทะบะต (25 ัะตะบะพะฒ/ั) |
| **ะะฐะทะผะตั SQLite ัะฐะนะปะฐ** | ~10 MB (ะฟัะธ 200 ัะตะบะฐั) | ะกัะตะดะฝะธะน ัะฐะทะผะตั ัะตะบะฐ ะฒ JSON โ50 KB |
| **ะะตัะตะฝัะธั ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝะฝัั** | 7 ะดะฝะตะน | ะะปั ะดะธะฐะณะฝะพััะธะบะธ ะธะฝัะธะดะตะฝัะพะฒ |
| **ะะตัะตะฝัะธั DLQ** | 90 ะดะฝะตะน | ะกะพะพัะฒะตัััะฒัะตั ะฟะพะปะธัะธะบะต ะฐัะดะธัะฐ (ะะพะบ. 2) |
| **Max retry attempts** | 20 ะฟะพะฟััะพะบ | ะะพัะปะต 20 ะฝะตัะดะฐั โ DLQ ะดะปั ัััะฝะพะน ะพะฑัะฐะฑะพัะบะธ |
| **Initial backoff** | 5 ัะตะบัะฝะด | ะะตัะฒะฐั ะฟะพะฟััะบะฐ ะฟะพะฒัะพัะฐ ัะตัะตะท 5ั |
| **Max backoff** | 5 ะผะธะฝัั | ะะฐะบัะธะผะฐะปัะฝะฐั ะทะฐะดะตัะถะบะฐ ะผะตะถะดั ะฟะพะฟััะบะฐะผะธ |
| **Circuit Breaker threshold** | 5 ะพัะธะฑะพะบ ะฟะพะดััะด | ะะตัะตัะพะด ะฒ OPEN โ ะฟัะตะบัะฐัะตะฝะธะต ะฟะพะฟััะพะบ ะฝะฐ 60ั |

---

## 5.4 ะะฒัััะฐะทะฝะฐั ัะธัะบะฐะปะธะทะฐัะธั (ั Circuit Breaker)

### ะคะฐะทะฐ 1: ะะพะบะฐะปัะฝะพะต ัะพััะฐะฝะตะฝะธะต (ะฒัะตะณะดะฐ ััะฟะตัะฝะฐ)

```python
from circuitbreaker import circuit

def create_receipt_phase1(receipt_data):
    """
    ะคะฐะทะฐ 1: ะปะพะบะฐะปัะฝะฐั โ ะฒัะตะณะดะฐ ััะฟะตัะฝะฐ, ะดะฐะถะต ะฑะตะท ัะตัะธ.
    """
    # 1. ะะตะฝะตัะฐัะธั Hybrid Logical Clock timestamp
    hlc = generate_hlc()
    receipt_id = str(uuid.uuid4())
    
    # 2. ะกะพััะฐะฝะตะฝะธะต ะฒ SQLite (WAL mode, crash-safe)
    buffer_db.execute(
        """INSERT INTO receipts 
           (id, pos_id, created_at, hlc_local_time, hlc_logical_counter, fiscal_doc, status) 
           VALUES (?, ?, ?, ?, ?, ?, 'pending')""",
        (receipt_id, receipt_data['pos_id'], int(time.time()), 
         hlc.local_time, hlc.logical_counter, json.dumps(receipt_data))
    )
    buffer_db.commit()
    
    # 3. ะะตัะฐัั ัะตะบะฐ ะฝะฐ ะะะข (ัะธะฝััะพะฝะฝะพ, ัะฐะนะผะฐัั 10ั)
    try:
        kkt_driver.print_receipt(receipt_data)
        log.info(f"Receipt {receipt_id} printed successfully")
    except TimeoutError:
        # ะะะข ะฝะต ะพัะฒะตัะธะปะฐ, ะฝะพ ัะตะบ ะฒ ะฑััะตัะต โ ะบะฐััะธั ะฟะพะฒัะพัะธั ะฟะตัะฐัั
        log.error(f"ะะะข timeout ะดะปั {receipt_id}, ัะตะบ ะฒ ะฑััะตัะต")
        send_alert(f"ะะะข ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ POS-{receipt_data['pos_id']}", level='P2')
    
    # 4. ะะพะณะธัะพะฒะฐะฝะธะต ัะพะฑััะธั
    buffer_db.execute(
        "INSERT INTO buffer_events (event_type, receipt_id, timestamp, metadata) VALUES (?, ?, ?, ?)",
        ('receipt_added', receipt_id, int(time.time()), json.dumps({'buffer_size': get_buffer_size()}))
    )
    
    return receipt_id

def generate_hlc():
    """ะะตะฝะตัะฐัะธั Hybrid Logical Clock timestamp"""
    global _hlc_counter
    
    current_time = int(time.time())
    
    # ะัะปะธ ะฒัะตะผั ะฝะต ะธะทะผะตะฝะธะปะพัั, ัะฒะตะปะธัะธะฒะฐะตะผ ัััััะธะบ
    if current_time == _last_hlc_time:
        _hlc_counter += 1
    else:
        _hlc_counter = 0
        _last_hlc_time = current_time
    
    return HybridTimestamp(
        local_time=current_time,
        logical_counter=_hlc_counter,
        server_time=None  # ะัะดะตั ะฟัะธัะฒะพะตะฝะพ ะฟัะธ ัะธะฝััะพะฝะธะทะฐัะธะธ
    )
```

### ะคะฐะทะฐ 2: ะัะฟัะฐะฒะบะฐ ะฒ ะะคะ (ั Circuit Breaker)

```python
class OFDCircuitBreaker:
    """
    Circuit Breaker ะดะปั ะทะฐัะธัั ะพั ะบะฐัะบะฐะดะฝัั ะพัะบะฐะทะพะฒ ะฟัะธ ะฟัะพะฑะปะตะผะฐั ะะคะ
    
    ะกะพััะพัะฝะธั:
    - CLOSED: ะฒัะต ะทะฐะฟัะพัั ะธะดัั ะบ ะะคะ
    - OPEN: ะฒัะต ะทะฐะฟัะพัั ะฝะตะผะตะดะปะตะฝะฝะพ fail โ ะฑััะตัะธะทะฐัะธั
    - HALF_OPEN: ะฟัะพะฑะฝัะน ะทะฐะฟัะพั ัะตัะตะท 60ั
    """
    
    @circuit(failure_threshold=5, recovery_timeout=60, expected_exception=(TimeoutError, ConnectionError))
    async def send_receipt(self, receipt):
        response = await ofd_client.post("/receipts", json=receipt, timeout=10)
        return response

ofd_cb = OFDCircuitBreaker()

async def create_receipt_phase2(receipt_id):
    """
    ะคะฐะทะฐ 2: ะพัะฟัะฐะฒะบะฐ ะฒ ะะคะ (ะฐัะธะฝััะพะฝะฝะฐั, best-effort)
    """
    # ะะพะปััะตะฝะธะต ัะตะบะฐ ะธะท ะฑััะตัะฐ
    receipt = buffer_db.execute(
        "SELECT * FROM receipts WHERE id = ? AND status = 'pending'",
        (receipt_id,)
    ).fetchone()
    
    if not receipt:
        return  # ะงะตะบ ัะถะต ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝ ะธะปะธ ะฝะต ะฝะฐะนะดะตะฝ
    
    try:
        # ะัะพะฒะตัะบะฐ Circuit Breaker ะฟะตัะตะด ะฟะพะฟััะบะพะน
        circuit_state = ofd_cb.current_state  # CLOSED/OPEN/HALF_OPEN
        
        if circuit_state == "OPEN":
            log.warning(f"Circuit Breaker OPEN, buffering {receipt_id}")
            return  # ะะต ะฟััะฐะตะผัั ะพัะฟัะฐะฒะธัั, ัะตะบ ะพััะฐัััั ะฒ ะฑััะตัะต
        
        # ะะพะฟััะบะฐ ะพัะฟัะฐะฒะบะธ ะฒ ะะคะ
        fiscal_doc = await ofd_cb.send_receipt(json.loads(receipt['fiscal_doc']))
        
        # ะฃัะฟะตั! ะะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ
        buffer_db.execute(
            """UPDATE receipts 
               SET status='synced', synced_at=?, hlc_server_time=? 
               WHERE id=?""",
            (int(time.time()), get_server_time(), receipt_id)
        )
        buffer_db.commit()
        
        log.info(f"Receipt {receipt_id} synced to OFD: FN={fiscal_doc['fn']}, FD={fiscal_doc['fd']}")
        
    except CircuitBreakerError:
        # Circuit Breaker ะพัะบััั โ ัะตะบ ะพััะฐะฝะตััั ะฒ ะฑััะตัะต
        log.warning(f"Circuit Breaker opened for {receipt_id}, will retry later")
        
    except (TimeoutError, ConnectionError) as e:
        # ะัะธะฑะบะฐ ัะตัะธ โ ัะฒะตะปะธัะธะฒะฐะตะผ retry_count, ะฟัะพะฑัะตะผ ะฟะพะทะถะต
        buffer_db.execute(
            "UPDATE receipts SET retry_count = retry_count + 1, last_error = ? WHERE id = ?",
            (str(e), receipt_id)
        )
        buffer_db.commit()
        
        # ะัะพะฒะตัะบะฐ: ะฝะต ะฟัะตะฒััะตะฝ ะปะธ ะปะธะผะธั ะฟะพะฟััะพะบ?
        if receipt['retry_count'] + 1 >= 20:
            move_to_dlq(receipt_id, reason="max_retries_exceeded")
            send_alert(f"Receipt {receipt_id} moved to DLQ after 20 retries", level='P2')

def move_to_dlq(receipt_id, reason):
    """ะะตัะตะฝะพั ัะตะบะฐ ะฒ Dead Letter Queue ะดะปั ัััะฝะพะน ะพะฑัะฐะฑะพัะบะธ"""
    receipt = buffer_db.execute("SELECT * FROM receipts WHERE id = ?", (receipt_id,)).fetchone()
    
    buffer_db.execute(
        """INSERT INTO dlq (id, original_receipt_id, failed_at, reason, fiscal_doc, retry_attempts, last_error)
           VALUES (?, ?, ?, ?, ?, ?, ?)""",
        (str(uuid.uuid4()), receipt_id, int(time.time()), reason, 
         receipt['fiscal_doc'], receipt['retry_count'], receipt['last_error'])
    )
    
    buffer_db.execute("UPDATE receipts SET status = 'failed' WHERE id = ?", (receipt_id,))
    buffer_db.commit()
    
    log.critical(f"Receipt {receipt_id} moved to DLQ: {reason}")
```

---

## 5.5 Decision Tree ะดะปั ัะตัะฟะพะดะดะตัะถะบะธ L1/L2

### ะคะปะพััะฐัั ะดะธะฐะณะฝะพััะธะบะธ ะฟัะพะฑะปะตะผ ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะฐะปะพะฑะฐ ะบะฐััะธัะฐ: "ะัะพะฑะปะตะผะฐ ั ะบะฐััะพะน" โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
       โโโโโโโโโโโโโโโโโโโโโ
       โ ะะฐะบะฐั ะพัะธะฑะบะฐ?     โ
       โโโโโโโโโฌโโโโโโโโโโโโ
               โ
   โโโโโโโโโโโโโผโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
   โ           โ            โ              โ                โ
   โผ           โผ            โผ              โผ                โผ
"ะััะตั   "ะะฐััะฐ ะฝะต    "ะงะตะบ ะฝะต       "ะะตะดะปะตะฝะฝะพ      "Circuit
ะทะฐะฟะพะปะฝะตะฝ" ะฟัะธะฝะธะผะฐะตั   ะฟะตัะฐัะฐะตััั"   ัะฐะฑะพัะฐะตั"      Breaker
          ะพะฟะปะฐัั"                                   OPEN"
   โ           โ            โ              โ                โ
   โ           โ            โ              โ                โ
   โผ           โผ            โผ              โผ                โผ
[ะัะพัะตะดััะฐ [ะัะพัะตะดััะฐ  [ะัะพัะตะดััะฐ    [ะัะพัะตะดััะฐ      [ะัะพัะตะดััะฐ
 A.1]       A.2]        A.3]          A.4]            A.5]
```

### ะัะพัะตะดััะฐ A.1: "ะััะตั ะทะฐะฟะพะปะฝะตะฝ" (ะฝะฐะธะฑะพะปะตะต ะบัะธัะธัะฝะฐั)

**ะกะธะผะฟัะพะผั:**
- ะะฐััะธั ะฒะธะดะธั ัะพะพะฑัะตะฝะธะต: "ะะตะฒะพะทะผะพะถะฝะพ ะฟัะธะฝััั ะพะฟะปะฐัั. ะัะปะฐะนะฝ-ะฑััะตั ะฟะตัะตะฟะพะปะฝะตะฝ"
- UI ะฟะพะบะฐะทัะฒะฐะตั ะบัะฐัะฝัะน ะธะฝะดะธะบะฐัะพั "200/200 ัะตะบะพะฒ"

**ะะธะฐะณะฝะพััะธะบะฐ (L1, 2 ะผะธะฝััั):**
```bash
# 1. ะัะพะฒะตัะบะฐ ัะฒัะทะธ ั ะะคะ (ping)
curl -I https://ofd.example.com/health
# ะะถะธะดะฐะฝะธะต: HTTP 200 OK

# 2. ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฑััะตัะฐ
curl https://pos-001.local/v1/kkt/buffer/status | jq
# ะกะผะพััะธะผ: current_queued, network_status, last_sync, circuit_state

# 3. ะัะพะฒะตัะบะฐ Circuit Breaker
curl https://pos-001.local/v1/health | jq '.components.circuit_breaker.state'
# ะะพะทะผะพะถะฝัะต ะทะฝะฐัะตะฝะธั: CLOSED, OPEN, HALF_OPEN
```

**ะะตัะตะฝะธั:**

**ะกะปััะฐะน 1: ะกะตัั ัะฐะฑะพัะฐะตั, Circuit Breaker CLOSED, ะฝะพ ัะธะฝััะพะฝะธะทะฐัะธั ะฝะต ะธะดัั**
```
ะัะธัะธะฝะฐ: ะทะฐััััะฒัะฐั ัะธะฝััะพะฝะธะทะฐัะธั ะธะปะธ ะพัะธะฑะบะฐ ะะคะ

ะะตะนััะฒะธั L1:
1. ะัะธะฝัะดะธัะตะปัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั:
   curl -X POST https://pos-001.local/v1/kkt/buffer/sync?force=true
   
2. ะะถะธะดะฐะฝะธะต 5-10 ะผะธะฝัั (ะผะพะฝะธัะพัะธะฝะณ progress)
   watch -n 10 'curl -s https://pos-001.local/v1/kkt/buffer/status | jq .current_queued'
   
3. ะัะพะฒะตัะบะฐ: buffer_size ัะผะตะฝััะธะปัั?
   - โ ะะฐ โ ะฟัะพะฑะปะตะผะฐ ัะตัะตะฝะฐ, ะบะฐััะฐ ัะฐะทะฑะปะพะบะธัะพะฒะฐะฝะฐ
   - โ ะะตั โ ััะบะฐะปะฐัะธั ะฝะฐ L2

ะญัะบะฐะปะฐัะธั L2:
- ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ ะฐะดะฐะฟัะตัะฐ: docker logs kkt-adapter --tail 100 | grep ERROR
- ะัะพะฒะตัะบะฐ ะะคะ API: ะฒะพะทะฒัะฐัะฐะตั ะปะธ ะพัะธะฑะบะธ? (curl -v ะบ ะะคะ)
- ะัะปะธ ะะคะ ะฝะตะดะพัััะฟะตะฝ โ ะบะพะฝัะฐะบั ั ะฟัะพะฒะฐะนะดะตัะพะผ ะะคะ (SLA 30 ะผะธะฝ)
```

**ะกะปััะฐะน 2: Circuit Breaker OPEN (ะะคะ ะฝะตะดะพัััะฟะตะฝ ะดะปะธัะตะปัะฝะพะต ะฒัะตะผั)**
```
ะัะธัะธะฝะฐ: Circuit Breaker ัะฐะทะพะผะบะฝัั ะธะท-ะทะฐ ะผะฝะพะถะตััะฒะตะฝะฝัั ะพัะธะฑะพะบ ะะคะ

ะะตะนััะฒะธั L1:
1. ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั Circuit Breaker:
   curl https://pos-001.local/v1/health | jq '.components.circuit_breaker'
   
2. ะัะปะธ state=OPEN ะธ failure_countโฅ5:
   - ะญัะพ ะทะฐัะธัะฝัะน ะผะตัะฐะฝะธะทะผ (ะฝะพัะผะฐะปัะฝะพ ะฟัะธ ะฟัะพะฑะปะตะผะฐั ะะคะ)
   - Circuit Breaker ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะนะดัั ะฒ HALF_OPEN ัะตัะตะท 60ั
   
3. ะัะพะฒะตัะบะฐ ัะธะทะธัะตัะบะพะน ัะฒัะทะธ:
   - Ping ะดะพ ะะคะ: ping -c 5 ofd.example.com
   - Trace route: traceroute ofd.example.com
   
4. ะัะปะธ ัะตัั ะฒะพัััะฐะฝะพะฒะธะปะฐัั:
   - ะะดัะผ ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะฟะตัะตัะพะดะฐ HALF_OPEN โ CLOSED
   - ะกะธะฝััะพะฝะธะทะฐัะธั ะฝะฐัะฝัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
   
5. ะัะปะธ ัะตัั ะะ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั:
   - ะญัะบะฐะปะฐัะธั ะฝะฐ ะฟัะพะฒะฐะนะดะตัะฐ ะธะฝัะตัะฝะตัะฐ
   - ะัะตะผะตะฝะฝะพะต ัะตัะตะฝะธะต: 4G/LTE ะผะพะดะตะผ (ะตัะปะธ ะตััั)
   - ะฃะฒะตะดะพะผะปะตะฝะธะต ะฒะปะฐะดะตะปััะฐ ะฑะธะทะฝะตัะฐ (ะฟะพัะตัั ะฟัะพะดะฐะถ!)

ะัะธัะธัะฝะพััั: P1 (ะฑะปะพะบะธััะตั ะฟัะพะดะฐะถะธ)
SLA ะฒะพัััะฐะฝะพะฒะปะตะฝะธั: 1 ัะฐั
```

**ะกะปััะฐะน 3: ะกะตัั ะฝะต ัะฐะฑะพัะฐะตั (offline)**
```
ะัะธัะธะฝะฐ: ะพะฑััะฒ ะธะฝัะตัะฝะตั-ะบะฐะฝะฐะปะฐ

ะะตะนััะฒะธั L1:
1. ะัะพะฒะตัะบะฐ ัะธะทะธัะตัะบะพะณะพ ะฟะพะดะบะปััะตะฝะธั:
   - ะะฐะฑะตะปั Ethernet ะฟะพะดะบะปััะตะฝ?
   - ะะพััะตั ะฒะบะปััะตะฝ ะธ ะณะพััั ะธะฝะดะธะบะฐัะพัั?
   - Wi-Fi ัะฐะฑะพัะฐะตั ะฝะฐ ะดััะณะธั ััััะพะนััะฒะฐั?

2. ะะตัะตะทะฐะฟััะบ ัะตัะตะฒะพะณะพ ะพะฑะพััะดะพะฒะฐะฝะธั:
   - ะัะบะปััะธัั/ะฒะบะปััะธัั ัะพััะตั (30 ัะตะบัะฝะด ะฟะฐัะทะฐ)
   - ะัะพะฒะตัะบะฐ: ping 8.8.8.8 ัะฐะฑะพัะฐะตั?

3. ะัะปะธ ัะตัั ะฒะพัััะฐะฝะพะฒะปะตะฝะฐ:
   - Circuit Breaker ะฟะตัะตะนะดัั ะธะท OPEN โ HALF_OPEN โ CLOSED (ะฐะฒัะพะผะฐัะธัะตัะบะธ)
   - ะกะธะฝััะพะฝะธะทะฐัะธั ะทะฐะฟัััะธััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะตัะตะท 5 ะผะธะฝ
   - ะะฐััะฐ ัะฐะทะฑะปะพะบะธััะตััั ัะตัะตะท 5-10 ะผะธะฝ

4. ะัะปะธ ัะตัั ะะ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั:
   - ะญัะบะฐะปะฐัะธั ะฝะฐ ะฟัะพะฒะฐะนะดะตัะฐ ะธะฝัะตัะฝะตัะฐ
   - ะัะตะผะตะฝะฝะพะต ัะตัะตะฝะธะต: 4G/LTE ะผะพะดะตะผ (ะตัะปะธ ะตััั)
   - ะฃะฒะตะดะพะผะปะตะฝะธะต ะฒะปะฐะดะตะปััะฐ ะฑะธะทะฝะตัะฐ (ะฟะพัะตัั ะฟัะพะดะฐะถ!)

ะัะธัะธัะฝะพััั: P1 (ะฑะปะพะบะธััะตั ะฟัะพะดะฐะถะธ)
SLA ะฒะพัััะฐะฝะพะฒะปะตะฝะธั: 1 ัะฐั
```

**ะกะปััะฐะน 4: ะััะตั ะฟะตัะตะฟะพะปะฝะตะฝ ะธะท-ะทะฐ ะดะพะปะณะพะณะพ ะพัะปะฐะนะฝะฐ (>8ั)**
```
ะัะธัะธะฝะฐ: ะดะปะธัะตะปัะฝัะน ะพะฑััะฒ ัะฒัะทะธ, ะฒัะต 200 ะผะตัั ะฒ ะฑััะตัะต ะทะฐะฝััั

ะะตะนััะฒะธั L2 (ะฒัะตะผะตะฝะฝะพะต ัะตัะตะฝะธะต, 15 ะผะธะฝัั):
1. Hot-patch: ัะฒะตะปะธัะตะฝะธะต ัะผะบะพััะธ ะฑััะตัะฐ ะดะพ 300 ัะตะบะพะฒ
   
   # ะะฐ ะบะฐััะพะฒะพะผ ัะตัะผะธะฝะฐะปะต
   docker exec kkt-adapter vi /app/config.toml
   # ะะทะผะตะฝะธัั: capacity = 300
   
   docker restart kkt-adapter
   
   # ะะฐััะฐ ัะฐะทะฑะปะพะบะธััะตััั, ะผะพะถะฝะพ ะฟัะธะฝะธะผะฐัั ะตัั 100 ัะตะบะพะฒ

2. ะะตะผะตะดะปะตะฝะฝะฐั ััะบะฐะปะฐัะธั ะฒะปะฐะดะตะปััั ะฑะธะทะฝะตัะฐ:
   "ะััะตั ะบัะธัะธัะฝะพ ะทะฐะฟะพะปะฝะตะฝ, ะฒัะตะผะตะฝะฝะพะต ัะตัะตะฝะธะต ะฝะฐ 4 ัะฐัะฐ.
    ะะตะพะฑัะพะดะธะผะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ัะฒัะทะธ ะธะปะธ ะทะฐะผะตะฝะฐ ะฝะฐ ัะตะทะตัะฒะฝัะน ะบะฐะฝะฐะป."

3. ะะพะฝะธัะพัะธะฝะณ: ะฟัะพะฒะตัะบะฐ ะบะฐะถะดัะต 30 ะผะธะฝัั
   - ะะพััะธะณะฝัั ะปะธ ะปะธะผะธั 300?
   - ะะพัััะฐะฝะพะฒะธะปะฐัั ะปะธ ัะฒัะทั?

ะะพะปะณะพััะพัะฝะพะต ัะตัะตะฝะธะต (L2 + DevOps):
- ะะฐััะปะตะดะพะฒะฐะฝะธะต ะฟัะธัะธะฝั ะดะปะธัะตะปัะฝะพะณะพ ะพัะปะฐะนะฝะฐ
- ะฃััะฐะฝะพะฒะบะฐ ัะตะทะตัะฒะฝะพะณะพ ะบะฐะฝะฐะปะฐ (4G/LTE) ะฝะฐ ะบัะธัะธัะฝัั ัะพัะบะฐั
- ะะฑะฝะพะฒะปะตะฝะธะต ะฟัะพัะตะดััั: ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะบะปััะตะฝะธะต ะฝะฐ ัะตะทะตัะฒะฝัะน ะบะฐะฝะฐะป
```

### ะัะพัะตะดััะฐ A.5: "Circuit Breaker OPEN" (ะฝะพะฒะฐั)

**ะกะธะผะฟัะพะผั:**
- ะะพะฝะธัะพัะธะฝะณ ะฟะพะบะฐะทัะฒะฐะตั "Circuit Breaker: OPEN"
- ะงะตะบะธ ะฝะฐะบะฐะฟะปะธะฒะฐัััั ะฒ ะฑััะตัะต, ะฝะพ ะฝะต ะพัะฟัะฐะฒะปััััั ะฒ ะะคะ
- ะะคะ ะผะพะถะตั ะฑััั ะดะพัััะฟะตะฝ, ะฝะพ ะฒะพะทะฒัะฐัะฐะตั ะพัะธะฑะบะธ

**ะะธะฐะณะฝะพััะธะบะฐ (L2, 5 ะผะธะฝัั):**
```bash
# 1. ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั Circuit Breaker
curl https://pos-001.local/v1/health | jq '.components.circuit_breaker'
# {
#   "state": "OPEN",
#   "failure_count": 7,
#   "last_failure_time": "2025-10-05T14:30:00Z",
#   "next_attempt_time": "2025-10-05T14:31:00Z"
# }

# 2. ะัะพะฒะตัะบะฐ ะฟะพัะปะตะดะฝะธั ะพัะธะฑะพะบ
curl https://pos-001.local/v1/kkt/buffer/logs?level=ERROR&limit=10 | jq
# ะกะผะพััะธะผ ะฟะฐััะตัะฝั: timeout, 503, 500, connection refused

# 3. ะััะผะพะน ัะตัั ะะคะ
curl -v -X POST https://ofd.example.com/api/receipts \
  -H "Authorization: Bearer $OFD_API_KEY" \
  -d '{"test": true}'
# ะัะพะฒะตัะบะฐ: ะฒะพะทะฒัะฐัะฐะตั ะปะธ ะะคะ ะพัะธะฑะบั?
```

**ะะตัะตะฝะธั:**

**ะกะปััะฐะน 1: ะะคะ ะฒัะตะผะตะฝะฝะพ ะฝะตะดะพัััะฟะตะฝ (maintenance)**
```
ะะตะนััะฒะธั L2:
1. ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะะคะ:
   - ะกะฐะนั ะฟัะพะฒะฐะนะดะตัะฐ ะะคะ (status page)
   - ะะพะฝัะฐะบั ั ัะตัะฟะพะดะดะตัะถะบะพะน ะะคะ

2. ะัะปะธ ะฟะปะฐะฝะพะฒัะต ัะฐะฑะพัั ะะคะ:
   - Circuit Breaker ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒะพัััะฐะฝะพะฒะธััั ัะตัะตะท 60ั (HALF_OPEN)
   - ะัะปะธ HALF_OPEN โ ััะฟะตั โ CLOSED
   - ะกะธะฝััะพะฝะธะทะฐัะธั ะฝะฐัะฝัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
   
3. ะฃะฒะตะดะพะผะปะตะฝะธะต ะบะฐััะธัะพะฒ:
   "ะะคะ ะฝะฐ ะพะฑัะปัะถะธะฒะฐะฝะธะธ, ัะตะบะธ ะฝะฐะบะฐะฟะปะธะฒะฐัััั ะฒ ะฑััะตัะต.
    ะกะธะฝััะพะฝะธะทะฐัะธั ะฟัะพะธะทะพะนะดัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพัะปะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั (ETA: XX:XX)"

ะัะธัะธัะฝะพััั: P2 (ะฟัะพะดะฐะถะธ ัะฐะฑะพัะฐัั, ะฝะพ ะฑััะตั ัะฐัััั)
```

**ะกะปััะฐะน 2: ะัะพะฑะปะตะผะฐ ั API key ะธะปะธ ะฐะฒัะพัะธะทะฐัะธะตะน ะะคะ**
```
ะกะธะผะฟัะพะผั: ะะคะ ะฒะพะทะฒัะฐัะฐะตั 401 Unauthorized ะธะปะธ 403 Forbidden

ะะตะนััะฒะธั L2:
1. ะัะพะฒะตัะบะฐ API key:
   echo $OFD_API_KEY
   # ะัะพะฒะตัะธัั: ะฝะต ะธัััะบ ะปะธ ััะพะบ ะดะตะนััะฒะธั?
   
2. ะะพัะฐัะธั API key:
   - ะะพะปััะตะฝะธะต ะฝะพะฒะพะณะพ ะบะปััะฐ ะพั ะฟัะพะฒะฐะนะดะตัะฐ ะะคะ
   - ะะฑะฝะพะฒะปะตะฝะธะต config.toml
   - docker restart kkt-adapter
   
3. ะััะฝะพะน ัะฑัะพั Circuit Breaker (ะฟะพัะปะต ะธัะฟัะฐะฒะปะตะฝะธั):
   curl -X POST https://pos-001.local/v1/kkt/circuit_breaker/reset
   
4. ะัะธะฝัะดะธัะตะปัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั:
   curl -X POST https://pos-001.local/v1/kkt/buffer/sync?force=true

ะัะธัะธัะฝะพััั: P1 (ััะตะฑัะตััั ัััะฝะพะต ะฒะผะตัะฐัะตะปัััะฒะพ)
```

**ะกะปััะฐะน 3: ะะคะ ะฟะตัะตะณััะถะตะฝ (rate limiting)**
```
ะกะธะผะฟัะพะผั: ะะคะ ะฒะพะทะฒัะฐัะฐะตั 429 Too Many Requests

ะะตะนััะฒะธั L2:
1. ะัะพะฒะตัะบะฐ Retry-After header:
   curl -I https://ofd.example.com/api/receipts
   # Retry-After: 120 (ัะตะบัะฝะดั)
   
2. ะกะฝะธะถะตะฝะธะต ัะบะพัะพััะธ ัะธะฝััะพะฝะธะทะฐัะธะธ:
   # ะ config.toml
   [buffer]
   sync_batch_size = 10  # ะะผะตััะพ 20
   sync_interval = 600   # 10 ะผะธะฝ ะฒะผะตััะพ 5 ะผะธะฝ
   
   docker restart kkt-adapter
   
3. Circuit Breaker ะฐะฒัะพะผะฐัะธัะตัะบะธ ััััั rate limiting:
   - HALF_OPEN ะฟะพะฟััะบะธ ะฑัะดัั ัะตะถะต
   - ะะพััะตะฟะตะฝะฝะพะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต CLOSED

ะัะธัะธัะฝะพััั: P2 (ัะธะฝััะพะฝะธะทะฐัะธั ะทะฐะผะตะดะปะตะฝะฐ, ะฝะพ ัะฐะฑะพัะฐะตั)
```

---

## 5.6 ะัะธะผะตัั ะปะพะณะพะฒ ะธ ะธั ะธะฝัะตัะฟัะตัะฐัะธั

### ะะพัะผะฐะปัะฝะฐั ัะฐะฑะพัะฐ (online-ัะตะถะธะผ ั Circuit Breaker CLOSED)

```json
{"timestamp":"2025-10-05T14:23:45.123Z","level":"INFO","component":"kkt_adapter","event":"receipt_create","receipt_id":"550e8400-e29b-41d4-a716-446655440000","pos_id":"POS-001","hlc":{"local_time":1728134625,"logical_counter":42}}
{"timestamp":"2025-10-05T14:23:45.150Z","level":"INFO","component":"kkt_adapter","event":"buffer_insert","receipt_id":"550e8400...","buffer_size":1,"hlc_stored":true}
{"timestamp":"2025-10-05T14:23:45.200Z","level":"INFO","component":"kkt_adapter","event":"kkt_print_start","receipt_id":"550e8400..."}
{"timestamp":"2025-10-05T14:23:45.380Z","level":"INFO","component":"kkt_adapter","event":"kkt_print_success","receipt_id":"550e8400...","duration_ms":180}
{"timestamp":"2025-10-05T14:23:45.400Z","level":"INFO","component":"kkt_adapter","event":"circuit_check","circuit_state":"CLOSED","failure_count":0}
{"timestamp":"2025-10-05T14:23:45.410Z","level":"INFO","component":"kkt_adapter","event":"ofd_send_start","receipt_id":"550e8400..."}
{"timestamp":"2025-10-05T14:23:45.760Z","level":"INFO","component":"kkt_adapter","event":"ofd_send_success","receipt_id":"550e8400...","fiscal_doc":{"fn":"1234567890","fd":"12345","fp":"98765"},"duration_ms":350}
{"timestamp":"2025-10-05T14:23:45.780Z","level":"INFO","component":"kkt_adapter","event":"receipt_synced","receipt_id":"550e8400...","total_duration_ms":657,"hlc_server_time":1728134625}
```

**ะะฝัะตัะฟัะตัะฐัะธั (ะดะปั L2):**
- ะะตัั ะฟัะพัะตัั ะทะฐะฝัะป **657 ะผั** (< 7 ัะตะบ SLA โ)
- ะะตัะฐัั ะฝะฐ ะะะข: **180 ะผั** (ะฑััััะพ โ)
- Circuit Breaker ะฒ ัะพััะพัะฝะธะธ CLOSED (ะฝะพัะผะฐ โ)
- ะัะฟัะฐะฒะบะฐ ะฒ ะะคะ: **350 ะผั** (ะฝะพัะผะฐ โ)
- ะงะตะบ ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝ ััะฐะทั (online-ัะตะถะธะผ)
- Hybrid Clock: local_time + logical_counter ัะพััะฐะฝะตะฝั, server_time ะฟัะธัะฒะพะตะฝ

### Circuit Breaker ะพัะบััะฒะฐะตััั (5 ะพัะธะฑะพะบ ะฟะพะดััะด)

```json
{"timestamp":"2025-10-05T16:10:10.100Z","level":"ERROR","component":"kkt_adapter","event":"ofd_send_failed","receipt_id":"661f9511...","error":"ConnectionTimeout","retry_count":1,"circuit_failure_count":1}
{"timestamp":"2025-10-05T16:10:15.200Z","level":"ERROR","component":"kkt_adapter","event":"ofd_send_failed","receipt_id":"772a0622...","error":"ConnectionTimeout","retry_count":1,"circuit_failure_count":2}
{"timestamp":"2025-10-05T16:10:20.300Z","level":"ERROR","component":"kkt_adapter","event":"ofd_send_failed","receipt_id":"883b1733...","error":"503 Service Unavailable","retry_count":1,"circuit_failure_count":3}
{"timestamp":"2025-10-05T16:10:25.400Z","level":"ERROR","component":"kkt_adapter","event":"ofd_send_failed","receipt_id":"994c2844...","error":"ConnectionTimeout","retry_count":1,"circuit_failure_count":4}
{"timestamp":"2025-10-05T16:10:30.500Z","level":"ERROR","component":"kkt_adapter","event":"ofd_send_failed","receipt_id":"aa5d3955...","error":"ConnectionTimeout","retry_count":1,"circuit_failure_count":5}
{"timestamp":"2025-10-05T16:10:30.505Z","level":"CRITICAL","component":"kkt_adapter","event":"circuit_breaker_opened","reason":"failure_threshold_exceeded","failure_count":5,"recovery_timeout_seconds":60}
{"timestamp":"2025-10-05T16:10:30.510Z","level":"WARN","component":"kkt_adapter","event":"network_mode_change","from":"online","to":"offline"}
{"timestamp":"2025-10-05T16:10:30.510Z","level":"WARN","component":"kkt_adapter","event":"network_mode_change","from":"online","to":"offline"}
{"timestamp":"2025-10-05T16:10:30.515Z","level":"CRITICAL","component":"kkt_adapter","event":"alert_sent","level":"P2","message":"Circuit Breaker OPEN ะฝะฐ POS-001, ะะคะ ะฝะตะดะพัััะฟะตะฝ","buffer_size":47}
```

**ะะฝัะตัะฟัะตัะฐัะธั:**
- 5 ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝัั ะพัะธะฑะพะบ ะะคะ (ัะฐะนะผะฐััั + 503) ะทะฐ 30 ัะตะบัะฝะด
- Circuit Breaker ะพัะบััะปัั โ **ะทะฐัะธัะฐ ะพั ะบะฐัะบะฐะดะฝัั ะพัะบะฐะทะพะฒ**
- ะะฐััะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตัะปะฐ ะฒ **offline-ัะตะถะธะผ** (ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัะฐัั!)
- ะะปะตัั P2 ะพัะฟัะฐะฒะปะตะฝ ะฐะดะผะธะฝะธัััะฐัะพัั
- ะกะปะตะดัััะฐั ะฟะพะฟััะบะฐ (HALF_OPEN) ัะตัะตะท 60 ัะตะบัะฝะด
- ะััะตั: 47 ัะตะบะพะฒ (24%, ะฝะต ะบัะธัะธัะฝะพ)

### Circuit Breaker ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั (HALF_OPEN โ CLOSED)

```json
{"timestamp":"2025-10-05T16:11:30.600Z","level":"INFO","component":"kkt_adapter","event":"circuit_breaker_half_open","next_attempt":"probe_request"}
{"timestamp":"2025-10-05T16:11:30.650Z","level":"INFO","component":"kkt_adapter","event":"ofd_send_start","receipt_id":"bb6e4a66...","is_probe":true}
{"timestamp":"2025-10-05T16:11:31.000Z","level":"INFO","component":"kkt_adapter","event":"ofd_send_success","receipt_id":"bb6e4a66...","fiscal_doc":{"fn":"1234567890","fd":"12346","fp":"98766"},"duration_ms":350}
{"timestamp":"2025-10-05T16:11:31.005Z","level":"INFO","component":"kkt_adapter","event":"circuit_breaker_closed","reason":"probe_success","downtime_seconds":61}
{"timestamp":"2025-10-05T16:11:31.010Z","level":"INFO","component":"kkt_adapter","event":"network_mode_change","from":"offline","to":"online"}
{"timestamp":"2025-10-05T16:11:31.015Z","level":"INFO","component":"kkt_adapter","event":"sync_start","pending_receipts":47,"estimated_duration_seconds":141}
```

**ะะฝัะตัะฟัะตัะฐัะธั:**
- ะงะตัะตะท 61 ัะตะบัะฝะดั Circuit Breaker ะฟะตัะตััะป ะฒ HALF_OPEN
- ะัะพะฑะฝัะน ะทะฐะฟัะพั ััะฟะตัะตะฝ โ ะฟะตัะตัะพะด ะฒ CLOSED
- ะะฐััะฐ ะฒะตัะฝัะปะฐัั ะฒ online-ัะตะถะธะผ
- ะะฒัะพะผะฐัะธัะตัะบะฐั ัะธะฝััะพะฝะธะทะฐัะธั 47 ัะตะบะพะฒ ะฝะฐัะฐัะฐ (โ2.4 ะผะธะฝ)
- **Downtime ะะคะ:** 61 ัะตะบัะฝะดะฐ (ะบะฐััะฐ ัะฐะฑะพัะฐะปะฐ ะฒัั ััะพ ะฒัะตะผั!)

### Distributed Lock ะฟัะตะดะพัะฒัะฐัะฐะตั ะบะพะฝะบััะตะฝัะฝัั ัะธะฝััะพะฝะธะทะฐัะธั

```json
{"timestamp":"2025-10-05T18:00:00.100Z","level":"INFO","component":"kkt_adapter","event":"sync_start","trigger":"scheduled","pending_receipts":15}
{"timestamp":"2025-10-05T18:00:00.105Z","level":"INFO","component":"kkt_adapter","event":"sync_lock_acquired","lock_id":"sync:POS-001:1728141600"}

{"timestamp":"2025-10-05T18:00:01.200Z","level":"INFO","component":"kkt_adapter","event":"sync_start","trigger":"manual","user":"admin"}
{"timestamp":"2025-10-05T18:00:01.205Z","level":"WARN","component":"kkt_adapter","event":"sync_lock_conflict","lock_id":"sync:POS-001:1728141600","held_by":"scheduled"}
{"timestamp":"2025-10-05T18:00:01.210Z","level":"INFO","component":"kkt_adapter","event":"sync_rejected","reason":"already_in_progress","http_status":409}

{"timestamp":"2025-10-05T18:00:15.300Z","level":"INFO","component":"kkt_adapter","event":"sync_complete","synced_count":15,"failed_count":0,"duration_seconds":15.2}
{"timestamp":"2025-10-05T18:00:15.305Z","level":"INFO","component":"kkt_adapter","event":"sync_lock_released","lock_id":"sync:POS-001:1728141600"}
```

**ะะฝัะตัะฟัะตัะฐัะธั:**
- ะะปะฐะฝะพะฒะฐั ัะธะฝััะพะฝะธะทะฐัะธั ะฝะฐัะฐะปะฐัั ะฒ 18:00:00 (scheduled)
- Distributed lock ะฟะพะปััะตะฝ (sync_lock_acquired)
- ะงะตัะตะท 1 ัะตะบัะฝะดั ะฐะดะผะธะฝะธัััะฐัะพั ะฒัััะฝัั ะทะฐะฟัััะธะป ัะธะฝััะพะฝะธะทะฐัะธั (manual)
- **Distributed lock ััะฐะฑะพัะฐะป:** ะฒัะพัะฐั ะฟะพะฟััะบะฐ ะพัะบะปะพะฝะตะฝะฐ (HTTP 409)
- **ะะฐัะธัะฐ ะพั ะดัะฑะปะธะบะฐัะพะฒ:** ะฝะตั ะบะพะฝะบััะตะฝัะฝะพะน ะพัะฟัะฐะฒะบะธ ะฒ ะะคะ
- ะะตัะฒะฐั ัะธะฝััะพะฝะธะทะฐัะธั ะทะฐะฒะตััะธะปะฐัั ััะฟะตัะฝะพ (15.2 ัะตะบ)
- Lock ะพัะฒะพะฑะพะถะดัะฝ

---

## 5.7 ะขะฐะฑะปะธัะฐ ััะบะฐะปะฐัะธะธ (SLA ั ััััะพะผ Circuit Breaker)

| ะัะพะฑะปะตะผะฐ | ะัะธัะธัะฝะพััั | L1 Response | L2 Escalation | ะะปะฐะดะตะปะตั ะฑะธะทะฝะตัะฐ | ะัะธะผะตัะฐะฝะธั |
|----------|-------------|-------------|---------------|------------------|------------|
| ะััะตั ะฟะตัะตะฟะพะปะฝะตะฝ (ัะตัั ัะฐะฑะพัะฐะตั, CB CLOSED) | P1 | โค15 ะผะธะฝ | โค30 ะผะธะฝ (ะตัะปะธ ะฝะต ัะตัะตะฝะพ L1) | โค1ั (ะตัะปะธ ะฝะต ัะตัะตะฝะพ L2) | ะัะธะฝัะดะธัะตะปัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั |
| ะััะตั ะฟะตัะตะฟะพะปะฝะตะฝ (Circuit Breaker OPEN) | P1 | โค15 ะผะธะฝ | ะะตะผะตะดะปะตะฝะฝะพ (ะฟัะพะฒะฐะนะดะตั ะะคะ) | ะะตะผะตะดะปะตะฝะฝะพ | Hot-patch: ัะฒะตะปะธัะตะฝะธะต ะฑััะตัะฐ ะดะพ 300 |
| ะััะตั ะฟะตัะตะฟะพะปะฝะตะฝ (ัะตัั ะฝะต ัะฐะฑะพัะฐะตั) | P1 | โค15 ะผะธะฝ | ะะตะผะตะดะปะตะฝะฝะพ (ะฟัะพะฒะฐะนะดะตั ะธะฝัะตัะฝะตัะฐ) | ะะตะผะตะดะปะตะฝะฝะพ | 4G/LTE ะผะพะดะตะผ ะธะปะธ ะฟะพัะตัั ะฟัะพะดะฐะถ |
| Circuit Breaker OPEN (ะฟะปะฐะฝะพะฒัะต ัะฐะฑะพัั ะะคะ) | P2 | N/A | โค1ั (ะผะพะฝะธัะพัะธะฝะณ) | N/A | ะะฒัะพะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ัะตัะตะท 60ั |
| Circuit Breaker OPEN (ะฟัะพะฑะปะตะผะฐ ะฐะฒัะพัะธะทะฐัะธะธ) | P1 | N/A | โค30 ะผะธะฝ | โค1ั | ะขัะตะฑัะตััั ัะพัะฐัะธั API key |
| ะะฐััะฐ ะฝะต ะฟัะธะฝะธะผะฐะตั ะพะฟะปะฐัั | P1 | โค15 ะผะธะฝ | โค30 ะผะธะฝ | โค1ั | ะัะพะฒะตัะบะฐ ะฐะดะฐะฟัะตัะฐ ะะะข |
| ะงะตะบ ะฝะต ะฟะตัะฐัะฐะตััั (ะฝะตั ะฑัะผะฐะณะธ) | P3 | ะะฐััะธั (ัะฐะผะพััะพััะตะปัะฝะพ) | N/A | N/A | ะกะฐะผะพะพะฑัะปัะถะธะฒะฐะฝะธะต |
| ะงะตะบ ะฝะต ะฟะตัะฐัะฐะตััั (ะพัะธะฑะบะฐ ะะะข) | P2 | โค30 ะผะธะฝ | โค1ั | โค4ั | ะะฐะผะตะฝะฐ ะะะข ะฝะฐ ัะตะทะตัะฒะฝัั |
| ะะตะดะปะตะฝะฝะพ ัะฐะฑะพัะฐะตั | P2 | โค1ั | โค4ั | N/A | ะัะพะฒะตัะบะฐ ัะตััััะพะฒ/ัะตัะธ |
| DLQ ัะพะดะตัะถะธั >10 ัะตะบะพะฒ | P2 | N/A | โค4ั (ัััะฝะฐั ะพะฑัะฐะฑะพัะบะฐ) | N/A | ะะถะตะฝะตะดะตะปัะฝะฐั ะฟัะพะฒะตัะบะฐ DLQ |

---

## 5.8 ะะพะฝะธัะพัะธะฝะณ ะธ ะฐะปะตััั (ั Circuit Breaker ะผะตััะธะบะฐะผะธ)

### ะัะธัะธัะฝัะต ะผะตััะธะบะธ ะดะปั ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ

```python
# Prometheus metrics (ะดะพะฑะฐะฒะปะตะฝั Circuit Breaker ะผะตััะธะบะธ)

# ะัะปะฐะนะฝ-ะฑััะตั
kkt_buffer_size = Gauge('kkt_buffer_size', 'Current buffer size', ['pos_id'])
kkt_buffer_capacity = Gauge('kkt_buffer_capacity', 'Max buffer capacity')
kkt_buffer_percent_full = Gauge('kkt_buffer_percent_full', 'Buffer fullness %', ['pos_id'])

# Circuit Breaker
kkt_circuit_breaker_state = Gauge('kkt_circuit_breaker_state', 'Circuit breaker state (0=CLOSED, 1=OPEN, 2=HALF_OPEN)', ['pos_id'])
kkt_circuit_breaker_failures = Counter('kkt_circuit_breaker_failures_total', 'Total circuit breaker failures', ['pos_id'])
kkt_circuit_breaker_opens = Counter('kkt_circuit_breaker_opens_total', 'Times circuit breaker opened', ['pos_id'])

# ะกะธะฝััะพะฝะธะทะฐัะธั
kkt_sync_duration_seconds = Histogram('kkt_sync_duration_seconds', 'Sync duration', ['pos_id'])
kkt_receipts_synced = Counter('kkt_receipts_synced_total', 'Total synced receipts', ['pos_id', 'status'])

# DLQ
kkt_dlq_size = Gauge('kkt_dlq_size', 'Dead Letter Queue size', ['pos_id'])

# Hybrid Clock
kkt_hlc_drift_seconds = Gauge('kkt_hlc_drift_seconds', 'HLC drift from NTP', ['pos_id'])
```

### ะะปะตััั (Prometheus Alertmanager)

```yaml
groups:
  - name: offline_mode_alerts
    interval: 30s
    rules:
      # ะััะตั ะทะฐะฟะพะปะฝะตะฝ โฅ80%
      - alert: OfflineBufferWarning
        expr: kkt_buffer_percent_full >= 80
        for: 5m
        labels:
          severity: P2
        annotations:
          summary: "ะัะปะฐะนะฝ-ะฑััะตั ะทะฐะฟะพะปะฝะตะฝ โฅ80% ะฝะฐ {{ $labels.pos_id }}"
          description: "ะขะตะบััะธะน ัะฐะทะผะตั: {{ $value }}%. ะขัะตะฑัะตััั ะผะพะฝะธัะพัะธะฝะณ."
      
      # ะััะตั ะฟะตัะตะฟะพะปะฝะตะฝ (100%)
      - alert: OfflineBufferFull
        expr: kkt_buffer_percent_full >= 100
        for: 1m
        labels:
          severity: P1
        annotations:
          summary: "ะัะปะฐะนะฝ-ะฑััะตั ะฟะตัะตะฟะพะปะฝะตะฝ ะฝะฐ {{ $labels.pos_id }}"
          description: "ะะฐััะฐ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฐ. ะะตะผะตะดะปะตะฝะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั!"
      
      # Circuit Breaker ะพัะบััั >5 ะผะธะฝัั
      - alert: CircuitBreakerOpen
        expr: kkt_circuit_breaker_state == 1
        for: 5m
        labels:
          severity: P2
        annotations:
          summary: "Circuit Breaker OPEN ะฝะฐ {{ $labels.pos_id }}"
          description: "ะะคะ ะฝะตะดะพัััะฟะตะฝ >5 ะผะธะฝ. ะงะตะบะธ ะฑััะตัะธะทะธัััััั."
      
      # ะกะธะฝััะพะฝะธะทะฐัะธั ะดะปะธััั >20 ะผะธะฝัั
      - alert: SyncTooSlow
        expr: kkt_sync_duration_seconds > 1200
        labels:
          severity: P1
        annotations:
          summary: "ะกะธะฝััะพะฝะธะทะฐัะธั >20 ะผะธะฝ ะฝะฐ {{ $labels.pos_id }}"
          description: "ะัะพะฒะตัะบะฐ ะบะฐะฝะฐะปะฐ ะดะพ ะะคะ, ะฟะพะฒัะพั ัะธะฝััะพะฝะธะทะฐัะธะธ."
      
      # DLQ ัะพะดะตัะถะธั >10 ัะตะบะพะฒ
      - alert: DLQBacklog
        expr: kkt_dlq_size > 10
        for: 1h
        labels:
          severity: P2
        annotations:
          summary: "DLQ ัะพะดะตัะถะธั >10 ัะตะบะพะฒ ะฝะฐ {{ $labels.pos_id }}"
          description: "ะขัะตะฑัะตััั ัััะฝะฐั ะพะฑัะฐะฑะพัะบะฐ DLQ."
      
      # Hybrid Clock drift >10 ัะตะบัะฝะด
      - alert: HLCDriftHigh
        expr: abs(kkt_hlc_drift_seconds) > 10
        for: 15m
        labels:
          severity: P2
        annotations:
          summary: "HLC drift >10ั ะฝะฐ {{ $labels.pos_id }}"
          description: "ะัะพะฒะตัะบะฐ NTP-ัะธะฝััะพะฝะธะทะฐัะธะธ."
```

### Grafana Dashboard (4 ะบัะธัะธัะฝัะต ะฟะฐะฝะตะปะธ)

**ะะฐะฝะตะปั 1: ะกัะฐััั ะบะฐัั (real-time ะบะฐััะฐ)**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกัะฐััั ะบะฐัั (20 ัะพัะตะบ, 40 ะบะฐัั)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  [๐ข POS-001] ะััะตั: 5/200   CB: CLOSED  HB: 2s ago  โ
โ  [๐ข POS-002] ะััะตั: 12/200  CB: CLOSED  HB: 1s ago  โ
โ  [๐ก POS-003] ะััะตั: 165/200 CB: CLOSED  HB: 3s ago  โ โ Warning
โ  [๐ด POS-004] ะััะตั: 200/200 CB: OPEN    HB: 45s ago โ โ Critical
โ  [๐ข POS-005] ะััะตั: 3/200   CB: CLOSED  HB: 1s ago  โ
โ  ... (ะพััะฐะปัะฝัะต 35 ะบะฐัั)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะะตะณะตะฝะดะฐ:
๐ข Online, ะฑััะตั <80%, CB CLOSED
๐ก Online, ะฑััะตั 80-99%, CB CLOSED ะธะปะธ CB OPEN <5 ะผะธะฝ
๐ด Offline, ะฑััะตั 100%, CB OPEN >5 ะผะธะฝ ะธะปะธ HB >60s
```

**ะะฐะฝะตะปั 2: Circuit Breaker ัะพััะพัะฝะธั**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Circuit Breaker States (last 24h)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  POS-001: โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ CLOSED โ
โ  POS-002: โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ CLOSED โ
โ  POS-003: โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ 2x OPEN โ
โ  POS-004: โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ 5x OPEN โ
โ  POS-005: โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ CLOSED โ
โ  ... (ะพััะฐะปัะฝัะต 35 ะบะฐัั)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะะตััะธะบะธ:
- ะกัะตะดะฝะตะต ะฒัะตะผั ะฒ OPEN: 3.2 ะผะธะฝ
- ะงะฐััะพัะฐ ััะฐะฑะฐััะฒะฐะฝะธั CB: 0.8%
- ะฃัะฟะตัะฝะพััั HALF_OPEN โ CLOSED: 95%
```

**ะะฐะฝะตะปั 3: ะัะปะฐะนะฝ-ะฑััะตั ะฐะฝะฐะปะธัะธะบะฐ**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะัะปะฐะนะฝ-ะฑััะตั ะผะตััะธะบะธ (last 7 days)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ะัะฐัะธะบ ะทะฐะฟะพะปะฝะตะฝะฝะพััะธ (ะฟะพ ะฒัะตะผะตะฝะธ):                     โ
โ %                                                       โ
โ100โโโ                                                   โ
โ 80โ โโโ              โโโ                               โ
โ 60โ   โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ 40โ                                                     โ
โ 20โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  0โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ    Mon  Tue  Wed  Thu  Fri  Sat  Sun                   โ
โ                                                         โ
โ ะขะพะฟ-5 ะบะฐัั ะฟะพ ะผะฐะบัะธะผะฐะปัะฝะพะน ะทะฐะฟะพะปะฝะตะฝะฝะพััะธ:              โ
โ  1. POS-004: 200/200 (100%) - 3 ัะฐะทะฐ                  โ
โ  2. POS-012: 185/200 (93%)  - 1 ัะฐะท                   โ
โ  3. POS-003: 165/200 (83%)  - 2 ัะฐะทะฐ                  โ
โ  4. POS-018: 140/200 (70%)  - 1 ัะฐะท                   โ
โ  5. POS-007: 120/200 (60%)  - ะฟะพััะพัะฝะฝะพ               โ
โ                                                         โ
โ ะกัะตะดะฝัั ะดะปะธัะตะปัะฝะพััั ัะธะฝััะพะฝะธะทะฐัะธะธ: 8.3 ะผะธะฝ (P95: 12) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะฐะฝะตะปั 4: ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะธ ะฝะฐะดัะถะฝะพััั**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Performance & Reliability (last 24h)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ P95 ะปะฐัะตะฝัะฝะพััั ะฟะตัะฐัะธ ัะตะบะฐ:        5.8s  [โ <7s]    โ
โ Throughput ัะธะฝััะพะฝะธะทะฐัะธะธ (P50):     22 ัะตะบะพะฒ/ะผะธะฝ [โ]  โ
โ ะะพะปั ััะฟะตัะฝัั ัะธะฝััะพะฝะธะทะฐัะธะน:        99.2%  [โ >99%]   โ
โ DLQ ัะฐะทะผะตั (ััะผะผะฐัะฝะพ):              7 ัะตะบะพะฒ [โ <10]   โ
โ Circuit Breaker opens (24h):        12 ัะฐะท  [โ]       โ
โ ะะธะทะฝะตั-ะดะพัััะฟะฝะพััั ะบะฐัั:            99.7%  [โ >99.5%] โ
โ                                                         โ
โ Hybrid Clock drift (max):           2.3s   [โ <10s]   โ
โ Distributed Lock conflicts:         0      [โ]         โ
โ Event Sourcing ัะฐะฑะปะธัะฐ:             2.3M ัะพะฑััะธะน       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 5.9 ะะฐะบะปััะตะฝะธะต ะธ ัะตะบ-ะปะธัั ะณะพัะพะฒะฝะพััะธ

### ะงะตะบ-ะปะธัั ะณะพัะพะฒะฝะพััะธ ะพัะปะฐะนะฝ-ัะตะถะธะผะฐ (ะฟะตัะตะด ะฟัะพะดะพะผ)

**ะะฝััะฐััััะบัััะฐ:**
- [ ] UPS ัััะฐะฝะพะฒะปะตะฝั ะฝะฐ ะฒัะตั ะบะฐััะพะฒัั ัะตัะผะธะฝะฐะปะฐั (15 ะผะธะฝ ะฐะฒัะพะฝะพะผะธะธ)
- [ ] Graceful shutdown ัะบัะธะฟั ะฝะฐัััะพะตะฝ (apcupsd)
- [ ] SQLite `synchronous=FULL` ะฒะบะปัััะฝ (ะทะฐัะธัะฐ ะพั power loss)
- [ ] Hybrid Logical Clock ัะตะฐะปะธะทะพะฒะฐะฝ ะธ ะฟัะพัะตััะธัะพะฒะฐะฝ
- [ ] Circuit Breaker ะดะปั ะะคะ ัะฐะฑะพัะฐะตั (ัะตัั: 5 ะพัะธะฑะพะบ โ OPEN)
- [ ] Distributed Lock ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ ัะฐะฑะพัะฐะตั (ัะตัั: ะบะพะฝะบััะตะฝัะฝัะต ะฒัะทะพะฒั โ 409)

**ะะพะฝะธัะพัะธะฝะณ:**
- [ ] Prometheus exporters ัะฐะฑะพัะฐัั ะฝะฐ ะฒัะตั ะฐะดะฐะฟัะตัะฐั ะะะข
- [ ] Grafana dashboard "ะัะปะฐะนะฝ-ัะตะถะธะผ" ัะพะทะดะฐะฝ (4 ะฟะฐะฝะตะปะธ)
- [ ] ะะปะตััั ะฝะฐัััะพะตะฝั ะธ ะฟัะพัะตััะธัะพะฒะฐะฝั (ัะตััะพะฒัะน ะฐะปะตัั ะพัะฟัะฐะฒะปะตะฝ)
- [ ] Jaeger ััะตะนัะธะฝะณ ัะฐะฑะพัะฐะตั (ะฟัะพะฒะตัะบะฐ: trace_id ะฟัะพัะปะตะถะธะฒะฐะตััั ัะตัะตะท ะฒัะต ัะตัะฒะธัั)

**ะัะพัะตะดััั:**
- [ ] Decision Tree ะดะปั L1/L2 ัะฐัะฟะตัะฐัะฐะฝ ะธ ะดะพัััะฟะตะฝ ัะตัะฟะพะดะดะตัะถะบะต
- [ ] ะัะพัะตะดััะฐ ะทะฐะผะตะฝั ะคะ ะทะฐะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะฐ (ะะพะบ.2 ยง2.10)
- [ ] ะัะพัะตะดััะฐ ะฟะตัะตะฟะพะปะฝะตะฝะธั ะฑััะตัะฐ ะทะฐะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะฐ (A.1)
- [ ] ะัะพัะตะดััะฐ Circuit Breaker OPEN ะทะฐะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะฐ (A.5)
- [ ] Runbook ัะพะดะตัะถะธั ะฒัะต ััะตะฝะฐัะธะธ (20+)

**ะขะตััะธัะพะฒะฐะฝะธะต:**
- [ ] POC-4 (8ั ะพัะปะฐะนะฝ) ะฟัะพะนะดะตะฝ (100%)
- [ ] POC-5 (split-brain, flapping) ะฟัะพะนะดะตะฝ (100%)
- [ ] UAT-10b/10c (edge-cases) ะฟัะพะนะดะตะฝั (100%)
- [ ] Stress-test (2 ะบะฐััั ร 8ั ร 50 ัะตะบะพะฒ) ะฟัะพะนะดะตะฝ
- [ ] ะะฐะณััะทะพัะฝัะน ัะตัั (5 ะบะฐัั, 1000 ัะตะบะพะฒ/ะดะตะฝั) ะฟัะพะนะดะตะฝ

**ะะฑััะตะฝะธะต:**
- [ ] ะะฐััะธัั ะพะฑััะตะฝั ัะฐะฑะพัะต ะฒ ะพัะปะฐะนะฝ-ัะตะถะธะผะต (โฅ90%)
- [ ] ะะดะผะธะฝะธัััะฐัะพัั ะทะฝะฐัั ะฟัะพัะตะดััั ะฟัะธะฝัะดะธัะตะปัะฝะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ
- [ ] L1 ัะตัะฟะพะดะดะตัะถะบะฐ ะทะฝะฐะตั Decision Tree
- [ ] L2 ัะตัะฟะพะดะดะตัะถะบะฐ ะทะฝะฐะตั ะฒัะต ะฟัะพัะตะดััั (A.1-A.5)

### ะะพะฝััะพะปัะฝัะต ะฒะพะฟัะพัั (ะดะปั sign-off)

1. โ ะงัะพ ะฟัะพะธะทะพะนะดัั, ะตัะปะธ ะบะฐััะฐ ะฟะพัะตััะตั ัะฒัะทั ั ะะคะ ะฝะฐ 8 ัะฐัะพะฒ?
   - **ะัะฒะตั:** ะะฐััะฐ ะฟัะพะดะพะปะถะธั ัะฐะฑะพัั, ัะตะบะธ ะฝะฐะบะพะฟัััั ะฒ ะฑััะตัะต (ะดะพ 200), ัะธะฝััะพะฝะธะทะธัััััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ ัะฒัะทะธ

2. โ ะงัะพ ะฟัะพะธะทะพะนะดัั, ะตัะปะธ ะฑััะตั ะทะฐะฟะพะปะฝะธััั ะดะพ 200 ัะตะบะพะฒ?
   - **ะัะฒะตั:** ะะฐััะฐ ะทะฐะฑะปะพะบะธััะตั ะฟัะพะดะฐะถะธ, ะฐะปะตัั P1 ะฐะดะผะธะฝะธัััะฐัะพัั, ััะตะฑัะตััั ะฟัะธะฝัะดะธัะตะปัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั ะธะปะธ hot-patch

3. โ ะงัะพ ะฟัะพะธะทะพะนะดัั ะฟัะธ ะฒะฝะตะทะฐะฟะฝะพะผ ะพัะบะปััะตะฝะธะธ ะฟะธัะฐะฝะธั ะบะฐััั?
   - **ะัะฒะตั:** UPS ะดะฐัั 15 ะผะธะฝ ะฝะฐ graceful shutdown, SQLite `synchronous=FULL` ะณะฐัะฐะฝัะธััะตั ัะพััะฐะฝะฝะพััั ะฟะพัะปะตะดะฝะตะณะพ ัะตะบะฐ

4. โ ะะฐะบ ัะธััะตะผะฐ ะทะฐัะธัะฐะตััั ะพั ะบะฐัะบะฐะดะฝัั ะพัะบะฐะทะพะฒ ะฟัะธ ะฟัะพะฑะปะตะผะฐั ะะคะ?
   - **ะัะฒะตั:** Circuit Breaker ัะฐะทะผัะบะฐะตััั ะฟะพัะปะต 5 ะพัะธะฑะพะบ ะฟะพะดััะด, ะฟัะตะบัะฐัะฐะตั ะฑะตัะฟะพะปะตะทะฝัะต ะฟะพะฟััะบะธ, ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตััั ัะตัะตะท 60ั

5. โ ะะฐะบ ะฟัะตะดะพัะฒัะฐัะฐัััั ะดัะฑะปะธะบะฐัั ัะตะบะพะฒ ะฟัะธ ะบะพะฝะบััะตะฝัะฝะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ?
   - **ะัะฒะตั:** Distributed Lock (Redis) ะณะฐัะฐะฝัะธััะตั, ััะพ ัะพะปัะบะพ ะพะดะธะฝ ะฟัะพัะตัั ัะธะฝััะพะฝะธะทะธััะตั ะฑััะตั, ะฒัะพัะพะน ะฟะพะปััะฐะตั HTTP 409

6. โ ะะฐะบ ัะธััะตะผะฐ ัะฐะทัะตัะฐะตั ะบะพะฝัะปะธะบัั ะฒัะตะผะตะฝะธ ะผะตะถะดั ะบะฐััะฐะผะธ?
   - **ะัะฒะตั:** Hybrid Logical Clock (local_time + logical_counter + server_time) ะณะฐัะฐะฝัะธััะตั ะฟะพััะดะพะบ ัะพะฑััะธะน ะฝะตะทะฐะฒะธัะธะผะพ ะพั NTP

**Sign-off:**
ะะฐัะฐ: __________
ะขะตัะฝะธัะตัะบะธะน ะปะธะดะตั: __________ (ะฟะพะดะฟะธัั)
DevOps: __________ (ะฟะพะดะฟะธัั)
ะะปะฐะดะตะปะตั ะฑะธะทะฝะตัะฐ: __________ (ะฟะพะดะฟะธัั)
