# OpticsERP — 1. Постановка задачи и высокоуровневое планирование

> Версия: 2025‑10‑05 • Статус: актуально • Обновлено: offline-first стратегия

## 1.1 Назначение
Цель документа — зафиксировать цели, границы, ожидаемую ценность и стратегию внедрения решения для сети оптик на базе **Odoo Community** без использования проприетарных модулей.

## 1.2 Контекст и проблемы
- Разрозненные процессы по точкам (продажи, склад, финансы) приводят к отсутствию единой картины.
- Необходима строгая поддержка требований 54‑ФЗ по фискализации и закрытию смен.
- Требуются отраслевые сущности (рецепты, линзы/покрытия, заказы на изготовление).
- **КРИТИЧНО:** Регулярные продолжительные обрывы связи с ОФД требуют архитектуры offline-first с гарантированной фискализацией.
- Команда состоит из одного разработчика, поэтому критичны простота, модульность и воспроизводимость решений.

## 1.3 Цели (SMART) — пересмотр масштабирования

Ниже цели представлены в формате «Цель → Метрика → Срок → Источник данных» с привязкой к **T0** (дата старта проекта указана в шапке документа).

| Цель | Метрика | Срок | Источник данных |
|---|---|---|---|
| **MVP**: POS‑продажа с фискализацией; импорт прайса/остатков; отчёты GP/по точкам; учёт кассы по точкам; **офлайн-режим** | Фискализация чеков работает в офлайн/онлайн; **P95 печати чека ≤ 7 с**; **100% чеков фискализируются после восстановления связи**; импорт **10k строк ≤ 2 мин** | До **T0+9 недель** | Логи ККТ/адаптера; SQLite буфер; отчёт импортов |
| **Пилот** на 2 точках (3-4 кассы) | **Бизнес-доступность кассы ≥ 99.5%** (независимо от связи с ОФД); дубликаты чеков = **0**; **≥ 90% кассиров** прошли тренинг; средняя фискализация из буфера ≤ **10 мин** после восстановления | До **T0+13 недель** | Мониторинг бизнес-метрик; журнал офлайн-событий; протокол обучения |
| **Soft Launch** на 5 точках (10 касс) | **НОВЫЙ ЭТАП:** проверка масштаба архитектуры; PostgreSQL connections <150; Celery queue <30; средняя нагрузка 1000 чеков/день; выявление узких мест | До **T0+15 недель** | Capacity metrics (Grafana); PostgreSQL stats; Celery Flower |
| **Продуктив** на 20 точках (40 касс) | Ввод в эксплуатацию; утверждённые регламенты; **RTO ≤ 1 ч**, **RPO ≤ 24 ч**; средняя нагрузка 4000 чеков/день | До **T0+19 недель** | Регламенты; отчёт ввода в эксплуатацию; журнал DR |

**Обоснование Soft Launch:**
- Проверка узких мест архитектуры (PostgreSQL, Celery, сеть) перед полным развёртыванием
- Снижение риска массовых отказов при скачке 2→20 точек
- Время на оптимизацию и capacity planning

## 1.4 Область проекта
**Включено:**
- POS, склад, продажи, закупки.
- Интеграция с ККТ/ОФД по 54‑ФЗ.
- **Офлайн-режим с локальным буфером (≥200 чеков).**
- **Автономная работа кассы при обрыве связи с Odoo/ОФД.**
- Импорт из Excel (каталоги, прайсы, остатки).
- Отчёты по прибыли (GP) и прибыли по точкам.
- Кассовые счета по точкам.
- Заказы на изготовление для оптики.
- Электронные чеки (email/SMS, ФФД 1.2).
- Скидки/купоны и правила округления.
- Частичная оплата/предоплата.
- Аннулирование чека.

**Out of Scope (MVP):**
- Полноценный бухгалтерский контур РФ (кроме минимального учёта денег).
- Сложные сценарии CRM.

**Future work:**
- Расширенная поддержка маркировки «Честный Знак» (включается позже при необходимости).

## 1.5 Ключевые результаты (OKR)
- **O1.** Единая номенклатура и справочники: заполненность SKU/EAN ≥ 95%.
- **O2.** Корректная фискализация чеков (ФФД): 0 нерегистрируемых продаж, **100% доставка из офлайн-буфера**.
- **O3.** Еженедельные автоматические отчёты по GP и прибыли по точкам.
- **O4.** **Автономность кассы: работа без связи с Odoo/ОФД ≥8 часов без потери функционала.**

## 1.6 Заинтересованные стороны
- Владельцы сети — доступ к данным о прибыли и сравнении точек.
- Руководители салонов — оперативная отчётность и регламент закрытия смен.
- Кассиры — быстрый и надёжный чек, **понятная индикация офлайн-режима**.
- Отдел закупок — актуальные цены и остатки поставщиков.

## 1.7 Высокоуровневая стратегия

### Базовая архитектура
- Базовая платформа — Odoo Community 17; контейнерное развёртывание.
- Кастомные модули: `optics_core`, `optics_pos_ru54fz`, `connector_b`, `ru_accounting_extras`.
- Интеграция с ККТ — через локальный агент с очередностью и повторами.
- Этапность ввода: Разработка → MVP → Пилот → Продуктив.

### Стратегия отказоустойчивости (Offline-First)

**Архитектурный принцип:** касса функционирует автономно при любом состоянии сети.

```
┌─────────────┐    async/queue    ┌──────────────┐    sync      ┌─────────┐
│    Odoo     │◄─────events───────│   Adapter    │───USB/TCP────▶│   ККТ   │
│  (master)   │──────commands────▶│   (worker)   │◄──────────────│         │
└─────────────┘                   └──────────────┘               └─────────┘
                                         │
                                    ┌────▼─────┐
                                    │  SQLite  │ ← офлайн-буфер (200+ чеков)
                                    │  buffer  │   + кэш каталога (1000 SKU)
                                    └──────────┘
```

**Ключевые принципы:**
1. **Фискализация**: двухфазный коммит
   - Фаза 1: чек сохраняется локально (SQLite) + печатается
   - Фаза 2: отправка в ОФД (синхронно или из буфера)
   
2. **Синхронизация**: автоматическая при восстановлении связи
   - Экспоненциальный backoff для повторов
   - **Circuit Breaker** для ОФД (защита от каскадных отказов)
   - Гарантия порядка чеков (по Hybrid Logical Clock)
   - Приоритет: фискализация > импорты > отчёты

3. **Конфликты**: Event Sourcing + модель разрешения (см. §1.13)
   - Локальный чек всегда валиден
   - Timestamp через Hybrid Logical Clock (не зависит от NTP)
   - Изменения цен блокируются при несинхронизированном буфере

4. **Автономность адаптера ККТ**:
   - Отдельный контейнер/процесс на кассовом терминале
   - Локальный кэш последних 1000 товаров + цены
   - Heartbeat к Odoo каждые 30с, автономный режим при сбое
   - Fallback: поиск товара в кэше → запрос к Odoo (timeout 2с) → ручной ввод

## 1.13 Модель разрешения конфликтов (CRDT-inspired)

### Принципы (базируется на Conflict-free Replicated Data Types)

1. **Hybrid Logical Clock (HLC)** для timestamp:
   - Локальный timestamp (монотонный счётчик, не зависит от NTP)
   - Серверный timestamp (при синхронизации присваивается Odoo)
   - Логический счётчик (для разрешения конфликтов при равных timestamp)
   - **Преимущества**: работает даже при полном отказе NTP, гарантирует строгий порядок событий

2. **Last-Write-Wins (LWW)** для мастер-данных:
   - Цены, остатки, описания товаров
   - Побеждает запись с бóльшим server_timestamp

3. **Event Sourcing** для транзакций:
   - Продажи, возвраты, корректировки
   - Локальные события неизменяемы (append-only)
   - Конфликты разрешаются через sequence_number

4. **Eventual Consistency** для аналитики:
   - Отчёты пересчитываются после полной синхронизации
   - Помечаются статусом "syncing" до завершения

### Конфликтные сценарии и стратегии разрешения

| Конфликт | Стратегия | Пример | Процедура пост-фактум |
|----------|-----------|--------|----------------------|
| **Продажа в офлайне + остаток = 0 в Odoo** | Физическая продажа побеждает | Касса продала очки, Odoo показывает -1 шт | Остаток → отрицательный, алерт бухгалтеру, инвентаризация в течение 24ч |
| **Возврат несинхронизированного чека** | Блокировка возврата до синхронизации оригинала (Saga Pattern) | "Чек не найден в системе, повторите через 10 мин" | Автоматический retry каждые 5 мин (max 12 попыток = 1 час) |
| **Импорт новых цен + несинхронизированный буфер** | Блокировка импорта + алерт "Дождитесь синхронизации" | Защита от продажи по старой цене после импорта | Принудительная синхронизация всех буферов → импорт разрешён |
| **Два терминала продали последний товар** | Оба чека валидны (приоритет выручке) | Защита выручки > точность остатков | Остаток → -1, корректировка через инвентаризацию, уведомление менеджера |
| **Изменение цены во время офлайна** | Импорт блокируется | Касса в офлайне 4ч, за это время импортированы новые цены | После синхронизации: сверка проданных товаров с новыми ценами, корректирующие проводки если разница >5% |
| **Рассинхронизация времени (NTP drift >10с)** | Hybrid Clock защищает | ККТ показывает 14:00, сервер 14:10 | Server_timestamp авторитетный, local_timestamp для локального упорядочивания, logical_counter для tie-break |

### Hybrid Logical Clock (детально)

**Структура timestamp:**
```python
@dataclass
class HybridTimestamp:
    local_time: int        # Unix timestamp (секунды) локальной системы
    logical_counter: int   # Монотонный счётчик для разрешения конфликтов
    server_time: Optional[int] = None  # Присваивается Odoo при синхронизации
    
    def __lt__(self, other):
        # Порядок сравнения:
        # 1. Server_time (если оба присвоены)
        # 2. Local_time (если server_time отсутствует)
        # 3. Logical_counter (при равных timestamp)
        if self.server_time and other.server_time:
            if self.server_time != other.server_time:
                return self.server_time < other.server_time
        elif self.local_time != other.local_time:
            return self.local_time < other.local_time
        return self.logical_counter < other.logical_counter
```

**Пример использования:**
```python
# Чек создаётся на кассе
receipt = Receipt(
    id=uuid.uuid4(),
    hlc=HybridTimestamp(
        local_time=int(time.time()),    # 1696518225 (локальное время)
        logical_counter=get_next_counter(),  # 42 (монотонный счётчик)
        server_time=None                # Будет присвоено при синхронизации
    )
)

# При синхронизации с Odoo
receipt.hlc.server_time = odoo_server_time()  # 1696518235 (серверное время, +10с)

# Конфликт: два чека с одинаковым local_time
receipt_a.hlc = HybridTimestamp(1696518225, 42, None)
receipt_b.hlc = HybridTimestamp(1696518225, 43, None)
# Порядок: receipt_a < receipt_b (по logical_counter)
```

### Процедура корректировки post-factum

**Ежедневная автоматическая сверка (cron 03:00):**
```python
def daily_reconciliation():
    # 1. Сверка физических остатков vs Odoo
    discrepancies = []
    for product in products:
        physical = get_physical_stock(product.sku)
        system = product.qty_available
        diff = abs(physical - system)
        
        if diff > 0:
            discrepancies.append({
                'sku': product.sku,
                'physical': physical,
                'system': system,
                'diff': diff,
                'value': diff * product.cost
            })
    
    # 2. Автоматическая корректировка (если расхождение ≤5 шт ИЛИ ≤10% стоимости)
    for disc in discrepancies:
        if disc['diff'] <= 5 or disc['value'] / (disc['system'] * disc['cost']) <= 0.1:
            create_stock_adjustment(disc['sku'], disc['physical'] - disc['system'], 
                                   reason='daily_reconciliation')
            log_event('stock_corrected', disc)
        else:
            # 3. Эскалация для ручной инвентаризации
            create_inventory_task(disc['sku'], reason='large_discrepancy')
            send_alert(f"Требуется инвентаризация {disc['sku']}: расхождение {disc['diff']} шт", 
                      level='P2', assignee='manager')
```

**Сверка после длительного офлайна (>8ч):**
```python
def post_offline_reconciliation(pos_id, offline_duration_hours):
    # 1. Проверка синхронизации всех чеков
    pending = get_pending_receipts(pos_id)
    if pending:
        send_alert(f"POS-{pos_id}: {len(pending)} чеков ещё не синхронизированы", level='P2')
        return False
    
    # 2. Сверка цен (для чеков, проданных в офлайне)
    offline_receipts = get_receipts_during_offline(pos_id, offline_duration_hours)
    price_discrepancies = []
    
    for receipt in offline_receipts:
        for line in receipt.lines:
            current_price = get_current_price(line.sku)
            if line.price != current_price:
                diff_pct = abs(line.price - current_price) / current_price
                if diff_pct > 0.05:  # >5% разница
                    price_discrepancies.append({
                        'receipt_id': receipt.id,
                        'sku': line.sku,
                        'sold_price': line.price,
                        'current_price': current_price,
                        'diff_pct': diff_pct
                    })
    
    # 3. Корректирующие проводки (если критичное расхождение)
    if price_discrepancies:
        create_price_adjustment_journal(price_discrepancies)
        send_alert(f"POS-{pos_id}: {len(price_discrepancies)} позиций с расхождением цен >5%",
                  level='P2', assignee='accountant')
    
    return True
```

## 1.14 Стратегия масштабирования (0 → 20 точек)

### Траектория масштабирования

```
Стенд (POC/MVP) → Пилот (2 точки, 4 кассы) → Soft Launch (5 точек, 10 касс) → Прод (20 точек, 40 касс)
     0 касс              4 кассы                    10 касс                         40 касс
                    Бизнес-валидация          Масштаб-валидация            Полное развёртывание
```

### Горизонтальное масштабирование компонентов

| Компонент | До 10 касс | 10-20 касс | 20-40 касс | 40+ касс |
|-----------|------------|------------|------------|----------|
| **PostgreSQL** | Вертикально: 4 vCPU, 16GB RAM | 8 vCPU, 32GB RAM | 16 vCPU, 64GB RAM | Read replicas + шардирование |
| **Odoo workers** | 8 workers (2×CPU) | 16 workers | 32 workers | HAProxy + балансировка |
| **Celery workers** | 2 default + 2 critical | 4 default + 4 critical | 6 default + 6 critical | Автоскейлинг по queue length |
| **Redis** | Одиночный | Одиночный | Redis Sentinel (HA) | Redis Cluster |
| **Nginx** | Одиночный | Одиночный | Два инстанса (active-active) | CDN для статики |

### Узкие места и метрики мониторинга

| Компонент | Лимит (10 касс) | Лимит (40 касс) | Мониторинг | Масштабирование при |
|-----------|-----------------|-----------------|------------|-------------------|
| **PostgreSQL connections** | 100 (10 касс × 10 conn) | 400 (40 касс × 10 conn) | `pg_stat_activity` | >150 conn → pgbouncer |
| **Odoo API throughput** | 25 rps (10 касс × 2.5 rps) | 100 rps (40 касс × 2.5 rps) | Nginx access logs | >80 rps → +workers |
| **ОФД API throughput** | 20 rps (лимит провайдера?) | 80 rps | Adapter logs | >60 rps → батчинг |
| **Celery critical queue** | 100 задач (10 касс × 10 чеков avg) | 400 задач | Celery Flower | >200 задач → +2 workers |
| **SQLite буферов (суммарно)** | 2000 чеков (10 касс × 200) | 8000 чеков | Custom metrics | >5000 чеков → алерт P1 |

### Capacity Planning по этапам

**Пилот (2 точки, 4 кассы):**
- Средняя нагрузка: **300 чеков/день** (75 чеков/касса)
- Пиковая: **5 rps** (в час пик 12:00-13:00)
- PostgreSQL: **40 connections** (4 кассы × 10)
- Celery queue: **≤20 задач**
- **Цель:** проверка бизнес-процессов, UX, обучение

**Soft Launch (5 точек, 10 касс):**
- Средняя нагрузка: **1000 чеков/день** (100 чеков/касса)
- Пиковая: **15 rps**
- PostgreSQL: **100 connections** (10 касс × 10)
- Celery queue: **≤50 задач**
- **Цель:** выявление узких мест (PostgreSQL slow queries, Celery backlog, network latency)
- **Критичные метрики для перехода к проду:**
  - PostgreSQL query time P95 < 50ms
  - Celery critical queue < 30 задач (95% времени)
  - Odoo response time P95 < 500ms
  - Нет OOM (Out of Memory) за 2 недели

**Продуктив (20 точек, 40 касс):**
- Средняя нагрузка: **4000 чеков/день** (100 чеков/касса)
- Пиковая: **60 rps**
- PostgreSQL: **400 connections** → **pgbouncer обязателен** (pool 100, transaction mode)
- Celery queue: **≤200 задач**
- **Масштабирование:** готовность к росту до 50 точек (100 касс) без архитектурных изменений

### Процедура перехода между этапами (Gate Criteria)

**Пилот → Soft Launch:**
- [ ] Бизнес-доступность ≥99.5% на пилоте (2 недели)
- [ ] 0 блокирующих дефектов
- [ ] ≥90% кассиров обучены
- [ ] Регламенты X/Z + офлайн утверждены
- [ ] Sign-off владельца бизнеса

**Soft Launch → Продуктив:**
- [ ] PostgreSQL query time P95 < 50ms (на Soft Launch)
- [ ] Celery critical queue < 30 задач (95% времени)
- [ ] Нет OOM/CPU throttling за 2 недели
- [ ] Capacity plan для 40 касс утверждён
- [ ] Процедура добавления новой кассы задокументирована
- [ ] Sign-off технического лидера + DevOps

### Capacity Headroom (запас мощности)

**Правило:** поддерживать **30% запас** для каждого ресурса

| Ресурс | Текущая утилизация | Порог масштабирования | Headroom |
|--------|-------------------|----------------------|----------|
| PostgreSQL CPU | 70% | Добавить vCPU | 30% |
| PostgreSQL connections | 70% (140/200) | Внедрить pgbouncer | 30% |
| Odoo workers memory | 70% | +2 workers | 30% |
| Celery queue length | 70% (14/20 avg) | +2 critical workers | 30% |

**Мониторинг headroom:**
```yaml
# Prometheus alert
- alert: CapacityHeadroomLow
  expr: (resource_used / resource_total) > 0.7
  for: 1h
  labels:
    severity: P2
  annotations:
    summary: "{{ $labels.resource }} headroom < 30%"
    description: "Приближение к лимиту, требуется масштабирование"
```

## 1.8 Критерии готовности этапов

**Трассировка:** критерии связаны с матрицей **F→UAT** (Док. 2, §2.6); Must‑требования покрыты UAT не менее чем на **95%**.

### MVP
- **≥ 95% UAT** пройдено (для Must), **0 блокирующих дефектов**
- Успешная продажа с фискализацией (онлайн + офлайн)
- **Офлайн-буфер:** работа 8ч без связи, накопление ≥50 чеков, синхронизация ≤10 мин
- Импорт каталога и остатков; отчёт **GP**
- Учёт кассовых счетов по точкам
- **P95 печати чека ≤ 7 с** (независимо от связи с ОФД)
- Импорт **10k строк ≤ 2 мин**
- **Дубликаты чеков = 0** (проверено на 200+ чеках)
- **100% чеков доставлены из буфера** после восстановления связи

### Пилот
- Все критерии **MVP**
- **Бизнес-доступность кассы ≥ 99.5%** (касса работает, независимо от связи)
- **Системная доступность ОФД:** мониторинг, но не блокирует продажи
- Обученные кассиры (**≥ 90%** прошли тренинг и сдали тест)
- Утверждённый регламент **X/Z‑отчётов** и работы с офлайн-буфером
- Повторно: **≥ 95% UAT**, **0 блокирующих дефектов**, **дубликаты чеков = 0**
- **Stress-test:** 2 кассы × 8ч офлайн × 50 чеков = 100 чеков в буфер → синхронизация без потерь

### Продуктив
- Все критерии **Пилота**
- Регламенты поддержки, мониторинг и бэкапы
- **RTO ≤ 1 ч**, **RPO ≤ 24 ч**
- Масштабирование на 20 точек (40 касс)
- **Нагрузочный тест:** 20 касс × 100 чеков/день → 2000 чеков без деградации

## 1.9 Риски и меры

| ID | Риск | Вероятность | Влияние | Меры предосторожности |
|----|------|-------------|---------|----------------------|
| **R1** | Сложность соответствия 54‑ФЗ при офлайне | Средняя | Критичное | Ранний POC-4 (длительный офлайн); консультация с ОФД; тестирование на реальном ККТ |
| **R2** | Недостоверные прайсы от поставщиков | Высокая | Среднее | Валидация и превью импорта; профили маппинга; алерты на критичные расхождения |
| **R3** | Ограниченные ресурсы (1 разработчик) | Высокая | Среднее | Фокус на MVP; жесткая приоритизация; использование готовых модулей Odoo |
| **R4** | Маркировка | Низкая | Низкое | Feature flag; параметризация; отложить до продуктива |
| **R5** | **Переполнение офлайн-буфера (>200 чеков)** | **Средняя** | **Критичное** | **Алерт при 80% (160 чеков); блокировка касс при 100%; процедура экстренной синхронизации** |
| **R6** | **Рассинхронизация времени ККТ** | Низкая | Высокое | Обязательная NTP-синхронизация; мониторинг drift; алерт при >5с расхождения |
| **R7** | **ФН заполнен во время офлайна** | Низкая | Критичное | Алерт "До конца ФН <100 чеков"; процедура замены ФН с синхронизацией буфера |

## 1.10 Метрики успеха

### Показатели и цели

**Бизнес-метрики (приоритет 1):**
- **Бизнес-доступность кассы:** ≥ **99.5%** (касса работает, печатает чеки, принимает оплату)
- **Доля потерянных чеков:** **0%** (все чеки фискализируются, включая из буфера)
- **Время восстановления продаж при сбое:** ≤ **5 мин** (переход в офлайн-режим автоматический)

**Технические метрики (приоритет 2):**
- **P95 печати чека:** ≤ **7 с** (от «Оплатить» до печати, независимо от связи с ОФД)
- **Системная доступность ОФД:** мониторинг, но НЕ влияет на бизнес-метрики
- **Офлайн-буфер:**
  - Синхронизация 200 чеков ≤ **10 мин** после восстановления
  - **100% доставка** чеков из буфера (допустимо ≤1% с ручной эскалацией)
  - Время до переполнения буфера ≥ **8 часов** при средней нагрузке (25 чеков/час)
- **Доля чеков с ретраями:** ≤ **0.5%** (повторная отправка в ОФД)
- **Дубликаты чеков:** **0** (идемпотентность по receipt_id)

**Операционные метрики:**
- **Импорт данных:** **10k строк ≤ 2 мин** (превью + upsert)
- **Формирование отчёта GP:** ≤ **30 с**
- **Восстановление:** **RTO ≤ 1 ч**, **RPO ≤ 24 ч**
- **Точность остатков:** ≥ **98%**
- **MTTR инцидента ККТ:** < **1 ч** на пилоте

### Таблица метрик и источников

| Метрика | Цель | Источник данных | Частота проверки |
|---------|------|-----------------|------------------|
| Бизнес-доступность кассы | ≥ 99.5% | Heartbeat кассы к мониторингу | Реалтайм |
| Доля потерянных чеков | 0% | Сверка SQLite буфера vs ОФД | Ежечасно |
| П95 печати чека | ≤ 7 с | Логи адаптера ККТ | Реалтайм |
| Синхронизация буфера | ≤ 10 мин (200 чеков) | Логи адаптера + ОФД API | После каждой синхронизации |
| Доставка из буфера | 100% | Отчёт синхронизации | После каждой синхронизации |
| Доля чеков с ретраями | ≤ 0.5% | Логи адаптера ККТ | Ежедневно |
| Импорт 10k строк | ≤ 2 мин | Отчёт импортов (UI/логи) | Каждый импорт |
| Отчёт GP | ≤ 30 с | Odoo / SQL‑метрики | Еженедельно |
| RTO | ≤ 1 ч | План DR / отчёты восстановления | Ежемесячный тест |
| RPO | ≤ 24 ч | Политика бэкапов / журнал задач | Ежедневная проверка |

### Error budget (бизнес-доступность, пилот)
- **Бюджет недоступности:** **0.5%** в бизнес‑часы (касса не может принять платеж/напечатать чек)
- Пример: 4 недели × 5 дн × 10 ч = **200 ч**; допустимый простой = **1 ч**
- **Порог предупреждения:** срабатывает при **50%** исчерпания бюджета (≥ 30 мин простоя в периоде)
- **ВАЖНО:** проблемы со связью с ОФД НЕ учитываются в error budget (офлайн-режим покрывает)

### Критичные для бизнеса сценарии

| Сценарий | Текущее поведение | RTO | Источник валидации |
|----------|-------------------|-----|-------------------|
| Обрыв связи с ОФД в момент продажи | Чек печатается локально, фискализация в буфер, клиент получает товар | **0 мин** | UAT-05c, POC-4 |
| Падение адаптера ККТ | Автоперезапуск контейнера, восстановление из SQLite | **≤2 мин** | Мониторинг, UAT-05a |
| Падение Odoo | Касса работает автономно из локального кэша (1000 товаров) | **0 мин** | POC-4, stress-test |
| Обрыв связи >8ч | Накопление в буфере (до 200 чеков), алерт при 80%, блокировка при 100% | **N/A** | POC-4, регламент |
| Переполнение буфера (201 чек) | Блокировка новых продаж, алерт P1, экстренная синхронизация | **≤15 мин** | POC-4, процедура |
| ФН заполнен во время офлайна | Алерт "До конца ФН <100 чеков", процедура замены с синхронизацией буфера | **≤1 ч** | Регламент, UAT-05b |

## 1.11 Коммуникации и артефакты
- Репозиторий с модулями и документацией.
- Еженедельный краткий отчёт о статусе (включая метрики офлайн-режима).
- CHANGELOG на каждый релиз.
- **Дашборд мониторинга:** реалтайм-метрики офлайн-буферов всех касс.

## 1.12 Глоссарий терминов офлайн-режима

- **Бизнес-доступность** — способность кассы принять платеж и напечатать чек (независимо от связи с облаком)
- **Системная доступность** — доступность связи с Odoo/ОФД (НЕ влияет на продажи)
- **Офлайн-буфер** — локальная очередь чеков в SQLite на кассовом терминале (ёмкость 200+)
- **Синхронизация** — процесс отправки чеков из буфера в ОФД после восстановления связи
- **Heartbeat** — периодическая проверка связи адаптера ККТ с Odoo (каждые 30с)
- **Автономный режим** — работа адаптера ККТ без связи с Odoo (из локального кэша)
- **Двухфазный коммит** — сохранение чека локально + отправка в ОФД (две независимые фазы)