## 4.1 Дорожная карта (обновлено с учетом offline-first + Soft Launch)

Масштаб: **20 точек, 1–2 кассы на точку**. **T0 = дата старта проекта** (будет указана в шапке). Ниже приведены календарные диапазоны при **T0 = 06.10.2025 (пн)** — после фиксации другой даты пересчёт выполняется автоматически в планировании.

| Этап | Начало | Конец | Owner | Entry (вход) | Exit (выход) | Ключевые результаты |
|---|---|---|---|---|---|---|
| **POC** | 06.10.2025 | **09.11.2025** | __________ | Стенд готов; доступ к ККТ/ОФД; тестовые датасеты ≥10k; **эмуляция 8ч офлайна**; **эмуляция split-brain** | **POC-4 и POC-5 пройдены (100%)**; метрики POC достигнуты; отчёт POC; список рисков (Go/No‑Go) | Эмулятор ККТ + Odoo‑клиент; импорт Excel (1 профиль); заказ на изготовление (демо‑цикл); **офлайн-буфер SQLite + синхронизация**; **Circuit Breaker**; **Hybrid Clock** |
| **MVP** | 10.11.2025 | **07.12.2025** | __________ | Все Exit POC выполнены; **офлайн-архитектура спроектирована**; **Hybrid Clock реализован** | UAT (Must) ≥ 95%; **дубликаты чеков = 0**; импорт **10k ≤ 2 мин**; **UAT-08/09/10/11 пройдены**; отчёты готовы; **Saga Pattern для возврата** | Продажа/возврат с фискализацией (online+offline); импорт каталога/остатков; отчёт GP; кассовые счета; **автономный адаптер ККТ**; **Bulkhead Pattern (приоритетные очереди)** |
| **Buffer** | 08.12.2025 | **14.12.2025** | __________ | MVP Exit; список критичных багов; **DoD автоматизирован** | **0 блокирующих дефектов**; доработка офлайн-режима; **нагрузочные тесты (4 сценария)** пройдены; **Rollback протестирован** | Стабильная версия для пилота; документация обновлена; **capacity metrics собраны** |
| **Пилот** | 15.12.2025 | **11.01.2026** | __________ | Buffer sign-off; обучены кассиры; **чек-лист офлайн-режима**; **Decision Tree для L1** | **Бизнес-доступность ≥ 99.5%**; регламенты **X/Z + офлайн**; обучение завершено; **stress-test (2 кассы × 8ч)**; **0 P1 инцидентов за 2 недели** | 2 точки (4 кассы); стабильность чеков ≥ **99.5%**; реальная эксплуатация офлайн-режима |
| **Soft Launch** | 12.01.2026 | **25.01.2026** | __________ | Пилот sign-off; **capacity plan утверждён**; **процедура добавления кассы** задокументирована | **PostgreSQL query P95 <50ms**; **Celery critical queue <30 задач (95% времени)**; **0 OOM за 2 недели**; **throughput 1000 чеков/день** | 5 точек (10 касс); проверка узких мест архитектуры; **оптимизация** перед продом |
| **Прод** | 26.01.2026 | **22.02.2026** | __________ | Soft Launch sign-off; готовность инфраструктуры; **rollback-процедуры**; **pgbouncer настроен** | **RTO ≤ 1 ч; RPO ≤ 24 ч**; мониторинг и бэкапы активны; **масштаб 20 точек (40 касс)**; **throughput 4000 чеков/день** | Развёртывание на сеть; бэкапы офлайн-буферов; мониторинг; регламенты поддержки; **Day 2 Ops** |

**Критичные изменения в дорожной карте:**
- **POC увеличен до 5 недель** (вместо 3) для обязательного POC-4 и POC-5
- **Добавлен этап Soft Launch (2 недели)** между Пилотом и Продом для проверки масштаба
- **MVP увеличен до 4 недель** для качественной реализации offline-архитектуры + Saga Pattern
- **Итого: T0+19 недель** (вместо T0+17 недель в оригинале)

### Зависимости и буферы

| Зависимость | Владелец | Срок | Риск | Митигация |
|-------------|----------|------|------|-----------|
| Провайдер ККТ (песочница + реальное устройство) | Внешний | До T0+1нед | Высокий | Резервный провайдер + эмулятор для разработки |
| Поставщики прайсов (образцы файлов 3+) | Закупки | До T0+2нед | Средний | Синтетические датасеты для POC (см. Док.2 Приложение A) |
| Сертификаты mTLS/JWT | DevOps/Безопасность | До T0+3нед | Средний | Self-signed для POC, валидные для MVP |
| NTP-серверы (корпоративные) | ИТ-отдел | До T0+1нед | Низкий | **Hybrid Clock снижает зависимость от NTP** |
| Хостинг (4 vCPU, 16GB RAM, 100GB NVMe) | DevOps | До T0+2нед | Средний | Cloud VPS как временное решение |
| **Эмуляция обрыва связи (тестовый стенд)** | DevOps | До T0+1нед | Высокий | **КРИТИЧНО для POC-4/POC-5** |
| **UPS для кассовых терминалов** | Закупки | До Пилота | Средний | **Защита от power loss (SQLite коррупция)** |

**Резерв времени:** до **2 недель** на внешние зависимости (уже учтен в дорожной карте).

## 4.2 Бэклог (укрупнённо, с приоритетами)

### Спринт 1-3 (POC, 5 недель)

**Must-have:**
- [ ] **Hybrid Logical Clock**: реализация для timestamp чеков (не зависит от NTP)
- [ ] **Офлайн-буфер (SQLite)**: схема, CRUD, FIFO-логика, `synchronous=FULL`
- [ ] **Circuit Breaker для ОФД**: паттерн с состояниями CLOSED/OPEN/HALF_OPEN
- [ ] **Адаптер ККТ (base)**: FastAPI skeleton, драйвер ККТ (мок + реальный)
- [ ] **Двухфазная фискализация**: локальное сохранение + асинхронная отправка в ОФД
- [ ] **Heartbeat к Odoo**: 30с интервал, автопереход в автономный режим, hysteresis для flapping
- [ ] **POC-1 (ККТ интеграция)**: эмулятор + реальное устройство, 50 операций
- [ ] **POC-2 (Импорт Excel)**: 10k строк, профиль маппинга, превью
- [ ] **POC-3 (Заказ на изготовление)**: демо-цикл, печать бланка
- [ ] **POC-4 (Длительный офлайн)**: 8ч офлайн, 50 чеков, синхронизация, переполнение буфера
- [ ] **POC-5 (Split-brain)**: ложный offline, flapping, конкурентная синхронизация

**Should-have:**
- [ ] Локальный кэш каталога (1000 товаров)
- [ ] Мониторинг-прототип (Prometheus exporter)
- [ ] UI-индикация офлайн-режима (базовая)

**Nice-to-have:**
- [ ] DLQ (Dead Letter Queue) — можно отложить на MVP
- [ ] Алерты (email/telegram) — можно отложить на MVP

### Спринт 4-5 (MVP, 4 недели)

**Must-have (Core):**
- [ ] **optics_core**: модели рецептов/линз, печать бланков
- [ ] **optics_pos_ru54fz**: POS UI, интеграция с адаптером ККТ, X/Z-отчёты
- [ ] **connector_b**: импорт Excel/CSV с профилями маппинга
- [ ] **ru_accounting_extras**: кассовые счета по точкам, отчёт GP

**Must-have (Офлайн + Архитектурные паттерны):**
- [ ] **Синхронизация офлайн-буфера**: фоновый worker (APScheduler), exp backoff
- [ ] **Distributed lock для синхронизации**: Redis-based, предотвращение конкурентных вызовов
- [ ] **UI офлайн-режима**: статус-бар, tooltip, предупреждения 80%/90%/100%
- [ ] **Блокировка при переполнении**: 200 чеков → блокировка продаж + алерт P1
- [ ] **Страница "Офлайн-буфер"** (администратор): список чеков, принудительная синхронизация
- [ ] **DLQ (Dead Letter Queue)**: после 20 неудачных попыток
- [ ] **Блокировка импорта**: при несинхронизированных буферах
- [ ] **Saga Pattern для возврата чека**: обработка несинхронизированного оригинала
- [ ] **Bulkhead Pattern (Celery)**: разделение на critical/high/default/low очереди
- [ ] **Event Sourcing (базовая)**: таблица product_events для аудита

**Must-have (UAT):**
- [ ] **UAT-01/02/03/04**: позитивные сценарии (≥95% покрытие)
- [ ] **UAT-08/09/10b/10c/11**: офлайн-сценарии (100% покрытие)

**Should-have:**
- [ ] Алерты (email/telegram) для критичных событий
- [ ] Электронный чек (email/SMS)
- [ ] Регламент X/Z-отчётов
- [ ] OpenTelemetry трейсинг (базовая инструментация)

### Спринт 6 (Buffer, 1 неделя)

**Must-have:**
- [ ] **Исправление критичных багов** из MVP (0 блокирующих)
- [ ] **Нагрузочные тесты**: сценарии 1-3 (см. §4.2.1) — сценарий 4 упрощён
- [ ] **Доработка офлайн-режима**: по результатам MVP-тестирования
- [ ] **Документация**: обновление всех 5 документов + регламенты
- [ ] **Rollback-процедура**: тестирование на стенде (откат миграций + Docker)
- [ ] **Definition of Done автоматизирован**: CI/CD gate для блокирующих дефектов
- [ ] **Логи архивируются**: настройка logrotate + S3 lifecycle policy

**Should-have:**
- [ ] Оптимизация производительности (если P95 > 7с)
- [ ] Улучшение UX офлайн-режима (по фидбеку)
- [ ] OpenTelemetry + Jaeger (полная инструментация)

### Спринт 7-8 (Пилот, 4 недели)

**Must-have:**
- [ ] **Обучение кассиров**: тренинг + тест (≥90% прохождение)
- [ ] **Регламент работы с офлайн-буфером**: для кассиров и администраторов
- [ ] **Decision Tree для L1/L2**: флоучарт + процедуры A.1-A.4
- [ ] **Stress-test**: 2 кассы × 8ч офлайн × 50 чеков = 100 чеков в буфер
- [ ] **Мониторинг (production)**: дашборд Grafana (4 панели) + алерты
- [ ] **On-call процедура**: дежурство для инцидентов P1, SLA утверждены
- [ ] **Процедура замены ФН**: детальная, с командами (Док.2 §2.10)

**Should-have:**
- [ ] Оптимизация на основе реальных данных пилота
- [ ] Расширение электронного чека (SMS)
- [ ] Маркировка (если требуется)

### Спринт 9 (Soft Launch, 2 недели) — НОВЫЙ ЭТАП

**Цель:** Проверка узких мест архитектуры перед полным развёртыванием

**Must-have:**
- [ ] **Развёртывание на 5 точек (10 касс)**
- [ ] **Capacity metrics сбор**: PostgreSQL, Celery, Odoo workers, сеть
- [ ] **Нагрузочный тест упрощённый (сценарий 4)**: 5 касс, 1000 чеков/день, k6-скрипт
- [ ] **Проверка PostgreSQL**: query time P95 <50ms, connections <150
- [ ] **Проверка Celery**: critical queue <30 задач (95% времени)
- [ ] **Мониторинг OOM**: нет Out of Memory за 2 недели
- [ ] **Процедура добавления кассы**: задокументирована и протестирована (добавить 11-ю кассу)

**Gate Criteria (Soft Launch → Прод):**
- [ ] PostgreSQL query time P95 < 50ms
- [ ] Celery critical queue < 30 задач (95% времени)
- [ ] Нет OOM/CPU throttling за 2 недели
- [ ] Capacity plan для 40 касс утверждён
- [ ] Sign-off технического лидера + DevOps

**Should-have:**
- [ ] Оптимизация slow queries (если есть)
- [ ] Настройка pgbouncer (если connections >150)
- [ ] Автоскейлинг Celery workers (если backlog)

### Спринт 10-11 (Продуктив, 4 недели)

**Must-have:**
- [ ] **Масштабирование на 20 точек**: развёртывание адаптеров ККТ
- [ ] **pgbouncer настройка**: pool 100, transaction mode (если требуется)
- [ ] **Бэкапы офлайн-буферов**: ежедневные snapshot SQLite + S3
- [ ] **Регламенты поддержки**: SLA инцидентов, процедуры эскалации
- [ ] **DR-тестирование**: проверка RTO ≤ 1ч, RPO ≤ 24ч
- [ ] **Документация эксплуатации**: руководство администратора, runbook (20+ сценариев)
- [ ] **Day 2 Operations**: еженедельные/ежемесячные чек-листы (Док.4 §4.11)

**Should-have:**
- [ ] Автоматизация развёртывания (Ansible/Terraform)
- [ ] Расширенная аналитика (дашборды для бизнеса)
- [ ] CDN для статики (если нужно)

### 4.2.1 Нагрузочные тесты (обязательно перед Пилотом)

**Сценарий 1: Множественные кассы в офлайне**
- **Цель:** проверить поведение при одновременной работе 2 касс в офлайне
- **Параметры:** 2 кассы, 8ч офлайн, 50 чеков/касса → 100 чеков в буферах
- **Проверки:**
  - Оба буфера корректно накапливают чеки
  - Синхронизация после восстановления: 100 чеков ≤ 10 мин
  - Нет конфликтов по receipt_id (уникальность через Hybrid Clock)
  - Порядок чеков сохранен (по server_timestamp после синхронизации)
- **Метрики успеха:** 100% доставка, 0 дубликатов, RTO синхронизации ≤ 10 мин

**Сценарий 2: Переполнение буфера**
- **Цель:** проверить блокировку продаж при 200 чеках
- **Параметры:** 1 касса, накопление 201 чека (искусственно)
- **Проверки:**
  - Чек №200 успешно сохраняется
  - Алерт P2 отправлен при чеке №160 (80%)
  - Алерт P1 отправлен при чеке №200 (100%)
  - Попытка чека №201 блокируется
  - UI показывает сообщение "Буфер переполнен"
  - Circuit Breaker в состоянии OPEN (защита от бесполезных попыток)
  - Экстренная синхронизация разблокирует кассу
- **Метрики успеха:** блокировка работает, алерты срабатывают, RTO разблокировки ≤ 15 мин

**Сценарий 3: Синхронизация 200 чеков за ≤10 мин**
- **Цель:** проверить производительность синхронизации
- **Параметры:** 200 чеков в буфере, восстановление связи с ОФД
- **Проверки:**
  - Throughput ≥ 20 чеков/мин (P50)
  - P95 ≥ 15 чеков/мин
  - Общее время синхронизации ≤ 10 мин
  - Нет ошибок в ОФД (или <1% с автоматическим ретраем)
  - Circuit Breaker переходит из OPEN → HALF_OPEN → CLOSED
  - Distributed lock предотвращает конкурентную синхронизацию
- **Метрики успеха:** 200 чеков доставлены за ≤ 10 мин, ≥99% успешных без ручного вмешательства

**Сценарий 4 (упрощённый): Масштаб Soft Launch (5 касс)**

**Обоснование упрощения:** 
- Эмуляция 20 касс требует сложной инфраструктуры (недоступна для 1 разработчика за Buffer-неделю)
- 5 касс достаточно для выявления узких мест архитектуры
- Полный масштаб (40 касс) будет проверен на реальном Soft Launch

**Параметры:**
- **5 касс** (эмуляция через Docker Compose)
- 200 чеков/касса/день = **1000 чеков/день**
- Длительность теста: **2 часа** (симуляция рабочего дня)
- Профиль нагрузки: **60% online, 30% degraded, 10% offline**

**Инфраструктура (Docker Compose):**
```yaml
# docker-compose.loadtest.yml

version: '3.8'

services:
  # 5 эмулированных касс
  kkt-simulator-1:
    build: ./tests/load/kkt_simulator
    environment:
      - POS_ID=POS-LOAD-001
      - TARGET_RPS=0.5  # 1 чек каждые 2 секунды
      - OFFLINE_RATIO=0.1
      - DEGRADED_RATIO=0.3
    depends_on:
      - kkt-adapter-1
  
  kkt-simulator-2:
    environment:
      - POS_ID=POS-LOAD-002
      - TARGET_RPS=0.5
    # ... аналогично для 2-5
  
  # Генератор нагрузки (k6)
  load-generator:
    image: grafana/k6:latest
    volumes:
      - ./tests/load/scenarios:/scripts
    command: run --vus 5 --duration 2h /scripts/pos_load.js
    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6
```

**k6-скрипт (генератор нагрузки):**
```javascript
// tests/load/scenarios/pos_load.js

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';

const errorRate = new Rate('errors');
const receiptLatency = new Trend('receipt_latency');

export let options = {
  vus: 5,  // 5 виртуальных касс
  duration: '2h',
  thresholds: {
    'http_req_duration': ['p(95)<7000'],  // P95 < 7с
    'errors': ['rate<0.01'],              // Error rate < 1%
    'receipt_latency': ['p(95)<7000'],    // P95 латентности < 7с
  },
};

export default function () {
  const posId = `POS-LOAD-00${__VU}`;  // POS-LOAD-001 .. POS-LOAD-005
  const receiptId = `${Date.now()}-${__VU}-${__ITER}`;
  
  // Генерация случайного чека
  const receipt = {
    pos_id: posId,
    type: 'sale',
    items: [
      { 
        sku: `SKU${Math.floor(Math.random() * 1000)}`, 
        name: `Товар ${Math.floor(Math.random() * 1000)}`,
        qty: 1, 
        price: Math.random() * 5000 + 1000,
        vat: '20%'
      }
    ],
    payments: [{ method: 'cash', amount: Math.random() * 5000 + 1000 }]
  };
  
  const startTime = Date.now();
  const res = http.post(
    `http://kkt-adapter-${__VU}:8000/v1/kkt/receipt`,
    JSON.stringify(receipt),
    {
      headers: {
        'Content-Type': 'application/json',
        'Idempotency-Key': receiptId
      }
    }
  );
  const latency = Date.now() - startTime;
  receiptLatency.add(latency);
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'no duplicates': (r) => r.json().status !== 'duplicate',
    'latency < 7s': (r) => latency < 7000,
  }) || errorRate.add(1);
  
  // Пауза между чеками (средний интервал 2 минуты, но рандомизированный)
  sleep(Math.random() * 240 + 60);
}
```

**Метрики успеха (упрощённый сценарий 4):**
- ✅ Odoo справляется с нагрузкой (CPU < 70%, RAM < 70%)
- ✅ PostgreSQL не деградирует (avg query time < 50ms)
- ✅ Celery critical queue < 30 задач (95% времени)
- ✅ Все 1000 чеков фискализируются (≥99% успешных)
- ✅ P95 латентности < 7с (из k6-отчёта)
- ✅ Error rate < 1%
- ✅ Нет OOM (Out of Memory) за 2 часа теста

**Сбор метрик (Prometheus + Grafana):**
```yaml
# prometheus.yml (для load test)
scrape_configs:
  - job_name: 'kkt-adapters'
    static_configs:
      - targets: ['kkt-adapter-1:9090', 'kkt-adapter-2:9090', ...]
    scrape_interval: 10s
  
  - job_name: 'odoo'
    static_configs:
      - targets: ['odoo:8069']
    metrics_path: /metrics
  
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
  
  - job_name: 'celery'
    static_configs:
      - targets: ['celery-exporter:9808']
```

**Отчёт после теста (автоматическая генерация):**
```python
# tests/load/report_generator.py

def generate_load_test_report():
    """
    Генерация отчёта по результатам нагрузочного теста
    
    Источники данных:
    - k6 results (JSON)
    - Prometheus metrics (query API)
    - Docker stats (CPU/RAM)
    """
    report = {
        "test_duration": "2 hours",
        "total_receipts": query_prometheus("sum(kkt_receipts_total)"),
        "p95_latency": query_prometheus("histogram_quantile(0.95, kkt_receipt_latency_seconds)"),
        "error_rate": query_prometheus("rate(kkt_receipts_total{status='error'}[2h])"),
        "odoo_cpu_avg": query_prometheus("avg_over_time(container_cpu_usage[2h])"),
        "postgres_query_p95": query_prometheus("histogram_quantile(0.95, pg_stat_statements_mean[2h])"),
        "celery_queue_max": query_prometheus("max_over_time(celery_queue_length{queue='critical'}[2h])"),
        "bottlenecks": identify_bottlenecks()
    }
    
    # Генерация Markdown-отчёта
    with open('load_test_report.md', 'w') as f:
        f.write(f"# Нагрузочный тест (Сценарий 4)\n\n")
        f.write(f"**Дата:** {datetime.now()}\n\n")
        f.write(f"## Метрики\n\n")
        f.write(f"- Всего чеков: {report['total_receipts']}\n")
        f.write(f"- P95 латентность: {report['p95_latency']}с\n")
        f.write(f"- Error rate: {report['error_rate']:.2%}\n")
        f.write(f"- Odoo CPU (avg): {report['odoo_cpu_avg']:.1%}\n")
        f.write(f"- PostgreSQL query P95: {report['postgres_query_p95']}ms\n")
        f.write(f"- Celery queue (max): {report['celery_queue_max']}\n\n")
        
        if report['bottlenecks']:
            f.write(f"## ⚠️ Узкие места\n\n")
            for bottleneck in report['bottlenecks']:
                f.write(f"- {bottleneck}\n")
        else:
            f.write(f"## ✅ Узких мест не обнаружено\n\n")
    
    return report

def identify_bottlenecks():
    """Автоматическое выявление узких мест"""
    bottlenecks = []
    
    if query_prometheus("avg(container_cpu_usage)") > 0.7:
        bottlenecks.append("Odoo CPU >70% → требуется масштабирование workers")
    
    if query_prometheus("max(celery_queue_length{queue='critical'})") > 30:
        bottlenecks.append("Celery critical queue >30 задач → добавить workers")
    
    if query_prometheus("histogram_quantile(0.95, pg_stat_statements_mean)") > 50:
        bottlenecks.append("PostgreSQL query P95 >50ms → оптимизация slow queries")
    
    return bottlenecks
```

**Экономия времени:** 2 дня (vs 5+ дней на полную эмуляцию 20 касс)

## 4.3 Пререквизиты (обновлено)

### ККТ/ОФД
- **Модель ККТ:** __________________ (указать конкретную модель, например "АТОЛ 11Ф")
- **Версия ФФД:** 1.2 (обязательно)
- **Доступ в песочницу ОФД/провайдера ККТ:** до T0+1нед
- **Реальное устройство ККТ для POC:** до T0+2нед (критично для POC-1 и POC-4)
- **Документация API ОФД:** полная спецификация, примеры запросов

### Безопасность интеграции
- **Сертификаты mTLS:**
  - Корневой CA-сертификат
  - Клиентские сертификаты для адаптеров ККТ (по 1 на кассу)
  - Срок действия ≥ 1 год
  - Процедура ротации (автоматическая)
- **JWT (JSON Web Tokens):**
  - Secret key (≥256 бит, генерация через `openssl rand -base64 32`)
  - TTL = 15 мин
  - Процедура обновления токенов
- **Сервис-аккаунты:**
  - Для адаптера ККТ (роль: kkt_worker)
  - Для Celery (роль: background_worker)
  - Минимальные привилегии (принцип least privilege)
- **Сетевые разрешения (whitelist):**
  - Адреса ОФД (указать конкретные IP/домены)
  - NTP-серверы (например, `ntp.ubuntu.com`, `time.google.com`)
  - Репозитории обновлений (Odoo, PyPI, Docker Hub)
  - Внутренние адреса (Odoo ↔ адаптер ККТ)
- **Политика хранения секретов:**
  - Vault (HashiCorp Vault / AWS Secrets Manager) для production
  - `.env` файлы (зашифрованные) для dev/staging
  - Ротация паролей БД каждые 90 дней

### Данные/каталоги
- **Тестовые Excel-датасеты (≥10k строк):**
  - Каталог товаров: 10k позиций
  - Прайс-листы: 3 поставщика × 5k позиций
  - Остатки: 2 склада × 8k позиций
  - **Специально внедренные ошибки:**
    - Дубликаты SKU: 2-5% (200-500 строк)
    - Битые EAN: 1% (100 строк)
    - Пустые обязательные поля: 1% (100 строк)
    - Неверные VAT/валюта: 1% (100 строк)
  - Формат: `.xlsx` или `.csv` (UTF-8 BOM)
- **Ставки НДС:** 20%, 10%, 0%, без НДС (справочник)
- **Правила скидок:**
  - Максимальная скидка: 50%
  - Скидки для кассиров: до 10% без утверждения
  - Купоны/промокоды: структура и валидация
- **Справочник категорий/брендов:** иерархия до 3 уровней

### Инфраструктура
- **Хостинг/сервер:**
  - **Минимум:** 4 vCPU, 16 GB RAM, NVMe SSD 100 GB
  - **Рекомендуемо (прод):** 8 vCPU, 32 GB RAM, NVMe SSD 200 GB
  - **IOPS:** ≥ 3000 (для PostgreSQL и SQLite)
  - **Сеть:** 1 Gbps, стабильный канал
- **Отдельное хранилище для бэкапов:**
  - Объём: ≥ 500 GB (бэкапы БД + офлайн-буферы)
  - Репликация в другой ЦОД (опционально для прод)
- **Кассовые терминалы:**
  - Минимум: 2 vCPU, 4 GB RAM, 20 GB SSD
  - OS: Ubuntu 22.04 LTS или аналог
  - Docker Engine установлен
  - Доступ к ККТ по USB (драйверы установлены) или TCP
- **Эмуляция обрыва связи (тестовый стенд):**
  - Возможность программного отключения сети (`iptables` или сетевой эмулятор)
  - Изолированная подсеть для тестирования офлайн-режима

### Сеть и домены
- **Корпоративный домен:** `optics_erp.local` или публичный (для прод)
- **Валидный TLS-сертификат:** Let's Encrypt или корпоративный CA
- **NTP-синхронизация:**
  - Корпоративные NTP-серверы или публичные (`pool.ntp.org`)
  - Мониторинг drift (алерт при >5с)
  - Автоматическая синхронизация каждые 5 минут
- **Белые списки (firewall):**
  - Исходящий: ОФД, NTP, обновления, Odoo
  - Входящий: только с адресов Odoo (для адаптеров ККТ)
  - Запрещены: все остальные соединения

### Дополнительные пререквизиты для офлайн-режима
- [ ] **SQLite установлен** на кассовых терминалах (версия ≥3.35 для WAL mode)
- [ ] **Тест персистентности:** проверка сохранения данных при перезагрузке
- [ ] **Эмулятор ОФД** для локального тестирования (mock-сервер)
- [ ] **Процедура экстренной синхронизации:** документирована и протестирована
- [ ] **Регламент работы с переполнением буфера:** для техподдержки L1/L2

## 4.4 Объём работ и оценки (1 разработчик)

| Этап | Эффективное время | Календарное время | Примечания |
|------|-------------------|-------------------|------------|
| POC | **3 недели** | 4 недели | +1 неделя на POC-4 (офлайн) |
| MVP | **4 недели** | 4 недели | Интенсивная разработка офлайн-архитектуры |
| Buffer | **0.5 недели** | 1 неделя | Фикс багов + нагрузочные тесты |
| Пилот | **2 недели** | 4 недели | Обучение кассиров + мониторинг реальной эксплуатации |
| Прод | **2 недели** | 4 недели | Развёртывание на 20 точек + документация |
| **Итого** | **11.5 недель** | **17 недель** | С учетом буферов и рисков |

**Разбивка по компонентам (effort, недели):**
- Адаптер ККТ (офлайн-буфер, heartbeat, sync): **2.5 недели**
- Odoo модули (POS, импорт, GP, core): **3 недели**
- UI офлайн-режима (индикация, страницы, алерты): **1 неделя**
- Тестирование (unit, интеграционные, UAT, нагрузочные): **2 недели**
- Мониторинг и алерты (Prometheus, Grafana, настройка): **1 неделя**
- Документация и регламенты: **1 неделя**
- Развёртывание и обучение: **1 неделя**

## 4.5 Критерии приёмки этапов (обновлено)

**Трассировка:** критерии связаны с матрицей **F→UAT** (Док. 2, §2.6); Must‑требования покрыты UAT не менее чем на **95%**.

### POC (Exit-критерии)

**Обязательные метрики:**
- ✅ **POC-1 (ККТ):** P95 печати ≤ 7с, 50 операций на реальном ККТ без дубликатов
- ✅ **POC-2 (Импорт):** 10k строк ≤ 2 мин, отчёт об ошибках с примерами
- ✅ **POC-3 (Заказ):** полный цикл заказа, поиск по штрихкоду ≤ 2с
- ✅ **POC-4 (Офлайн):** 8ч офлайн, 50 чеков, синхронизация ≤ 10 мин, 100% доставка, блокировка при переполнении

**Артефакты:**
- Отчёт POC (PDF/MD) с метриками и скриншотами
- Логи офлайн-буфера (SQLite dump) для POC-4
- Список рисков с оценкой (вероятность × влияние)
- **Go/No-Go решение:** подписано владельцем бизнеса

### MVP (Exit-критерии)

**Обязательные метрики:**
- ✅ **≥ 95% UAT** пройдено (для Must-требований F1-F6)
- ✅ **0 блокирующих дефектов**, ≤ 3 minor
- ✅ **Дубликаты чеков = 0** (проверено на 200+ чеках)
- ✅ **P95 печати чека ≤ 7 с** (независимо от связи с ОФД)
- ✅ **Импорт 10k строк ≤ 2 мин**
- ✅ **Офлайн-режим:**
  - Работа 8ч без связи, накопление ≥50 чеков
  - Синхронизация ≤10 мин после восстановления
  - 100% доставка чеков из буфера
  - Блокировка продаж при переполнении (200 чеков)
- ✅ **UAT-08/09/10/11 (офлайн):** пройдены на 100%

**Артефакты:**
- Протокол UAT с результатами и дефектами
- Логи адаптера ККТ (латентность/ретраи)
- Отчёт импортов (UI screenshot + логи)
- **MVP sign-off:** подписано владельцем бизнеса + техническим лидером

### Buffer (Exit-критерии)

**Обязательные метрики:**
- ✅ **0 блокирующих дефектов** из MVP
- ✅ **Нагрузочные тесты 1-4:** все пройдены успешно
- ✅ **Rollback-процедура:** протестирована на стенде, RTO ≤ 15 мин

**Артефакты:**
- Отчёт нагрузочных тестов (метрики, графики)
- Обновлённая документация (Док. 1-4)
- Rollback runbook (пошаговая инструкция)

### Пилот (Exit-критерии)

**Обязательные метрики:**
- ✅ Все критерии **MVP + Buffer**
- ✅ **Бизнес-доступность кассы ≥ 99.5%** (независимо от связи с ОФД)
- ✅ **Обучение кассиров:** ≥ 90% прошли тренинг и сдали тест
- ✅ **Регламенты:**
  - X/Z-отчёты (утверждены)
  - Работа с офлайн-буфером (инструкции для кассиров и администраторов)
  - Процедура экстренной синхронизации
- ✅ **Stress-test:** 2 кассы × 8ч офлайн × 50 чеков → 100% успешная синхронизация
- ✅ **Повторно:** ≥ 95% UAT, 0 блокирующих дефектов, дубликаты чеков = 0
- ✅ **Реальная эксплуатация:** минимум 2 недели без критичных инцидентов

**Артефакты:**
- Протокол обучения кассиров (посещаемость, результаты тестов)
- Журнал инцидентов пилота (с разбором root cause)
- Метрики доступности (uptime report)
- Отчёт stress-теста
- **Пилот sign-off:** подписано владельцем бизнеса + операционным директором

### Продуктив (Exit-критерии)

**Обязательные метрики:**
- ✅ Все критерии **Пилота**
- ✅ **Масштабирование:** развёрнуто на 20 точек (40 касс)
- ✅ **RTO ≤ 1 ч**, **RPO ≤ 24 ч** (проверено тестом восстановления)
- ✅ **Мониторинг:**
  - Дашборд Grafana активен (4 критичные панели)
  - Алерты настроены (email + telegram)
  - On-call процедура утверждена
- ✅ **Бэкапы:**
  - PostgreSQL: ежедневные (хранение 14+ дней)
  - SQLite офлайн-буферы: ежедневные snapshot
  - Тест восстановления выполнен успешно
- ✅ **Регламенты поддержки:**
  - SLA инцидентов (P1/P2/P3)
  - Процедуры эскалации
  - Контакты L1/L2
  - Runbook для типовых инцидентов

**Артефакты:**
- План развёртывания на 20 точек (выполнен)
- Отчёт DR-тестирования (RTO/RPO)
- Руководство администратора (≥50 страниц)
- Runbook (≥20 сценариев)
- SLA-соглашения (утверждены юридически)
- **Продуктив sign-off:** подписано владельцем бизнеса + финансовым директором

### Владелец приёмки и sign-off

**Роли:**
- **Владелец бизнеса:** __________________ (ФИО, должность)
- **Технический лидер:** __________________ (ФИО, должность)
- **Операционный директор:** __________________ (ФИО, должность)
- **Финансовый директор:** __________________ (ФИО, должность)

**Форма sign-off:**
Единый акт приёмки по этапам (POC/MVP/Buffer/Пилот/Прод) с датой, перечислением артефактов и подписями соответствующих ролей.

## 4.5.1 Definition of Done (DoD) с процедурами верификации

### MVP Exit

| Критерий | Процедура верификации | Автоматизация | Владелец | Время |
|----------|----------------------|---------------|----------|-------|
| **≥ 95% UAT пройдено** | Протокол UAT (Excel) с результатами всех 11 сценариев | Частично (автотесты для UAT-01/03/04) | QA | 2 дня |
| **0 блокирующих дефектов** | Проверка JIRA: `type=Bug AND severity=Blocker AND status!=Closed` | Полностью (JIRA API + CI gate) | QA | 5 мин |
| **Дубликаты чеков = 0** | SQL-запрос по буферу + ОФД API: <br>`SELECT receipt_id, COUNT(*) FROM receipts GROUP BY receipt_id HAVING COUNT(*) > 1` | Полностью (pytest) | Разработчик | 10 мин |
| **P95 печати ≤ 7с** | Анализ трейсов Jaeger за последние 24ч: <br>`SELECT percentile_cont(0.95) WITHIN GROUP (ORDER BY duration) FROM spans WHERE span_name='receipt_create'` | Полностью (Jaeger API) | DevOps | 5 мин |
| **Импорт 10k ≤ 2 мин** | Запуск тестового импорта (10k строк, профиль A): <br>`time curl -X POST /v1/connector/import` | Полностью (pytest) | Разработчик | 2 мин |
| **Офлайн: 8ч, 50 чеков, синхронизация ≤10 мин** | Автотест POC-4 (эмуляция обрыва сети, накопление, синхронизация) | Полностью (pytest + tc qdisc) | Разработчик | 20 мин |
| **UAT-08/09/10b/10c/11 пройдены** | Ручное выполнение офлайн-UAT + скриншоты UI | Частично (backend автотесты) | QA | 4 ч |
| **Hybrid Clock реализован** | Проверка: все чеки имеют hlc.local_time + hlc.logical_counter | Автотест (pytest) | Разработчик | 5 мин |
| **Circuit Breaker работает** | Эмуляция 5 ошибок ОФД подряд → состояние OPEN → 60с → HALF_OPEN | Автотест (pytest + mock ОФД) | Разработчик | 10 мин |
| **Saga Pattern для возврата** | Попытка возврата несинхронизированного чека → HTTP 409 + retry_after_seconds | Автотест (pytest) | Разработчик | 5 мин |

### Автоматизация DoD (CI/CD gate)

```yaml
# .gitlab-ci.yml

mvp-gate:
  stage: validate
  script:
    # 1. Проверка блокирующих дефектов (JIRA API)
    - python scripts/check_jira_blockers.py --project OPTICS_ERP --severity Blocker
    
    # 2. Запуск автотестов UAT
    - pytest tests/uat/test_uat_01_03_04.py --junitxml=report.xml --html=report.html
    
    # 3. Проверка дубликатов чеков (на стенде)
    - python scripts/check_duplicate_receipts.py --db=$TEST_DB_URL --ofd=$TEST_OFD_URL
    
    # 4. Анализ P95 латентности (Jaeger API, последние 24ч на стенде)
    - python scripts/analyze_latency_p95.py --jaeger=$JAEGER_URL --threshold=7000
    
    # 5. Тест импорта 10k строк
    - time pytest tests/integration/test_import_10k.py --timeout=120
    
    # 6. Автотест POC-4 (офлайн-режим, 20 мин)
    - pytest tests/poc/test_poc_4_offline.py --timeout=1200
    
    # 7. Автотест POC-5 (split-brain, 15 мин)
    - pytest tests/poc/test_poc_5_splitbrain.py --timeout=900
    
    # 8. Проверка Hybrid Clock
    - pytest tests/unit/test_hybrid_clock.py
    
    # 9. Проверка Circuit Breaker
    - pytest tests/unit/test_circuit_breaker.py
    
    # 10. Проверка Saga Pattern
    - pytest tests/integration/test_refund_saga.py
    
  artifacts:
    reports:
      junit: report.xml
    paths:
      - report.html
      - metrics/
    expire_in: 30 days
  
  allow_failure: false  # Блокирует deploy если хоть один тест провален
  only:
    - tags  # Запускается только при создании MVP-релиза (git tag mvp-v1.0.0)
```

### Ручная верификация (чек-лист для QA)

```markdown
# MVP Exit Checklist

## Функциональные критерии
- [ ] UAT-01: Позитивная продажа (скриншот чека + запись в БД)
- [ ] UAT-02: Возврат (скриншот + проверка кассового счёта)
- [ ] UAT-03: Импорт прайса (скриншот превью + лог ошибок)
- [ ] UAT-04: Отчёт GP (скриншот + сверка с эталоном)
- [ ] UAT-05: Отказ фискализации (скриншот алерта + буфер)
- [ ] UAT-06: Частичная оплата (скриншот чека)
- [ ] UAT-07: Сбой импорта (скриншот лога + rollback)
- [ ] UAT-08: Офлайн-продажа (скриншот статус-бара + буфер)
- [ ] UAT-09: Длительный офлайн (скриншот синхронизации)
- [ ] UAT-10b: Частичная синхронизация (логи + проверка FIFO)
- [ ] UAT-10c: ОФД недоступен при переполнении (алерт P1 + Circuit Breaker OPEN)
- [ ] UAT-11: Восстановление адаптера (скриншот логов + SQLite восстановление)

## Нефункциональные критерии
- [ ] P95 печати ≤ 7с (скриншот Jaeger traces за 24ч)
- [ ] Импорт 10k ≤ 2 мин (скриншот таймера + UI)
- [ ] Дубликаты чеков = 0 (SQL-результат + ОФД API проверка)
- [ ] Офлайн-синхронизация (видео 50 чеков → ОФД, throughput ≥20 чеков/мин)
- [ ] Circuit Breaker работает (видео эмуляции 5 ошибок ОФД → OPEN → HALF_OPEN → CLOSED)
- [ ] Hybrid Clock (скриншот логов: каждый чек имеет hlc.local_time + hlc.logical_counter)

## Архитектурные паттерны
- [ ] Circuit Breaker (эмуляция недоступности ОФД → состояние OPEN → метрики)
- [ ] Bulkhead Pattern (проверка: critical/high/default/low очереди разделены)
- [ ] Saga Pattern (попытка возврата несинхронизированного чека → HTTP 409)
- [ ] Distributed Lock (конкурентная синхронизация → один процесс получает lock, второй HTTP 409)

## Документация
- [ ] README обновлён (версия, changelog)
- [ ] Руководство администратора актуально (Decision Tree, процедуры)
- [ ] Runbook содержит новые процедуры (замена ФН, переполнение буфера)
- [ ] API-документация сгенерирована (OpenAPI/Swagger)
- [ ] Архитектурные диаграммы обновлены (offline-first, Circuit Breaker, Saga)

## Sign-off
Дата: __________
QA: __________ (подпись)
Разработчик: __________ (подпись)
Технический лидер: __________ (подпись)
Владелец бизнеса: __________ (подпись)
```

## 4.6 Ресурсный план и коммуникации

### Команда
- **Разработчик (1):** full-stack (Python, FastAPI, Odoo, SQLite, PostgreSQL)
- **DevOps (part-time):** инфраструктура, мониторинг, CI/CD
- **QA (part-time):** тестирование UAT, нагрузочные тесты
- **Владелец бизнеса:** приёмка этапов, решения по приоритетам

### Режим работы
- **Канбан** без формального Agile
- **Еженедельные статусы** (пятница, 30 мин):
  - Прогресс по бэклогу
  - Метрики офлайн-режима (если на пилоте/проде)
  - Блокеры и риски
  - План на следующую неделю

### Канал инцидентов
- **Приоритет:** ККТ/продажи (P1)
- **Каналы связи:**
  - P1: телефон + telegram
  - P2: telegram + email
  - P3: email
- **On-call (для пилота/прода):**
  - Дежурство в рабочие часы (9:00-21:00)
  - Response time P1: ≤ 15 мин

## 4.7 Регламенты эксплуатации (обновлено для офлайн-режима)

### Бэкапы и ретенция

**PostgreSQL (Odoo master state):**
- Ежедневный full backup (pg_dump)
- Инкрементальные каждые 6 часов (pg_basebackup + WAL archiving)
- Ретенция: 90 дней (онлайн 30 дней, архив 60 дней)
- Хранилище: изолированное, с проверкой checksum
- **Тестовое восстановление:** еженедельно (выборочное), ежемесячно (полное)

**SQLite (офлайн-буферы на кассовых терминалах):**
- Ежедневный snapshot всех SQLite-файлов (rsync на центральный бэкап-сервер)
- Ретенция: 7 дней (для диагностики инцидентов)
- **ВАЖНО:** перед snapshot выполнять `PRAGMA wal_checkpoint(TRUNCATE)` для консистентности
- **Тестовое восстановление:** еженедельно (1 случайная касса)

**Процедура полного DR:**
1. Восстановление PostgreSQL из последнего backup (RTO ≤ 30 мин)
2. Восстановление Odoo из Docker-образа (RTO ≤ 15 мин)
3. Восстановление SQLite-буферов на кассах (RTO ≤ 15 мин)
4. Проверка: тестовая продажа на каждой кассе
5. **Цель:** RTO ≤ 1 ч, RPO ≤ 24 ч

### Мониторинг, алерты и эскалации

**Ключевые метрики (Prometheus):**
- **Латентность чека (P95):** target ≤ 7с, warning >10с, critical >15с
- **Доля ретраев:** target ≤ 0.5%, warning >1%, critical >5%
- **Error rate:** target <0.1%, warning >0.5%, critical >2%
- **Бизнес-доступность касс:** target ≥ 99.5%, warning <99%, critical <95%
- **Офлайн-буфер (per-terminal):**
  - Заполненность: warning ≥80%, critical ≥90%, emergency 100%
  - Возраст oldest_receipt: warning >4ч, critical >8ч
- **Throughput синхронизации:** target ≥20 чеков/мин, warning <15, critical <10
- **Хвост очереди Celery:** warning >20 задач, critical >50 задач
- **NTP drift:** warning >5с, critical >10с

**Error budget (доступность, пилот):**
- **Бюджет недоступности:** 0.5% в бизнес-часы
- **Расчёт:** 4 недели × 5 дн × 10 ч = 200 ч → допустимый простой = 1 ч
- **Предупреждение:** срабатывает при 50% исчерпания (≥ 30 мин простоя)
- **Действие:** post-mortem при исчерпании ≥80%

**Каналы алертов:**
- **P1 (Critical):** телефон + telegram + email
- **P2 (Warning):** telegram + email
- **P3 (Info):** email

**Эскалация:**
- **P1:** немедленно → on-call инженер → владелец бизнеса (через 30 мин)
- **P2:** в течение 1ч → технический лидер
- **P3:** в течение 24ч → разработчик

### Выпуски, обслуживание и изменения

**Окно обслуживания:**
- **Регулярное:** еженедельно по **ср 02:00-04:00** (локальное время)
- **Экстренное:** по согласованию с бизнесом

**Процедура выпуска:**
1. **Pre-deployment:**
   - Проверка: нет несинхронизированных офлайн-буферов (≥1 чек)
   - Backup PostgreSQL + SQLite
   - Rollback-план подготовлен
   - Уведомление on-call + бизнеса
2. **Deployment:**
   - Остановка приёма новых импортов
   - Rolling update Odoo (zero-downtime)
   - Update адаптеров ККТ (по одному, с проверкой)
   - Миграции БД (forward)
3. **Post-deployment:**
   - Smoke-test: продажа на каждой кассе
   - Проверка офлайн-буферов (статус, размер)
   - Мониторинг метрик 30 мин
   - Уведомление об успешном выпуске

**Rollback-процедура (детально):**
1. **Обнаружение проблемы:**
   - Мониторинг показывает ≥5% ошибок фискализации
   - Критичный баг подтверждён (≤10 мин на диагностику)
2. **Оценка состояния:**
   - Проверка всех офлайн-буферов (API `/v1/kkt/buffer/status`)
   - Если буферы <50% → rollback в окно обслуживания (≤2ч)
   - Если буферы ≥50% → принудительная синхронизация → rollback
3. **Rollback:**
   - Откат Docker-образов (Odoo + адаптер ККТ)
   - Откат миграций БД (down-скрипты Alembic)
   - Очистка несовместимого кэша на кассах (`/data/cache.json`)
   - Перезапуск всех сервисов
4. **Верификация:**
   - Тестовая продажа на каждой кассе
   - Проверка офлайн-буферов (размер не вырос)
   - Мониторинг метрик 30 мин
5. **Post-mortem:**
   - Root cause analysis (≤24ч)
   - План предотвращения (≤48ч)
   - Обновление runbook

**Change management:**
- Заявки на изменение (RFC) с оценкой риска
- Одобрение владельца бизнеса для critical changes
- Post-mortem для всех P1-инцидентов (≤72ч после решения)

### SLA инцидентов и on-call

| Приоритет | Описание | Response time | Resolution time | Update frequency | Эскалация |
|-----------|----------|---------------|-----------------|------------------|-----------|
| **P1 (Critical)** | Блокирующие продажи: касса не принимает оплату, ККТ не печатает, буфер переполнен, ФН переполнен | ≤ 15 мин | ≤ 1 ч | Каждые 30 мин | Владелец бизнеса через 30 мин |
| **P2 (High)** | Деградация функций: медленная печать (>15с), офлайн-буфер ≥80%, heartbeat потерян >5 мин | ≤ 1 ч | ≤ 4 ч | Каждые 2 ч | Технический лидер через 2ч |
| **P3 (Medium)** | Некритичные проблемы: ошибки импорта, медленные отчёты, DLQ >10 чеков | ≤ 24 ч | ≤ 3 дня | Ежедневно | Нет |

**Контакты on-call:**
- **L1 (первая линия):** __________________ (телефон, telegram)
- **L2 (эскалация):** __________________ (телефон, telegram)
- **Владелец бизнеса:** __________________ (телефон, только P1)
- **Резервный канал:** email (для P2/P3 в нерабочее время)

**Ротация on-call:**
- Недельная ротация (понедельник 09:00 → понедельник 09:00)
- Компенсация: +1 день отпуска за неделю дежурства

## 4.8 Риски внедрения и планы реагирования (обновлено)

| ID | Риск | Вероятность | Влияние | Итоговый приоритет | Меры предосторожности | План реагирования |
|----|------|-------------|---------|-------------------|----------------------|-------------------|
| **R1** | Сложность соответствия 54‑ФЗ при офлайне | Средняя | **Критичное** | **P1** | Ранний POC-4 (длительный офлайн); консультация с ОФД; тестирование на реальном ККТ; изучение статей 54-ФЗ | Резерв 1 неделя на доработку; юридическая консультация; резервный провайдер ОФД |
| **R2** | Недостоверные прайсы от поставщиков | Высокая | Среднее | **P2** | Валидация и превью импорта; профили маппинга; алерты на критичные расхождения (>20% изменение цены) | Блокировка импорта; ручная сверка; контакт с поставщиком |
| **R3** | Ограниченные ресурсы (1 разработчик) | Высокая | Среднее | **P2** | Фокус на MVP; жесткая приоритизация (MoSCoW); использование готовых модулей Odoo; автоматизация тестов | Part-time помощь DevOps/QA; сдвиг сроков непринципиальных фич в post-MVP |
| **R4** | Маркировка | Низкая | Низкое | P3 | Feature flag; параметризация; отложить до продуктива | Включение маркировки постепенно (пилот на 1 товарной группе) |
| **R5** | **Переполнение офлайн-буфера (>200 чеков)** | **Средняя** | **Критичное** | **P1** | Алерт при 80% (160 чеков); блокировка касс при 100%; процедура экстренной синхронизации задокументирована | Ручная синхронизация администратором; резервный канал связи (4G/LTE модем); увеличение ёмкости буфера до 300 (если нужно) |
| **R6** | **Рассинхронизация времени ККТ** | Низкая | Высокое | **P2** | Обязательная NTP-синхронизация; мониторинг drift (алерт >5с); автокоррекция каждые 5 мин | Ручная синхронизация времени; проверка timestamp чеков в буфере; коррекция в ОФД (если поддерживается) |
| **R7** | **ФН заполнен во время офлайна** | Низкая | Критичное | **P1** | Алерт "До конца ФН <100 чеков" (за 3-5 дней); процедура замены ФН с синхронизацией буфера | Экстренная замена ФН (≤4ч); синхронизация буфера на новый ФН; блокировка продаж при переполнении ФН |
| **R8** | **Задержки из-за ККТ-провайдера** | Средняя | Высокое | **P2** | Резервный провайдер/эмулятор для разработки; ранний контакт (T0+1нед); договор SLA | Переключение на резервного провайдера; параллельная разработка с эмулятором |
| **R9** | **Изменение прайсов во время офлайна** | Высокая | Среднее | **P2** | Автоматическое расписание импорта (ночью); блокировка импорта при несинхронизированных буферах; оповещения о расхождениях | Ручная сверка цен после синхронизации; алерт кассирам о новых ценах; откат импорта (если критично) |
| **R10** | **Конфликт остатков (продажа в офлайне + списание в Odoo)** | Средняя | Среднее | **P2** | Приоритет физическим продажам; корректировка остатков post-factum; алерт бухгалтеру | Инвентаризация после синхронизации; корректирующие проводки; процедура разбора конфликтов |
| **R11** | **Падение адаптера ККТ во время критичной транзакции** | Низкая | Высокое | **P2** | Docker restart policy (unless-stopped); health check каждые 30с; SQLite WAL mode (crash-safe); автоматическое восстановление из буфера | Ручная проверка последней транзакции; повтор печати чека (если не напечатан); синхронизация буфера |

**Процедура активации плана реагирования:**
1. Обнаружение риска (мониторинг, алерт, ручной отчёт)
2. Оценка влияния (≤15 мин для P1, ≤1ч для P2)
3. Активация плана (по таблице выше)
4. Документирование в журнале рисков
5. Post-mortem (для P1/P2) с обновлением мер предосторожности

## 4.9 Артефакты на выходе

### Кодовая база
- [ ] Репозиторий с модулями: `optics_core`, `optics_pos_ru54fz`, `connector_b`, `ru_accounting_extras`
- [ ] Адаптер ККТ: `kkt_adapter/` (Python, FastAPI, SQLite)
- [ ] Docker-окружение: `docker-compose.yml`, Dockerfile для всех сервисов
- [ ] CI/CD: GitHub Actions / GitLab CI (pre-commit, unit tests, build)

### Конфигурация
- [ ] `config.toml` (проект Odoo): параметры модулей, features flags
- [ ] `config.toml` (адаптер ККТ): параметры офлайн-буфера, heartbeat, ККТ
- [ ] `config.toml` (codex): правила разработки, линтеры, стандарты
- [ ] `.env.example`: шаблон переменных окружения с описанием
- [ ] `AGENTS.md`: описание ролей и ответственности (если применимо)

### Документация
- [ ] **Док. 1-4** (этот комплект): актуализированные версии с учётом офлайн-режима
- [ ] **Руководство администратора** (≥50 страниц):
  - Установка и настройка
  - Управление офлайн-буферами
  - Процедуры бэкапа/восстановления
  - Мониторинг и алерты
  - Типовые инциденты и решения
- [ ] **Руководство кассира** (≥20 страниц):
  - Работа с POS-интерфейсом
  - Офлайн-режим: индикация, действия при переполнении
  - X/Z-отчёты
  - Типовые проблемы (FAQ)
- [ ] **Runbook** (≥20 сценариев):
  - Переполнение офлайн-буфера
  - Падение адаптера ККТ
  - Ошибка фискализации
  - ФН заполнен
  - Потеря связи с Odoo
  - Конфликт остатков после офлайна
  - Rollback-процедура
  - DR-восстановление
- [ ] **Регламенты**:
  - X/Z-отчёты (для менеджеров)
  - Работа с офлайн-буфером (для администраторов)
  - Процедура экстренной синхронизации
  - SLA инцидентов
  - Change management

### Тестовые артефакты
- [ ] **UAT-протоколы** (11 сценариев): результаты, скриншоты, дефекты
- [ ] **Отчёты POC** (POC-1/2/3/4): метрики, логи, выводы
- [ ] **Отчёты нагрузочных тестов** (сценарии 1-4): метрики, графики, анализ
- [ ] **Чек-листы**:
  - Pre-flight (перед развёртыванием)
  - Smoke-test (после развёртывания)
  - Обучение кассиров (программа + тест)

### Мониторинг и операционные инструменты
- [ ] **Дашборд Grafana** (4+ панели):
  - Статус касс (real-time)
  - Офлайн-буфер
  - Производительность
  - Надёжность
- [ ] **Prometheus alerts**: конфигурация алертов (≥10 правил)
- [ ] **Интеграция с каналами**: email, telegram (настройка + тесты)

### Обучающие материалы
- [ ] **Видео-туториалы** (опционально):
  - Работа кассира в офлайн-режиме (5 мин)
  - Администратор: управление офлайн-буфером (10 мин)
- [ ] **Презентации**:
  - Для кассиров (≥20 слайдов)
  - Для администраторов (≥30 слайдов)
- [ ] **Тесты для кассиров** (≥20 вопросов, проходной балл 80%)

## 4.10 Чек-лист готовности к офлайн-режиму

### Pre-flight (перед каждым развертыванием)

**Инфраструктура:**
- [ ] Офлайн-буфер пуст на всех кассах (или <10 чеков)
- [ ] NTP-синхронизация активна (drift <1с на всех терминалах)
- [ ] Кэш каталога актуален (<1ч давности)
- [ ] Свободное место на диске ≥10GB (для логов и буфера)
- [ ] Docker-образы адаптеров ККТ обновлены до последней стабильной версии
- [ ] Heartbeat к Odoo работает (<30с интервал, 100% касс)

**Безопасность:**
- [ ] Сертификаты mTLS валидны (≥30 дней до истечения)
- [ ] JWT-токены обновлены (TTL 15 мин работает)
- [ ] Whitelist firewall актуален (ОФД, NTP, Odoo)

**Функционал:**
- [ ] Тестовая продажа в **онлайн-режиме** успешна (все кассы)
- [ ] Тестовая продажа в **офлайн-режиме** успешна (минимум 1 касса)
  - Обрыв связи с ОФД (эмуляция)
  - Чек печатается и сохраняется в буфер
  - Восстановление связи → автосинхронизация
- [ ] Алерты срабатывают корректно (тест на стенде):
  - Буфер ≥80% → warning
  - Буфер ≥100% → critical + блокировка
  - Heartbeat потерян >5 мин → warning

**Мониторинг:**
- [ ] Дашборд Grafana доступен и показывает актуальные данные
- [ ] Prometheus exporter работает на всех адаптерах ККТ
- [ ] Интеграция с каналами алертов работает (тестовый алерт отправлен)

**Документация:**
- [ ] Runbook обновлён (актуальная версия на вики)
- [ ] Контакты on-call актуальны (телефоны/telegram проверены)
- [ ] Rollback-процедура задокументирована и понятна

### Post-deployment (smoke-test)

**В течение 30 минут после развёртывания:**
- [ ] Продажа на каждой кассе (100% успех)
- [ ] Проверка офлайн-буферов (статус, размер не вырос)
- [ ] Heartbeat к Odoo восстановлен (все кассы)
- [ ] Мониторинг: нет критичных алертов
- [ ] Метрики:
  - P95 печати чека ≤ 7с
  - Error rate <0.1%
  - Бизнес-доступность 100% (все кассы работают)

**В течение 24 часов после развёртывания:**
- [ ] Нет P1/P2 инцидентов
- [ ] Офлайн-буферы стабильны (размер не растёт неконтролируемо)
- [ ] Throughput синхронизации ≥20 чеков/мин (если были офлайн-периоды)
- [ ] Логи: нет критичных ошибок (ERROR/CRITICAL)

**Критерий Go-Live:**
Все пункты smoke-test выполнены → уведомление владельца бизнеса → разрешение на полную эксплуатацию.

---

## Заключение

Обновлённый план работ учитывает критичность офлайн-режима и включает:
- **+1 неделю на POC** для обязательного POC-4 (длительный офлайн)
- **+1 неделю Buffer** между MVP и Пилотом для стабилизации
- **Нагрузочные тесты** (4 сценария) перед пилотом
- **Детальные регламенты** работы с офлайн-буфером
- **Чек-лист готовности** для каждого развёртывания
- **Rollback-процедуру** с учётом офлайн-буферов

**Итоговые сроки:** T0 → T0+17 недель (вместо 16 недель в оригинале).

**Риски покрыты:** 11 рисков идентифицировано, для каждого есть меры предосторожности и план реагирования.

**Критерии успеха чёткие:** числовые метрики, артефакты, процедуры приёмки с подписями владельцев.# OpticsERP — 4. План работ, сроки, пререквизиты